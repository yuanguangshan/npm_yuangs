"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.registerPlanCommand = registerPlanCommand;
const chalk_1 = __importDefault(require("chalk"));
const ora_1 = __importDefault(require("ora"));
const fs_1 = __importDefault(require("fs"));
const path_1 = __importDefault(require("path"));
const GitService_1 = require("../../core/git/GitService");
const llm_1 = require("../../agent/llm");
const workflows_1 = require("../../core/workflows");
const CapabilityLevel_1 = require("../../core/capability/CapabilityLevel");
const utils_1 = require("./utils");
const DEFAULT_PLAN_PROMPT = 'åˆ†æé¡¹ç›®ç°çŠ¶å¹¶è§„åˆ’ä¸‹ä¸€æ­¥å¼€å‘ä»»åŠ¡';
const METADATA_PREFIX = '>';
async function resolveUserPrompt(cliPrompt, todoPath) {
    if (cliPrompt) {
        return { prompt: cliPrompt, fromFile: false };
    }
    try {
        await fs_1.default.promises.access(todoPath, fs_1.default.constants.F_OK);
        const content = await fs_1.default.promises.readFile(todoPath, 'utf8');
        const lines = content.split('\n');
        let startIndex = 0;
        while (startIndex < lines.length && lines[startIndex].trim().startsWith(METADATA_PREFIX)) {
            startIndex++;
        }
        while (startIndex < lines.length && lines[startIndex].trim() === '') {
            startIndex++;
        }
        const filePrompt = lines.slice(startIndex).join('\n').trim();
        if (filePrompt) {
            return { prompt: filePrompt, fromFile: true };
        }
    }
    catch (e) {
        if (e instanceof Error && e.code !== 'ENOENT') {
            console.warn(chalk_1.default.yellow(`âš ï¸  è¯»å– todo.md å¤±è´¥: ${e.message}`));
        }
    }
    return { prompt: DEFAULT_PLAN_PROMPT, fromFile: false };
}
function registerPlanCommand(gitCmd) {
    gitCmd
        .command('plan [prompt...]')
        .description('è‡ªåŠ¨è¯»å–æœ€è¿‘ 10 æ¬¡æäº¤ï¼Œç”±ä¸¤ä¸ª AI (æ¶æ„å¸ˆ & å®¡æŸ¥å‘˜) åä½œç”Ÿæˆ todo.md')
        .option('-r, --rounds <number>', 'å¯¹è¯è½®æ•°', '2')
        .option('-m, --model <model>', 'æ¶æ„å¸ˆæ¨¡å‹', 'Assistant')
        .option('--reviewer-model <model>', 'å®¡æŸ¥å‘˜æ¨¡å‹', 'gemini-2.5-flash-lite')
        .action(async (promptParts, options) => {
        const cliPrompt = promptParts.join(' ').trim();
        const maxRounds = parseInt(options.rounds) || 2;
        const todoPath = path_1.default.join(process.cwd(), 'todo.md');
        const { prompt: userPrompt, fromFile } = await resolveUserPrompt(cliPrompt, todoPath);
        const spinner = (0, ora_1.default)(fromFile ? 'æ­£åœ¨ä» todo.md è¯»å–å¹¶åˆå§‹åŒ–åˆ†æè§„åˆ’...' : 'æ­£åœ¨åˆå§‹åŒ–åˆ†æè§„åˆ’...').start();
        try {
            const gitService = new GitService_1.GitService();
            if (!(await gitService.isGitRepository())) {
                spinner.fail('å½“å‰ç›®å½•ä¸æ˜¯ Git ä»“åº“');
                return;
            }
            spinner.succeed('Git ä»“åº“éªŒè¯é€šè¿‡');
            const workflowConfig = {
                sessionId: Date.now().toString(36) + Math.random().toString(36).substring(2, 11),
                model: options.model || 'Assistant',
                capability: CapabilityLevel_1.CapabilityLevel.SEMANTIC
            };
            const session = new workflows_1.GitWorkflowSession(workflowConfig);
            const planWorkflow = new workflows_1.PlanWorkflow(gitService);
            console.log(chalk_1.default.bold.cyan('\nğŸš€ å¯åŠ¨å·¥ä½œæµä¼šè¯...\n'));
            spinner.start('[å·¥ä½œæµ] æ­£åœ¨æ‰§è¡Œè®¡åˆ’é˜¶æ®µ...');
            const result = await session.runPlan(async (input) => planWorkflow.run(input, session.getConfig()), {
                userPrompt,
                maxRounds,
                architectModel: options.model,
                reviewerModel: options.reviewerModel
            });
            if (result.success && result.data) {
                spinner.succeed('è®¡åˆ’æ‰§è¡ŒæˆåŠŸ');
                const filePath = path_1.default.join(process.cwd(), 'todo.md');
                const metadataLines = [
                    `> ğŸ“… Generated by Yuangs Git Plan at ${new Date().toLocaleString()}`,
                    `> ğŸ¯ Context: ${userPrompt}`,
                    `> ğŸ”§ Capability Level: ${(0, utils_1.getCapabilityLevelDisplay)(result.data.capability.minCapability)}`,
                    `> âš™ï¸  Estimated Time: ${result.data.estimatedTime}ms`,
                    `> ğŸ“Š Estimated Tokens: ${result.data.estimatedTokens}`,
                    '',
                ];
                const fileOutput = metadataLines.join('\n') + result.data.todoMarkdown;
                fs_1.default.writeFileSync(filePath, fileOutput);
                console.log('');
                console.log(chalk_1.default.green(`âœ… è§„åˆ’å®Œæˆï¼æ–‡ä»¶å·²ç”Ÿæˆ: ${chalk_1.default.bold('todo.md')}`));
                console.log(chalk_1.default.gray(`ğŸ‘‰ ä½ å¯ä»¥ä½¿ç”¨ 'code todo.md' æ‰“å¼€æŸ¥çœ‹`));
                console.log('');
                console.log(chalk_1.default.bold.cyan('ğŸ“Š ä¼šè¯æ‘˜è¦:'));
                console.log(chalk_1.default.gray(session.getSummary()));
                session.complete();
            }
            else {
                spinner.fail('è®¡åˆ’æ‰§è¡Œå¤±è´¥');
                if (result.errors && result.errors.length > 0) {
                    console.log('');
                    console.log(chalk_1.default.bold.red('âŒ é”™è¯¯è¯¦æƒ…:'));
                    result.errors.forEach((error, index) => {
                        console.log(chalk_1.default.red(`  ${index + 1}. [${error.kind}] ${error.message}`));
                        if (error.suggestions && error.suggestions.length > 0) {
                            error.suggestions.forEach(suggestion => {
                                console.log(chalk_1.default.yellow(`     ğŸ’¡ ${suggestion}`));
                            });
                        }
                    });
                }
                if (result.summary) {
                    console.log('');
                    console.log(chalk_1.default.gray(`ğŸ“ ${result.summary}`));
                }
            }
        }
        catch (error) {
            spinner.fail(chalk_1.default.red(`æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºé”™: ${error.message}`));
            if (error instanceof llm_1.AIError) {
                console.error(chalk_1.default.red(`Status: ${error.statusCode}`));
            }
            process.exit(1);
        }
    });
}
//# sourceMappingURL=plan.js.map