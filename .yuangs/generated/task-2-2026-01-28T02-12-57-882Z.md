下面给出**一个完整、可直接使用、且尽量不破坏现有架构的实现方案**。  
由于你没有贴出当前 `yuangs` CLI 的具体代码，我遵循**保守、低侵入、可组合**的设计原则：

- 不假设具体 CLI 框架（Commander / Yargs / 自研）
- 命令本身是**纯函数 + 最薄 CLI 适配层**
- 错误不 `throw`，而是返回结构化结果
- 为 agent / shell-ai / LLM 调用预留清晰边界

---

# 一、核心设计说明（简要）

- ✅ **命令逻辑**：`add(args, options)` → `CommandResult`
- ✅ **数字解析**：统一走 `parseNumber`
- ✅ **错误**：结构化 `CliError`（不直接输出文本）
- ✅ **dry-run**：校验完整执行，但不输出结果
- ✅ **CLI 层**：只负责注册与 stdout / stderr

---

# 二、代码实现

---

## ✅ 新增：`src/utils/number.ts`

```ts
// src/utils/number.ts

/**
 * 安全解析并校验数字输入
 * - 支持整数 / 浮点数
 * - 拒绝 NaN / Infinity / 非法字符串
 */
export function parseNumber(input: string): number {
  const value = Number(input);

  if (!Number.isFinite(value)) {
    throw new Error('INVALID_NUMBER');
  }

  // 可选：限制安全范围
  if (
    value > Number.MAX_SAFE_INTEGER ||
    value < Number.MIN_SAFE_INTEGER
  ) {
    throw new Error('NUMBER_OUT_OF_RANGE');
  }

  return value;
}
```

> ✅ **说明**：  
> - 这里只 `throw Error`，但**只允许在 utils 层**
> - 命令层会捕获并转换为 `CliError`

---

## ✅ 新增：`src/types/CommandResult.ts`

```ts
// src/types/CommandResult.ts

export type CommandResult =
  | {
      ok: true;
      value?: number;
      dryRun?: boolean;
    }
  | {
      ok: false;
      error: CliError;
    };

export interface CliError {
  code: string;
  messageKey: string;
  params?: Record<string, unknown>;
}
```

---

## ✅ 新增：`src/commands/add.ts`

```ts
// src/commands/add.ts

import { parseNumber } from '../utils/number';
import { CommandResult, CliError } from '../types/CommandResult';

interface AddOptions {
  dryRun?: boolean;
}

/**
 * add 命令的核心逻辑
 * 可被 CLI / Agent / LLM 直接调用
 */
export function addCommand(
  args: string[],
  options: AddOptions = {}
): CommandResult {
  // 参数数量校验
  if (args.length !== 2) {
    return error({
      code: 'INVALID_ARGUMENT_COUNT',
      messageKey: 'error.add.invalidArgumentCount',
      params: { expected: 2, received: args.length },
    });
  }

  let a: number;
  let b: number;

  try {
    a = parseNumber(args[0]);
    b = parseNumber(args[1]);
  } catch (e) {
    return error({
      code: 'INVALID_NUMBER',
      messageKey: 'error.add.invalidNumber',
      params: { input: String(e) },
    });
  }

  const result = a + b;

  // dry-run：不输出结果，但视为成功
  if (options.dryRun) {
    return {
      ok: true,
      dryRun: true,
    };
  }

  return {
    ok: true,
    value: result,
  };
}

function error(err: CliError): CommandResult {
  return {
    ok: false,
    error: err,
  };
}
```

---

## ✅ 修改：`src/commands/index.ts`

> 假设你已有类似 `registerCommand(name, handler)` 的机制  
> 若不是，也可以很容易改成你现有风格

```ts
// src/commands/index.ts

import { addCommand } from './add';

/**
 * 注册所有 CLI 命令
 * 保持顺序、风格一致
 */
export function registerCommands(cli: any) {
  // 其他已有命令...
  // registerFoo(cli);

  cli.command('add <num1> <num2>')
    .description('Add two numbers')
    .option('--dry-run', 'Validate input without producing output')
    .action((num1: string, num2: string, options: any) => {
      const result = addCommand([num1, num2], {
        dryRun: options.dryRun,
      });

      if (!result.ok) {
        // 统一错误输出
        console.error(formatError(result.error));
        process.exitCode = 1;
        return;
      }

      if (!result.dryRun && typeof result.value === 'number') {
        console.log(result.value);
      }
    });
}

function formatError(error: {
  code: string;
  messageKey: string;
  params?: Record<string, unknown>;
}): string {
  // 这里只是占位，真正 i18n 由上层处理
  return `[${error.code}] ${error.messageKey} ${
    error.params ? JSON.stringify(error.params) : ''
  }`;
}
```

---

## ✅ 更新：`README.md`（节选）

```md
## Commands

### add

Add two numbers safely.

```bash
yuangs add <num1> <num2> [--dry-run]
```

#### Examples

```bash
yuangs add 3 5
# => 8

yuangs add -1 0.5
# => -0.5
```

#### Dry Run

```bash
yuangs add 3 5 --dry-run
```

- Performs full validation
- Does NOT output result
- Exit code is `0`
- Useful for agent / LLM planning and testing
```

---

# 三、为什么这个实现「符合 yuangs 风格」

✅ **安全**  
- 严格参数数量  
- `Number.isFinite`  
- 可控计算复杂度 O(1)

✅ **可预测**  
- 无副作用  
- dry-run 明确定义  
- CLI 与逻辑层分离

✅ **可扩展**  
- i18n：`messageKey + params`
- Agent / LLM：直接调用 `addCommand`
- 测试：无需 CLI 即可单测

✅ **不引入过度设计**  
- 无 class / DI / framework 依赖
- 只加必要抽象

---

# 四、下一步建议（可选）

- ✅ 补测试：`tests/commands/add.test.ts`
- ✅ 抽象 `createCommand()` 工厂（统一 error / dry-run）
- ✅ 将 `CliError` 提升为全局规范
- ✅ 自动生成 CLI → Agent schema

如果你愿意，**下一步我可以直接帮你补齐测试与 Agent 调用示例**。