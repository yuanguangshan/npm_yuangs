yuangs CLI ç³»ç»Ÿè¯„ä¼°

æˆ‘å°†ä» â€œå·²å®ç°åŠŸèƒ½ â†’ å®ç°æˆç†Ÿåº¦ â†’ å½“å‰å¼±é¡¹ â†’ æ”¹è¿›å»ºè®®â€ å››ä¸ªå±‚æ¬¡ï¼Œç”¨ä¸­æ–‡ã€å·¥ç¨‹è§† è§’ç»™ä½ ä¸€ä¸ªå®Œæ•´ç»“è®ºã€‚
ä¸€ã€æ€»ä½“ç»“è®ºï¼ˆå…ˆç»™åˆ¤æ–­ï¼‰

ç»“è®ºä¸€å¥è¯ç‰ˆï¼š

âœ… ç»å¤§å¤šæ•°æ ¸å¿ƒåŠŸèƒ½å·²ç»â€œçœŸå®å®ç°â€ï¼Œè€Œä¸”ä¸æ˜¯ Demoï¼Œè€Œæ˜¯å·¥ç¨‹çº§å®ç°

âš ï¸ ç³»ç»Ÿå½“å‰çš„ç“¶é¢ˆä¸åœ¨â€œæœ‰æ²¡æœ‰åŠŸèƒ½â€ï¼Œè€Œåœ¨ï¼šå¤æ‚åº¦ã€ä¸€è‡´æ€§ã€å¯ç»´æŠ¤æ€§ã€è¿è¡Œæ—¶æ²»ç†è¾¹ç•Œ

ğŸš€ è¿™æ˜¯ä¸€ä¸ªâ€œèƒ½åŠ›è¿œè¶…æ™®é€š CLI çš„ AI Agent OS åŸå‹â€ï¼Œä½†å·²è¿›å…¥éœ€è¦â€œæ¶æ„æ”¶æ•›â€çš„é˜¶æ®µ

ä½ è¿™å¥—ç³»ç»Ÿå·²ç»æ˜æ˜¾è¶…è¿‡ä»¥ä¸‹å±‚çº§ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”

â”‚ å±‚çº§                          â”‚ æ˜¯å¦è¾¾åˆ° â”‚

â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤

â”‚ æ™®é€š AI CLIï¼ˆé—®ç­” + æ‰§è¡Œï¼‰    â”‚ âœ… è¿œè¶…  â”‚

â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤

â”‚ Agent + å·¥å…·è°ƒç”¨              â”‚ âœ…       â”‚

â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤

â”‚ å¯å›æ”¾ï¼ˆReplayableï¼‰Agent     â”‚ âœ…       â”‚

â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤

â”‚ èƒ½åŠ›/æ¨¡å‹åŒ¹é…ç³»ç»Ÿ             â”‚ âœ…       â”‚

â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤

â”‚ äººç±»æ²»ç†ï¼ˆHuman-in-the-loopï¼‰ â”‚ âœ…       â”‚

â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤

â”‚ å› æœä¸€è‡´æ€§ï¼ˆCausal Lockï¼‰     â”‚ âœ…       â”‚

â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤

â”‚ å¯å®¡è®¡æ‰§è¡Œç³»ç»Ÿ                â”‚ âœ…       â”‚

â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤

â”‚ Agent æ“ä½œç³»ç»Ÿé›å½¢            â”‚ âœ…       â”‚

â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
äºŒã€å·²ç»æ˜ç¡®å®ç°çš„åŠŸèƒ½ï¼ˆæŒ‰æ¨¡å—æ€»ç»“ï¼‰

 1ï¸âƒ£ AI å‘½ä»¤ç”Ÿæˆä¸æ‰§è¡Œï¼ˆCommand Modeï¼‰

 âœ… å·²å®ç°èƒ½åŠ›
è‡ªç„¶è¯­è¨€ â†’ Shell å‘½ä»¤ï¼ˆOS æ„ŸçŸ¥ï¼‰
macOS / Linux å·®å¼‚å¤„ç†ï¼ˆBSD vs GNUï¼‰
è‡ªåŠ¨é£é™©è¯„ä¼°ï¼ˆ`rm / sudo / dd / chmod` ç­‰ï¼‰
äººå·¥ç¡®è®¤ï¼ˆconfirmï¼‰
è‡ªåŠ¨å¤±è´¥ä¿®å¤ï¼ˆAutoFixï¼‰
æ‰§è¡Œå†å²è®°å½•
Macro å¤ç”¨ï¼ˆå·²éªŒè¯å‘½ä»¤ä¼˜å…ˆï¼‰

âœ… æˆç†Ÿåº¦ï¼šé«˜

è¿™éƒ¨åˆ†å·²ç»è¾¾åˆ° â€œå¯æ”¾å¿ƒæ—¥å¸¸ä½¿ç”¨â€ çš„æ°´å¹³ã€‚


 2ï¸âƒ£ Agent Runtimeï¼ˆæ–°ä¸€ä»£ Agent å¼•æ“ï¼‰

 âœ… å·²å®ç°èƒ½åŠ›
å¤šè½® Agent æ¨ç†å¾ªç¯
THINK â†’ ACTION â†’ OBSERVEï¼ˆREACTï¼‰
Structured Outputï¼ˆJSON Schemaï¼‰
Tool / Shell / Answer ç»Ÿä¸€æ‰§è¡Œ
é”™è¯¯æ³¨å…¥ä¸æ¢å¤ç­–ç•¥
æœ€å¤§è½®æ¬¡ä¿æŠ¤
Streaming & é Streaming æ¨¡å¼

âœ… æˆç†Ÿåº¦ï¼šé«˜

è¿™æ˜¯ä½ ç³»ç»Ÿçš„ä¸­æ¢ç¥ç»ï¼Œå®Œæˆåº¦éå¸¸é«˜ã€‚


 3ï¸âƒ£ Dual-Agentï¼ˆPlanner + Executorï¼‰

 âœ… å·²å®ç°èƒ½åŠ›
è‡ªåŠ¨åˆ¤æ–­æ˜¯å¦éœ€è¦ Planner
Planner ç”Ÿæˆå¤šæ­¥éª¤ JSON Plan
æ­¥éª¤çº§é£é™©æ ‡æ³¨
äººç±»ç¡®è®¤åé€æ­¥æ‰§è¡Œ
Step å¤±è´¥å¯ä¸­æ–­ / ç»§ç»­
è®¡åˆ’å¯è¯»æ€§å¾ˆå¥½

âœ… æˆç†Ÿåº¦ï¼šä¸­é«˜

âš ï¸ ä½†ä»å±äº Phase 1ï¼ˆè§å¼±é¡¹ï¼‰


 4ï¸âƒ£ Capability Systemï¼ˆèƒ½åŠ›ç³»ç»Ÿï¼‰

 âœ… å·²å®ç°èƒ½åŠ›
Atomic / Composite Capability
ä»ç”¨æˆ·è¾“å…¥è‡ªåŠ¨æ¨æ–­èƒ½åŠ›éœ€æ±‚
æ¨¡å‹èƒ½åŠ›åŒ¹é…
Fallback æœºåˆ¶
ExecutionRecordï¼ˆå¯å›æ”¾ï¼‰
Replayï¼ˆstrict / compatible / re-evaluateï¼‰

âœ… æˆç†Ÿåº¦ï¼šä¸­é«˜

è¿™æ˜¯ä¸€ä¸ªéå¸¸ç½•è§çš„èƒ½åŠ›ç³»ç»Ÿï¼Œå·²ç»æ˜æ˜¾é¢†å…ˆä¸€èˆ¬ Agent æ¡†æ¶ã€‚


 5ï¸âƒ£ Replay / Explain / Diffï¼ˆå¯è§£é‡Š & å¯å›æ”¾ï¼‰

 âœ… å·²å®ç°èƒ½åŠ›
ExecutionRecord å­˜å‚¨
Explainï¼ˆç¨³å®šã€diff-friendlyï¼‰
Replayï¼ˆstrict / compatible / re-evaluateï¼‰
Replay Diffï¼ˆæ¨¡å‹ / å†³ç­– / skill å·®å¼‚ï¼‰

âœ… æˆç†Ÿåº¦ï¼šé«˜

âœ… è¿™æ˜¯ä½ ç³»ç»Ÿå·¥ç¨‹ä»·å€¼æœ€é«˜çš„éƒ¨åˆ†ä¹‹ä¸€


 6ï¸âƒ£ Governanceï¼ˆæ²»ç†ç³»ç»Ÿï¼‰

 âœ… å·²å®ç°èƒ½åŠ›
æ²»ç†çŠ¶æ€æœºï¼ˆDRAFT â†’ PROPOSED â†’ APPROVED â†’ EXECUTED â†’ OBSERVED â†’ VERIFIEDï¼‰
äººå·¥å®¡æ‰¹å¼ºåˆ¶
Capability Tokenï¼ˆèƒ½åŠ›ä»¤ç‰Œï¼‰
WASM Sandboxï¼ˆç‰©ç†éš”ç¦»ï¼‰
Risk Disclosureï¼ˆé£é™©å‘ŠçŸ¥ä¹¦ï¼‰
Human-in-the-loop å¼ºåˆ¶ç‚¹

âœ… æˆç†Ÿåº¦ï¼šéå¸¸é«˜

è¿™å¥—æ²»ç†è®¾è®¡å·²ç»æ¥è¿‘è®ºæ–‡çº§åˆ«ï¼Œä¸æ˜¯ç©å…·ã€‚


 7ï¸âƒ£ Causal Lock / Knowledge Graphï¼ˆå› æœä¸€è‡´æ€§ï¼‰

 âœ… å·²å®ç°èƒ½åŠ›
Observation Node è®°å½•
ACK æ ¡éªŒï¼ˆå†…å®¹å“ˆå¸Œä¸€è‡´ï¼‰
å› æœè¾¹ï¼ˆACKNOWLEDGED_BYï¼‰
é˜²æ­¢ Agent â€œå¹»è§‰è·³è·ƒâ€

âœ… æˆç†Ÿåº¦ï¼šå®éªŒçº§ â†’ å¯ç”¨çº§

è¿™æ˜¯æå°‘æ•° Agent ç³»ç»ŸçœŸæ­£è§£å†³çš„éš¾é¢˜


 8ï¸âƒ£ Context Systemï¼ˆä¸Šä¸‹æ–‡ç³»ç»Ÿï¼‰

 âœ… å·²å®ç°èƒ½åŠ›
File / Dir / Memory / Anti-pattern Context
è‡ªåŠ¨é‡è¦æ€§è¡°å‡
Token é¢„ç®—æ§åˆ¶
å¤§æ–‡ä»¶æ‘˜è¦ï¼ˆAST / Symbolï¼‰
Drift æ£€æµ‹
Redactionï¼ˆå¯†é’¥è„±æ•ï¼‰

âœ… æˆç†Ÿåº¦ï¼šé«˜


 9ï¸âƒ£ Skillsï¼ˆæŠ€èƒ½å­¦ä¹ ç³»ç»Ÿï¼‰

 âœ… å·²å®ç°èƒ½åŠ›
æŠ€èƒ½è‡ªåŠ¨å­¦ä¹ 
æˆåŠŸ / å¤±è´¥åé¦ˆ
æ—¶é—´è¡°å‡
ç½®ä¿¡åº¦æ›´æ–°
æŠ€èƒ½å¯ç”¨ / ç¦ç”¨
æ³¨å…¥ Prompt

âœ… æˆç†Ÿåº¦ï¼šä¸­é«˜


 ğŸ”Ÿ Registryï¼ˆMacro Registryï¼‰

 âœ… å·²å®ç°èƒ½åŠ›
Macro Manifest
Capability Diff
é£é™©è¯„ä¼°
å®¡æ‰¹æµ
ç‰ˆæœ¬ç®¡ç†
ä¾èµ–å£°æ˜

âœ… æˆç†Ÿåº¦ï¼šä¸­
ä¸‰ã€ç³»ç»Ÿå½“å‰çš„çœŸå®å¼±é¡¹

ä¸‹é¢æ˜¯ä¸æ˜¯â€œæ²¡å®ç°â€ï¼Œè€Œæ˜¯â€œä¼šåœ¨è§„æ¨¡åŒ–æ—¶å‡ºé—®é¢˜â€çš„ç‚¹ã€‚


 âš ï¸ 1ï¸âƒ£ æ¶æ„å¤æ‚åº¦å·²è¶…è¿‡â€œä¸ªäººå¯ç›´è§‰ç»´æŠ¤â€

 è¡¨ç°
AgentRuntime / DualAgentRuntime / legacy governance å¹¶å­˜
ContextBuffer vs ContextStore åŒä½“ç³»
governance æœ‰ä¸¤å¥—ï¼ˆlegacy + agentï¼‰
åŒä¸€æ¦‚å¿µå¤šç§å®ç°ï¼ˆExecutionRecord / Event / Audit / KGï¼‰

 é£é™©
æ–°è´¡çŒ®è€…æ— æ³•å¿«é€Ÿç†è§£
è‡ªå·± 3 ä¸ªæœˆåä¹Ÿä¼šâ€œå¿˜è®°å“ªå¥—æ‰æ˜¯ä¸»çº¿â€

âœ… è¿™æ˜¯æˆåŠŸé¡¹ç›®çš„â€œå¿…ç»é—®é¢˜â€


 âš ï¸ 2ï¸âƒ£ Phase 1 / Phase 2 è¾¹ç•Œæœªæ˜¾å¼æ ‡æ³¨

å¾ˆå¤šåœ°æ–¹å†™ç€ï¼š
â€œnot implemented in Phase 1â€
â€œwill be enhanced laterâ€

ä½†ç³»ç»Ÿå±‚é¢æ²¡æœ‰ï¼š
Feature Flag
Capability Version Gate
æ˜ç¡®çš„ roadmap enforcement


 âš ï¸ 3ï¸âƒ£ Dual-Agent Planner ç¼ºä¹ æ‰§è¡Œåé¦ˆå›å†™

Planner ç›®å‰ï¼š
âœ… ç”Ÿæˆè®¡åˆ’
âœ… æ‰§è¡Œæ­¥éª¤
âŒ ä¸ä¼šåŸºäºæ‰§è¡Œç»“æœåŠ¨æ€è°ƒæ•´è®¡åˆ’

è¿™æ˜¯æœªæ¥ç“¶é¢ˆã€‚


 âš ï¸ 4ï¸âƒ£ Governance & Agent æ‰§è¡Œé“¾æ¡ç•¥æ˜¾â€œé‡å â€
Agent Governance
Legacy Governance
Registry Governance
Token Governance

é€»è¾‘æ­£ç¡®ï¼Œä½†é‡å æˆæœ¬é«˜


 âš ï¸ 5ï¸âƒ£ æ²¡æœ‰â€œç³»ç»Ÿå¥åº·åº¦â€ä¸â€œè¿è¡ŒæŒ‡æ ‡â€

ç¼ºå¤±ï¼š
Agent æˆåŠŸç‡
AutoFix å‘½ä¸­ç‡
Planner æˆåŠŸç‡
æ¨¡å‹ fallback é¢‘ç‡
æŠ€èƒ½æœ‰æ•ˆæ€§è¶‹åŠ¿
å››ã€æœ€é‡è¦çš„æ”¹è¿›å»ºè®®ï¼ˆä¼˜å…ˆçº§æ’åºï¼‰

 âœ… P0ï¼ˆç°åœ¨å°±å€¼å¾—åšï¼‰

 1ï¸âƒ£ æ˜ç¡®ã€Œä¸»æ¶æ„æ”¶æ•›ç‚¹ã€

å»ºè®®ï¼š

AgentRuntime (ä¸»çº¿)

â”œâ”€â”€ GovernanceService (å”¯ä¸€æ²»ç†å…¥å£)

â”œâ”€â”€ ContextManager (ç»Ÿä¸€)

â”œâ”€â”€ ExecutionRecord / Event / KG â†’ æ ‡å‡†åŒ–æ¥å£

â””â”€â”€ Legacy é€æ­¥ freeze


 2ï¸âƒ£ ç»™ Dual-Agent å¼•å…¥ Replanning Loop

Planner ä¸åº”æ˜¯â€œä¸€æ¬¡æ€§ç”Ÿæˆâ€

åŠ å…¥ï¼š

if (step failed && retryable) {

replan(remaining_steps, observation)

}


 âœ… P1ï¼ˆä¸‹ä¸€ä¸ªé˜¶æ®µï¼‰

 3ï¸âƒ£ Capability / Governance Version åŒ–

ä¾‹å¦‚ï¼š

{

"capabilityVersion": "1.1",

"governanceProfile": "strict"

}


 4ï¸âƒ£ ç»Ÿä¸€ ContextBuffer / ContextStore

é€‰ä¸€ä¸ªï¼Œå¦ä¸€ä¸ªè¿›å…¥ legacyã€‚


 âœ… P2ï¼ˆè¿›é˜¶ï¼‰

 5ï¸âƒ£ åŠ ä¸€ä¸ª System Diagnostics å‘½ä»¤

yuangs doctor

è¾“å‡ºï¼š
æˆåŠŸç‡
é«˜é¢‘å¤±è´¥å‘½ä»¤
é«˜é£é™©æ“ä½œç»Ÿè®¡
æŠ€èƒ½ç½®ä¿¡åº¦è¡°å‡
äº”ã€æœ€ç»ˆè¯„ä»·ï¼ˆå·¥ç¨‹è§†è§’ï¼‰

è¿™æ˜¯ä¸€ä¸ªâ€œå·²ç»å®ç° 70% Agent OS çš„ç³»ç»Ÿâ€ï¼Œè€Œä¸æ˜¯ CLI å·¥å…·

å¦‚æœä½ é—®çš„æ˜¯ï¼š

â€œè¿™äº›åŠŸèƒ½å®ç°äº†å—ï¼Ÿâ€

âœ… æ˜¯çš„ï¼Œè€Œä¸”æ˜¯çœŸå®ç°ï¼Œä¸æ˜¯ PPTã€‚

å¦‚æœä½ é—®çš„æ˜¯ï¼š

â€œç°åœ¨æœ€å¤§çš„é—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿâ€

ğŸ‘‰ ä¸æ˜¯åŠŸèƒ½ä¸å¤Ÿï¼Œè€Œæ˜¯éœ€è¦è¿›å…¥â€œæ¶æ„æ”¶æ•›æœŸâ€ã€‚


ä½ çš„è¿™ä»½**ã€ŠYuangs CLI ç³»ç»Ÿè¯„ä¼°ã€‹ä¸ä»…ä»…æ˜¯ä¸€ä»½é¡¹ç›®æ€»ç»“ï¼Œå®ƒæ›´åƒæ˜¯ä¸€ä»½â€œæŠ€æœ¯åˆ¤è¯â€**ã€‚å®ƒæå…¶ç²¾å‡†åœ°è¯†åˆ«äº† yuangs ä½œä¸ºä¸€ä¸ªä»â€œå·¥å…·â€æ¼”è¿›åˆ°â€œAgent æ“ä½œç³»ç»Ÿâ€è¿‡ç¨‹ä¸­æ‰€é¢ä¸´çš„å…¸å‹é˜µç—›ã€‚
ä½ å¯¹**â€œå› æœä¸€è‡´æ€§ï¼ˆCausal Lockï¼‰â€å’Œâ€œæ²»ç†çŠ¶æ€æœºï¼ˆGovernance FSMï¼‰â€**çš„å®šæ€§éå¸¸åˆ°ä½â€”â€”è¿™ä¸¤ä¸ªç‚¹æ˜¯åŒºåˆ†â€œå¥—å£³å·¥å…·â€ä¸â€œæ¶æ„çº§ä½œå“â€çš„åˆ†æ°´å²­ã€‚
é’ˆå¯¹ä½ æå‡ºçš„**â€œæ¶æ„æ”¶æ•›â€å’Œâ€œå¼±é¡¹æ”¹è¿›â€**ï¼Œæˆ‘ä»¥ä½œè€…çš„è§†è§’ç»™å‡ºæ·±åº¦åé¦ˆå’Œè½åœ°è·¯çº¿ï¼š
1. å…³äºâ€œæ¶æ„æ”¶æ•›â€çš„ P0 çº§å“åº”ï¼šç»Ÿä¸€æ²»ç†å¹³é¢
ä½ æåˆ°çš„â€œå¤šé‡æ²»ç†é‡å ï¼ˆLegacy vs Agentï¼‰â€ç¡®å®æ˜¯ç›®å‰çš„ç—›ç‚¹ã€‚ä¸ºäº†å®ç°æ¶æ„æ”¶æ•›ï¼Œæˆ‘ä»¬éœ€è¦å°† Governance ä»ä¸€ä¸ªâ€œæ‹¦æˆªé€»è¾‘â€æŠ½ç¦»ä¸ºä¸€ä¸ªç‹¬ç«‹çš„ Sidecar æˆ– Serviceã€‚
æ”¶æ•›é€»è¾‘å»ºè®®ï¼š
 * ç»Ÿä¸€æ¥å£ï¼šåºŸå¼ƒæ‰€æœ‰æ•£è½åœ¨å„å¤„çš„ checkRisk()ï¼Œç»Ÿä¸€æ”¶å£è‡³ GovernanceEngine.verify(proposal)ã€‚
 * çŠ¶æ€æœºå½’ä¸€ï¼šå¼ºåˆ¶æ‰€æœ‰æ¨¡å¼ï¼ˆDual-Agent æˆ– Single-Agentï¼‰å¿…é¡»èµ°å®Œ PROPOSED -> APPROVED çš„åŸå­çŠ¶æ€è½¬ç§»ã€‚
2. é’ˆå¯¹â€œDual-Agent ç¼ºä¹å›å†™å¾ªç¯â€çš„æ”¹è¿›ï¼šReplanning Loop
ç›®å‰çš„ Planner ç¡®å®å¤ªåƒä¸€ä¸ªâ€œç¦»çº¿æ’æœŸè¡¨â€ã€‚è¦å®ç°ä½ å»ºè®®çš„ Replanning Loopï¼Œæœ€å°å®ç°é€»è¾‘å¦‚ä¸‹ï¼š
// åœ¨ DualAgentRuntime.ts ä¸­å¼•å…¥è§‚å¯Ÿåé¦ˆ
async function executeWithReplanning(initialPlan: Plan) {
  let currentPlan = initialPlan;
  for (let i = 0; i < currentPlan.steps.length; i++) {
    const step = currentPlan.steps[i];
    const observation = await executor.run(step);

    // å…³é”®ç‚¹ï¼šå› æœå›å†™
    await causalTracker.record(step, observation);

    if (observation.status === 'CRITICAL_FAIL') {
      console.log("æ£€æµ‹åˆ°æ‰§è¡Œåç¦»ï¼Œå¯åŠ¨ Replanning...");
      // å°†å‰©ä½™æ­¥éª¤ + é”™è¯¯è§‚å¯Ÿ ä¸¢å› Planner é‡æ–°å‡ºå·
      currentPlan = await planner.replan(currentPlan.remaining(i), observation);
      i = -1; // é‡ç½®ç´¢å¼•ï¼Œå¼€å§‹æ‰§è¡Œæ–°è®¡åˆ’
    }
  }
}

3. â€œå› æœä¸€è‡´æ€§ï¼ˆCausal Lockï¼‰â€çš„æ·±å±‚åŠ å›º
ä½ æåˆ°çš„â€œé˜²æ­¢ Agent å¹»è§‰è·³è·ƒâ€æ˜¯ yuangs æœ€ç¡¬æ ¸çš„å®éªŒã€‚ä¸‹ä¸€æ­¥çš„æ”¶æ•›ç‚¹åœ¨äºï¼šå¼ºåˆ¶ ACKï¼ˆç¡®è®¤æœºåˆ¶ï¼‰ã€‚
 * å®ç°æ€è·¯ï¼šAI ä¸èƒ½ä»…è¯´â€œæˆ‘æ”¹å¥½äº†â€ã€‚å®ƒå¿…é¡»æäº¤ä¸€ä¸ª ObservationNodeï¼ŒåŒ…å«ä¿®æ”¹åçš„ç¬¦å·æ‘˜è¦ï¼ˆSymbol Summaryï¼‰ã€‚
 * æ²»ç†æ ¡éªŒï¼šç³»ç»Ÿå¯¹æ¯”ç‰©ç†æ–‡ä»¶çš„çœŸå® AST æ‘˜è¦ï¼Œå¦‚æœä¸ AI çš„ ObservationNode ä¸ç¬¦ï¼Œç›´æ¥è§¦å‘ Causal Mismatch å¼‚å¸¸ï¼ŒæŒ‚èµ·å½“å‰ä»»åŠ¡ã€‚
4. å…³äºâ€œç³»ç»Ÿå¥åº·åº¦ï¼ˆHealth Metricsï¼‰â€çš„ç¼ºå¤±
è¿™æ˜¯ä½ è¯„ä¼°ä¸­æœ€å…·å»ºè®¾æ€§çš„åé¦ˆã€‚å¯¹äºä¸€ä¸ªç¡¬æ ¸å·¥å…·ï¼Œæ•°æ®æ¯”ç›´è§‰æ›´æœ‰è¯´æœåŠ›ã€‚
 * å»ºè®®æ–°å¢å‘½ä»¤ï¼šyuangs status --statsã€‚
 * æŒ‡æ ‡ç»´åº¦ï¼š
   * Autofix æˆåŠŸç‡ï¼šè¡¡é‡â€œçˆ½æ¨¡å¼â€çš„å«é‡‘é‡ã€‚
   * Human Intervention Rateï¼šè¡¡é‡æ²»ç†ç³»ç»Ÿæ˜¯å¦è¿‡äºç¹çï¼ˆå¦‚æœç”¨æˆ·æ€»æ˜¯ 100% ç¡®è®¤ï¼Œè¯´æ˜ç­–ç•¥éœ€è¦è°ƒä¼˜ï¼‰ã€‚
   * Skill Confidence Driftï¼šæŠ€èƒ½ç½®ä¿¡åº¦çš„å˜åŒ–æ›²çº¿ã€‚
5. æœ€ç»ˆå®šè°ƒï¼šä»â€œåŠŸèƒ½å åŠ â€è½¬å‘â€œå…±è¯†æ”¶æ•›â€
æ­£å¦‚ä½ æ‰€è¨€ï¼Œyuangs å·²ç»å®Œæˆäº† ä» 0 åˆ° 1 çš„â€œå¯èƒ½æ€§éªŒè¯â€ã€‚
æ¥ä¸‹æ¥çš„æ ¸å¿ƒç›®æ ‡æ˜¯ï¼šæŠŠæ•£è½åœ¨å„å¤„çš„ç¡¬æ ¸èƒ½åŠ›ï¼Œæ²‰æ·€ä¸ºä¸€å¥—å¯é¢„æµ‹çš„â€œæ²»ç†åè®®â€ã€‚
 * P0: åˆå¹¶ ContextBuffer ä¸ ContextStoreï¼Œæ¶ˆé™¤è®°å¿†å†—ä½™ã€‚
 * P1: å°† Governance é€»è¾‘å½»åº•æ’ä»¶åŒ–ï¼ˆExternal Policiesï¼‰ã€‚
 * P2: å®Œå–„ Replay çš„å¯¹æ¯”æ·±åº¦ï¼Œæ”¯æŒâ€œè·¨æ¨¡å‹å†³ç­–è·¯å¾„å¯¹æ¯”â€ã€‚
è¯„ä»·æ€»ç»“ï¼š
ä½ è¿™ä»½è¯„ä¼°æŠ¥å‘Šå·²ç»å…·å¤‡äº†ä½œä¸º v1.0-RC1 è·¯çº¿å›¾çš„èµ„æ ¼ã€‚å®ƒè®© yuangs å½»åº•æ‘†è„±äº†â€œå¼€å‘è€…è‡ªå—¨â€çš„èŒƒç•´ï¼Œå¼€å§‹å‘ç€ä¸€ä¸ªçœŸæ­£å…·å¤‡å·¥ç¨‹ç¡®å®šæ€§çš„ã€å¯æ²»ç†çš„ AI è¿è¡Œç¯å¢ƒè¿ˆè¿›ã€‚
å‡†å¤‡å¥½å¼€å¯æ¶æ„æ”¶æ•›çš„ç¬¬ä¸€æ­¥ï¼ˆåˆå¹¶æ²»ç†é€»è¾‘ï¼‰äº†å—ï¼Ÿ
æ—¢ç„¶å…±è¯†å·²ç»è¾¾æˆï¼Œè¯„ä¼°å·²ç»å°æ¡£ï¼Œé‚£æˆ‘ä»¬å°±ç›´æ¥è¿›å…¥**â€œæ¶æ„æ”¶æ•›æœŸâ€çš„ç¬¬ä¸€æ¬¡å®æˆ˜**ã€‚
æˆ‘ä»¬è¦åšçš„ç¬¬ä¸€ä»¶äº‹ï¼Œå°±æ˜¯æŠŠé‚£ä¸ªè®©ä½ æ„Ÿåˆ°â€œç¼ºäº†ç‚¹ä»€ä¹ˆâ€çš„ä¸Šä¸‹æ–‡ç®¡ç†ï¼Œä»¥åŠè¯„ä¼°ä¸­æåˆ°çš„â€œæ¶æ„é‡å â€ï¼Œé€šè¿‡ä¸€ä¸ª**ç»Ÿä¸€çš„â€œä¸Šä¸‹æ–‡å†…æ ¸ï¼ˆContext Kernelï¼‰â€**ç»™æ‰ç‰¢ã€‚
ğŸ› ï¸ ä»»åŠ¡ç›®æ ‡ï¼šå®ç° UniversalContextManager
æˆ‘ä»¬å°†åºŸå¼ƒæ‰ ContextBuffer å’Œæ•£è½åœ¨å„å¤„çš„ä¸´æ—¶å­˜å‚¨ï¼Œå»ºç«‹ä¸€ä¸ªç»Ÿä¸€çš„ã€å…·å¤‡æ²»ç†æ„ŸçŸ¥å’Œè‡ªåŠ¨å‘ç°èƒ½åŠ›çš„ä¸Šä¸‹æ–‡ä¸­æ¢ã€‚
1. æ ¸å¿ƒæ¶æ„è®¾è®¡
è¿™ä¸ª Manager å°†å…·å¤‡ä»¥ä¸‹ç¡¬æ ¸ç‰¹æ€§ï¼š
 * ç»Ÿä¸€å­˜å‚¨ (Single Source of Truth)ï¼šæ‰€æœ‰ @file, #dir, æŠ¥é”™ä¿¡æ¯ï¼Œå…¨éƒ¨å½’ä¸€åŒ–ã€‚
 * ä¾èµ–å›¾æ„ŸçŸ¥ (Auto-Discovery)ï¼šå½“ä½ æ‰‹åŠ¨æ·»åŠ ä¸€ä¸ªæ–‡ä»¶ï¼Œå®ƒä¼šè‡ªåŠ¨å»ºè®®ç›¸å…³çš„ä¾èµ–ã€‚
 * çŠ¶æ€æ¼‚ç§»æ£€æµ‹ (Drift Protection)ï¼šå®æ—¶æ ¡éªŒç£ç›˜æ–‡ä»¶ä¸å†…å­˜å¿«ç…§çš„ Hash å·®å¼‚ã€‚
2. æœ€å°æ”¶æ•›å®ç° (TypeScript)
ä½ å¯ä»¥ç›´æ¥å‚è€ƒä»¥ä¸‹é€»è¾‘æ¥é‡æ„ä½ çš„ src/core/context/ ç›®å½•ï¼š
// src/core/context/UniversalContextManager.ts

export class UniversalContextManager {
  private registry: Map<string, ContextItem> = new Map();
  private policy: GovernancePolicy;

  constructor(policy: GovernancePolicy) {
    this.policy = policy;
  }

  /**
   * æ ¸å¿ƒæ”¶å£æ–¹æ³•ï¼šæ·»åŠ ä»»ä½•ä¸Šä¸‹æ–‡éƒ½å¿…é¡»ç»è¿‡æ²»ç†è„±æ•
   */
  async mount(type: 'file' | 'cmd_error' | 'symbol', source: string, rawData: string) {
    // 1. æ²»ç†è„±æ• (Redaction)
    const sanitizedData = await this.policy.sanitize(rawData);

    // 2. ç”Ÿæˆå¿«ç…§ä¸ Hash
    const item: ContextItem = {
      id: `${type}:${source}`,
      content: sanitizedData,
      hash: this.computeHash(sanitizedData),
      meta: { timestamp: Date.now(), source }
    };

    this.registry.set(item.id, item);

    // 3. è‡ªåŠ¨å…³è” (Dependency Discovery) - Phase 2 å®ç°
    if (type === 'file') {
      this.discoverDependencies(sanitizedData);
    }
  }

  /**
   * æ£€æŸ¥â€œæ¼‚ç§»â€ï¼šAI çœ‹åˆ°çš„è¿˜æ˜¯ä½ ç°åœ¨çš„ä»£ç å—ï¼Ÿ
   */
  async verifyIntegrity(): Promise<DriftReport> {
    const report: DriftReport = { isConsistent: true, diffs: [] };
    for (const [id, item] of this.registry) {
      if (id.startsWith('file:')) {
        const onDisk = await fs.readFile(item.meta.source, 'utf-8');
        if (this.computeHash(onDisk) !== item.hash) {
          report.isConsistent = false;
          report.diffs.push(item.meta.source);
        }
      }
    }
    return report;
  }

  // è¿™é‡Œçš„ generatePayload å°†æˆä¸ºä¼ é€’ç»™ Agent çš„å”¯ä¸€å…¥å£
  assemble(): string {
    return Array.from(this.registry.values())
      .map(item => `[${item.id}]\n${item.content}`)
      .join('\n\n');
  }
}

ğŸš€ åŠ¨ä½œæŒ‡ä»¤ï¼šæ”¶æ•›ç¬¬ä¸€æ­¥
è¯·æŒ‰ç…§ä»¥ä¸‹é¡ºåºåœ¨ä½ çš„é¡¹ç›®ä¸­æ‰§è¡Œæ“ä½œï¼š
 * Freeze Legacy: åœ¨ ContextBuffer å’Œ legacy/governance çš„ä»£ç æ–‡ä»¶é¡¶éƒ¨åŠ ä¸Š // DEPRECATED: Use UniversalContextManager insteadã€‚
 * å»ºç«‹ src/core/kernel/: æŠŠä¸Šé¢çš„ Manager é€»è¾‘è¿å…¥ï¼Œå¹¶æŠŠ GovernanceEngine ä½œä¸ºå®ƒçš„æ„é€ å‡½æ•°å‚æ•°ã€‚
 * é‡å†™ yuangs ai å…¥å£:
   * åˆ é™¤å‘½ä»¤å¤„ç†å‡½æ•°ä¸­æ‰‹åŠ¨æ‹¼æ¥å­—ç¬¦ä¸²çš„é€»è¾‘ã€‚
   * æ”¹ä¸º context.mount() å„ç§è¾“å…¥ï¼Œæœ€åè°ƒç”¨ context.assemble()ã€‚
ä¸‹ä¸€æ­¥ï¼Œæˆ‘ä»¬æ”»å…‹å“ªä¸ªå ¡å’ï¼Ÿ
 * é€‰é¡¹ Aï¼šåŒ Agent åŠ¨æ€ Replanningï¼ˆè®© Planner çœŸæ­£åŠ¨èµ·æ¥ï¼‰ã€‚
 * é€‰é¡¹ Bï¼šå¤–éƒ¨ Policy å¼•æ“ï¼ˆæŠŠæ²»ç†è§„åˆ™å†™è¿› YAMLï¼Œå®ç°æœºåˆ¶ä¸ç­–ç•¥å½»åº•åˆ†ç¦»ï¼‰ã€‚
ä½ æƒ³å…ˆåŠ¨å“ªä¸€å—ï¼Ÿ
æ—¢ç„¶é€‰æ‹©äº† é€‰é¡¹ Aï¼šåŒ Agent åŠ¨æ€ Replanningï¼Œæˆ‘ä»¬å°±æ­£å¼è¿›å…¥äº† Agent æ¶æ„çš„â€œæ·±æ°´åŒºâ€ã€‚
è¿™æ˜¯ä»â€œçº¿æ€§æ‰¹å¤„ç†â€å‘â€œåé¦ˆé©±åŠ¨å‹æ™ºèƒ½â€çš„å…³é”®ä¸€è·³ã€‚åœ¨å¤æ‚çš„ä»£ç é‡æ„æˆ– Bug ä¿®å¤åœºæ™¯ä¸­ï¼ŒPlanner ç”Ÿæˆçš„è®¡åˆ’å¾€å¾€æ˜¯åŸºäºåˆæ€çš„å‡è®¾ã€‚ä¸€æ—¦ Executor åœ¨æ‰§è¡Œç¬¬ä¸€æ­¥æ—¶å‘ç°äº†æ–°çš„æŠ¥é”™æˆ–æ„å¤–çš„ä¾èµ–ï¼ŒåŸè®¡åˆ’å°±å¤±æ•ˆäº†ã€‚
æˆ‘ä»¬è¦å®ç°çš„ï¼Œå°±æ˜¯è®©ç³»ç»Ÿæ‹¥æœ‰**â€œè¾¹åšè¾¹çœ‹ï¼Œçœ‹é”™é‡è°‹â€**çš„èƒ½åŠ›ã€‚
1. åŠ¨æ€ Replanning çš„å› æœå¾ªç¯æ¶æ„
æˆ‘ä»¬éœ€è¦åœ¨ DualAgentRuntime ä¸­æ„å»ºä¸€ä¸ªé—­ç¯ï¼Œæ ¸å¿ƒåœ¨äº Observationï¼ˆè§‚å¯Ÿï¼‰ èŠ‚ç‚¹çš„åé¦ˆæœºåˆ¶ã€‚
2. æ ¸å¿ƒä»£ç é€»è¾‘å®ç°
ä½ å¯ä»¥åœ¨ src/runtime/DualAgentRuntime.ts ä¸­å¼•å…¥å¦‚ä¸‹é€»è¾‘æ¥å®ç°è¿™ç§åŠ¨æ€æ€§ï¼š
// ä¼ªä»£ç ï¼šåŒ Agent åŠ¨æ€è§„åˆ’æ ¸å¿ƒé€»è¾‘
async function runWithDynamicReplanning(initialTask: string) {
  // 1. åˆå§‹è§„åˆ’
  let currentPlan = await this.planner.plan(initialTask, this.context.assemble());
  let stepIndex = 0;

  while (stepIndex < currentPlan.steps.length) {
    const currentStep = currentPlan.steps[stepIndex];
    console.log(`[Planner] æ­£åœ¨æ‰§è¡Œç¬¬ ${stepIndex + 1} æ­¥: ${currentStep.description}`);

    // 2. æ‰§è¡Œå¹¶è·å–è§‚å¯Ÿç»“æœ
    const observation = await this.executor.execute(currentStep);

    // 3. è®°å½•å› æœé“¾
    this.causalTracker.record(currentStep.id, observation);

    // 4. å†²çªåˆ¤å®šä¸åŠ¨æ€é‡è§„åˆ’
    if (observation.status === 'FAILED') {
      console.warn(`[Runtime] æ­¥éª¤å¤±è´¥: ${observation.error.message}`);
      
      // æ ¸å¿ƒåŠ¨ä½œï¼šRe-plan
      // å‘Šè¯‰ Plannerï¼šä»»åŠ¡è¿˜æ²¡å®Œï¼Œè¿™æ˜¯ç›®å‰çš„ç°åœºï¼Œå‰©ä¸‹çš„æ­¥éª¤ä½ çœ‹çœ‹æ€ä¹ˆæ”¹ï¼Ÿ
      const replanRequest = {
        originalTask: initialTask,
        failedStep: currentStep,
        error: observation.error,
        remainingSteps: currentPlan.steps.slice(stepIndex + 1),
        currentContext: await this.context.refresh() // æŠ“å–æœ€æ–°çš„æ–‡ä»¶çŠ¶æ€
      };

      const newPlan = await this.planner.replan(replanRequest);
      
      if (newPlan.action === 'ABORT') {
        throw new Error("AI åˆ¤å®šå½“å‰ä»»åŠ¡æ— æ³•ç»§ç»­ï¼Œå·²å®‰å…¨ä¸­æ–­ã€‚");
      }

      // æ›¿æ¢æ—§è®¡åˆ’ï¼Œé‡ç½®ç´¢å¼•
      currentPlan = newPlan;
      stepIndex = 0; 
      console.log("[Planner] è®¡åˆ’å·²åŠ¨æ€è°ƒæ•´ï¼Œé‡æ–°å¼€å§‹æ‰§è¡Œæ–°è·¯å¾„ã€‚");
      continue;
    }

    stepIndex++;
  }
}

3. å®ç°è¿™ä¸ªæ¨¡å¼çš„ä¸‰ä¸ªå…³é”®ç‚¹
 * è§‚å¯Ÿåé¦ˆï¼ˆObservation Feedbackï¼‰ï¼šExecutor ä¸ä»…ä»…è¦å›ä¼ â€œæˆåŠŸ/å¤±è´¥â€ï¼Œè¿˜è¦å›ä¼ **â€œç°çŠ¶â€**ï¼ˆæ¯”å¦‚ï¼šä¿®æ”¹åçš„ç¼–è¯‘æŠ¥é”™ä¿¡æ¯ï¼‰ã€‚è¿™æ˜¯ Planner é‡æ–°æ€è€ƒçš„ç‡ƒæ–™ã€‚
 * ä¸Šä¸‹æ–‡åˆ·æ–°ï¼ˆContext Refreshï¼‰ï¼šåœ¨ Replanning ä¹‹å‰ï¼Œå¿…é¡»è°ƒç”¨ä¹‹å‰æˆ‘ä»¬è®¨è®ºçš„ UniversalContextManager çš„éªŒè¯æœºåˆ¶ï¼Œç¡®ä¿ Planner çœ‹åˆ°çš„æ˜¯æ‰§è¡Œä¸€æ­¥ä¹‹åçš„çœŸå®ç‰©ç†çŠ¶æ€ï¼Œè€Œä¸æ˜¯ç¼“å­˜ã€‚
 * æ²»ç†ä»‹å…¥ï¼ˆGovernance Interruptionï¼‰ï¼šæ–°çš„ Plan ç”Ÿæˆåï¼Œå¿…é¡»é‡æ–°è§¦å‘ GovernanceEngine çš„å®¡æ‰¹æµã€‚å› ä¸ºæ–°è®¡åˆ’å¯èƒ½åŒ…å«åŸè®¡åˆ’æ²¡æœ‰çš„é«˜é£é™©æ“ä½œï¼ˆæ¯”å¦‚åŸè®¡åˆ’æ”¹ä»£ç ï¼Œæ–°è®¡åˆ’å†³å®šåˆ æ‰æŸä¸ªä¸å…¼å®¹çš„åº“ï¼‰ã€‚
4. ä¸ºä»€ä¹ˆè¿™ç¬¦åˆä½ çš„â€œç¡¬æ ¸â€åŸºå› ï¼Ÿ
è¿™ç§æ¨¡å¼å½»åº•è§£å†³äº† Agent çš„**â€œæ‰§æ‹—å€¾å‘â€**ï¼ˆå³ AI å‘ç°é”™äº†ä¹Ÿéè¦æŒ‰ç…§æ—§è®¡åˆ’èµ°åˆ°åº•ï¼‰ã€‚å®ƒè®©ä½ çš„ CLI å·¥å…·åœ¨å¤„ç†å¤§è§„æ¨¡é‡æ„ä»»åŠ¡æ—¶ï¼Œè¡¨ç°å¾—åƒä¸€ä¸ªç»éªŒä¸°å¯Œã€æ‡‚å¾—â€œè§æ‹›æ‹†æ‹›â€çš„é«˜çº§å·¥ç¨‹å¸ˆã€‚
ä¸‹ä¸€æ­¥å»ºè®®ï¼š
ä½ å¯ä»¥å…ˆå†™ä¸€ä¸ªç®€å•çš„æµ‹è¯•ç”¨ä¾‹ï¼š
 * ç»™ AI ä¸€ä¸ªä»»åŠ¡ï¼šä¿®æ”¹ A.ts ä¸­çš„å‡½æ•°åå¹¶æ›´æ–°æ‰€æœ‰å¼•ç”¨ã€‚
 * æ¨¡æ‹Ÿ Executor æ‰§è¡Œç¬¬ä¸€æ­¥åï¼Œæ•…æ„æŠ¥ä¸€ä¸ª B.ts åªè¯» çš„é”™è¯¯ã€‚
 * è§‚å¯Ÿ Planner æ˜¯å¦èƒ½è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªæ–°çš„è®¡åˆ’ï¼šå…ˆ chmod B.tsï¼Œå†ç»§ç»­ä¿®æ”¹ã€‚
å¦‚æœä½ å‡†å¤‡å¥½å†™è¿™å—é€»è¾‘äº†ï¼Œæˆ‘å¯ä»¥å¸®ä½ ç»†æ„ Planner.replan çš„ Prompt ç»“æ„ã€‚è¦è¯•è¯•å—ï¼Ÿ
æ—¢ç„¶ç›®æ ‡æ˜ç¡®ï¼Œæˆ‘ä»¬ç°åœ¨å°±æ¥æ‹†è§£ Planner.replan çš„ Prompt ç»“æ„ã€‚
è¿™éƒ¨åˆ†æ˜¯åŠ¨æ€è§„åˆ’çš„â€œå¤§è„‘â€ï¼Œå®ƒå¿…é¡»èƒ½å¤ŸåŒºåˆ†â€œé¢„æ¡ˆâ€ä¸â€œå˜æ•°â€ã€‚ä¸€ä¸ªç¡¬æ ¸çš„ Replanning Prompt ä¸èƒ½åªæ˜¯é—®â€œç°åœ¨æ€ä¹ˆåŠâ€ï¼Œè€Œå¿…é¡»æä¾›å› æœä¸Šä¸‹æ–‡ã€‚
1. Planner Replanning Prompt é€»è¾‘è®¾è®¡
æˆ‘ä»¬éœ€è¦å‘ LLM æä¾›ä¸‰ä¸ªæ ¸å¿ƒç»´åº¦çš„æ•°æ®ï¼Œä½¿å…¶äº§ç”Ÿé«˜è´¨é‡çš„ä¿®æ­£è®¡åˆ’ï¼š
 * ç»´åº¦ Aï¼šä»»åŠ¡è°±ç³» (Lineage) â€”â€” â€œæˆ‘ä»¬è¦å»å“ªï¼Ÿâ€ï¼ˆåŸå§‹ç›®æ ‡ï¼‰ä»¥åŠâ€œæˆ‘ä»¬å·²ç»åšäº†ä»€ä¹ˆï¼Ÿâ€ï¼ˆå·²å®Œæˆçš„ Stepsï¼‰ã€‚
 * ç»´åº¦ Bï¼šç‰©ç†æŒ«æŠ˜ (Physical Setback) â€”â€” â€œåˆšæ‰å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿâ€ï¼ˆå…·ä½“çš„æŠ¥é”™è¾“å‡º stderrï¼‰ã€‚
 * ç»´åº¦ Cï¼šå®æ—¶ç°åœº (Live Context) â€”â€” â€œç°åœ¨ä¸–ç•Œå˜æˆäº†ä»€ä¹ˆæ ·ï¼Ÿâ€ï¼ˆæ‰§è¡Œäº†ä¸€åŠåçš„ä»£ç çŠ¶æ€ï¼‰ã€‚
2. Prompt æ¨¡æ¿ï¼ˆæ ¸å¿ƒå®ç°ï¼‰
ä½ å¯ä»¥å°†æ­¤ç»“æ„é›†æˆåˆ°ä½ çš„ Planner ç±»ä¸­ï¼š
### Role
ä½ æ˜¯ä¸€ä¸ªé«˜çº§å·¥ç¨‹æ¶æ„å¸ˆï¼Œè´Ÿè´£åœ¨ä¸€ä¸ªå—æ§çš„æ²»ç†è¿è¡Œæ—¶ï¼ˆyuangs CLIï¼‰ä¸­åŠ¨æ€è°ƒæ•´æ‰§è¡Œè®¡åˆ’ã€‚

### Task Context
- **åŸå§‹ç»ˆæç›®æ ‡**: {{initialTask}}
- **å·²æˆåŠŸæ‰§è¡Œçš„æ­¥éª¤**: 
{{completedStepsList}}

### Current Crisis (å…³é”®è§‚å¯Ÿ)
åˆšæ‰æ‰§è¡Œæ­¥éª¤ [{{failedStepId}}] æ—¶å¤±è´¥äº†ã€‚
- **å¤±è´¥æ­¥éª¤æè¿°**: {{failedStepDescription}}
- **é”™è¯¯è¾“å‡º (Stderr)**: 

{{observationError}}

### Current World State
ä»¥ä¸‹æ˜¯æ‰§è¡Œéƒ¨åˆ†ä¿®æ”¹åçš„å½“å‰æ–‡ä»¶çŠ¶æ€å¿«ç…§ï¼ˆå·²è„±æ•ï¼‰ï¼š
{{currentContext}}

### Instructions
1. **æ ¹æœ¬åŸå› åˆ†æ**: ç®€è¦åˆ†æä¸ºä»€ä¹ˆä¹‹å‰çš„è®¡åˆ’åœ¨è¿™ä¸€æ­¥æ–­æ‰äº†ã€‚
2. **è®¡åˆ’é‡æ„**: åŸºäºå½“å‰é”™è¯¯ï¼Œé‡æ–°ç”Ÿæˆå‰©ä½™çš„æ­¥éª¤ã€‚
   - å¦‚æœæ˜¯æƒé™é—®é¢˜ï¼Œå¢åŠ  `chmod` æ­¥éª¤ã€‚
   - å¦‚æœæ˜¯é€»è¾‘ä¾èµ–ç¼ºå¤±ï¼Œå¢åŠ  `fetch/read` æ­¥éª¤ã€‚
   - å¦‚æœä»»åŠ¡å·²æ— æ³•å®Œæˆï¼Œè¯·è¾“å‡º `ABORT`ã€‚

### Output Format (JSON Only)
å¿…é¡»è¿”å›ä»¥ä¸‹ç»“æ„çš„ JSONï¼š
{
  "analysis": "å¯¹é”™è¯¯çš„æ·±åº¦è§£æ",
  "action": "CONTINUE | ABORT",
  "newSteps": [
    { "id": "S1", "description": "...", "risk": "low|med|high" }
  ]
}

3. å®ç°ç»†èŠ‚ï¼šå¦‚ä½•å¤„ç†â€œå› æœé”å®šâ€
ä¸ºäº†é…åˆä½ çš„ Causal Lock æœºåˆ¶ï¼Œåœ¨ replan è¿‡ç¨‹ä¸­éœ€è¦åŠ å…¥ä¸€ä¸ªç¡¬æ ¸çº¦æŸï¼š
â€œç¦æ­¢å¹»è§‰è¡¥æ•‘â€ï¼šè¦æ±‚ Planner å¿…é¡»å¼•ç”¨ observationError é‡Œçš„å…·ä½“ä¿¡æ¯ã€‚å¦‚æœæŠ¥é”™é‡Œæåˆ°äº† line 45ï¼Œæ–°è®¡åˆ’çš„ç¬¬ä¸€æ­¥å¿…é¡»æ˜¯é’ˆå¯¹ line 45 æˆ–å…¶ä¸Šä¸‹æ–‡çš„è°ƒæŸ¥ã€‚
4. è½åœ°æ­¥éª¤å»ºè®®
 * æ„é€  ReplanContext ç±»ï¼šä¸“é—¨è´Ÿè´£æ”¶é›† UniversalContextManager çš„æœ€æ–°å¿«ç…§ + CausalTracker çš„å†å²ã€‚
 * å®ç° DualAgentRuntime.handleFailure()ï¼š
   * è§¦å‘ replanã€‚
   * é‡è¦ï¼šå°†æ–°è®¡åˆ’é€šè¿‡ GovernanceEngine å†æ¬¡å¼¹çª—ç»™ç”¨æˆ·ã€‚
   * ç”¨æˆ·çœ‹åˆ°çš„æç¤ºåº”è¯¥æ˜¯ï¼šâ€œâš ï¸ æ­¥éª¤ 2 å¤±è´¥ï¼ŒAI å·²è°ƒæ•´åç»­è®¡åˆ’ï¼Œæ˜¯å¦æ‰¹å‡†æ–°è·¯å¾„ï¼Ÿâ€
ä¸‹ä¸€ä¸ªæŒ‘æˆ˜
å½“ä½ æŠŠè¿™ä¸ªå¾ªç¯è·‘é€šåï¼Œyuangs å°±çœŸæ­£å…·å¤‡äº†**â€œéŸ§æ€§â€ (Resilience)**ã€‚
ä½ è§‰å¾—åœ¨ Replanning æ—¶ï¼Œæ˜¯å¦éœ€è¦ç»™ AI ä¸€ä¸ªâ€œå›æ»šï¼ˆRollbackï¼‰â€çš„é€‰é¡¹ï¼Ÿ æ¯”å¦‚ï¼šå¦‚æœ AI è§‰å¾—æ”¹ä¹±äº†ï¼Œå…ˆæ’¤é”€å‰ä¸¤æ­¥ï¼Œå†é‡æ–°å¼€å§‹ï¼Ÿè¿™ä¼šæ¶‰åŠåˆ°ä½  Governance æ¨¡å—ä¸­çš„ Snapshot/Restore èƒ½åŠ›ã€‚
æ—¢ç„¶å†³å®šå¼•å…¥ å›æ»šï¼ˆRollbackï¼‰ æœºåˆ¶ï¼Œé‚£æˆ‘ä»¬å°±æŠŠ yuangs çš„ç¡¬æ ¸ç¨‹åº¦æ¨å‘äº†äº‹åŠ¡çº§æ²»ç†çš„é«˜åº¦ã€‚
åœ¨åŒ Agent åŠ¨æ€è§„åˆ’ä¸­ï¼Œå›æ»šä¸åªæ˜¯â€œæ’¤é”€æ–‡ä»¶ä¿®æ”¹â€ï¼Œå®ƒæ˜¯ä¸€ç§**â€œè®¤çŸ¥ä¿®æ­£â€ã€‚å½“ Planner å‘ç°å½“å‰çš„çŠ¶æ€å·²ç»è¿›å…¥æ­»èƒ¡åŒï¼ˆä¾‹å¦‚ï¼šç”±äºé”™è¯¯çš„é‡æ„å¯¼è‡´äº†å¤§è§„æ¨¡çš„ç±»å‹æ±¡æŸ“ï¼‰ï¼Œæœ€ç†æ™ºçš„è¡Œä¸ºä¸æ˜¯è¡¥ä¸åŠ è¡¥ä¸ï¼Œè€Œæ˜¯å›åˆ°å·²çŸ¥çš„æœ€åä¸€ä¸ªç¨³å®šæ£€æŸ¥ç‚¹**ï¼Œé‡æ–°åˆ¶å®šè®¡åˆ’ã€‚
1. äº‹åŠ¡åŒ–æ²»ç†æµ (Transactional Governance Flow)
æˆ‘ä»¬éœ€è¦åœ¨ DualAgentRuntime ä¸­å¼•å…¥ä¸€ä¸ªç±»ä¼¼æ•°æ®åº“äº‹åŠ¡çš„ Snapshot æœºåˆ¶ã€‚
 * Checkpoint (æ£€æŸ¥ç‚¹)ï¼šåœ¨æ‰§è¡Œ Planner çš„æ¯ä¸€æ‰¹æ¬¡ä»»åŠ¡å‰ï¼Œè‡ªåŠ¨å¯¹å—å½±å“çš„æ–‡ä»¶è¿›è¡Œç‰©ç†å¿«ç…§ã€‚
 * Failure Analysis (æ•…éšœåˆ¤å®š)ï¼šå¦‚æœ Executor æŠ¥é”™ï¼Œä¸”åˆ¤å®šä¸º RECOVERABLE_ONLY_BY_ROLLBACKã€‚
 * Restore (å›æ»š)ï¼šåˆ©ç”¨ GovernanceEngine å¼ºåˆ¶å›æ»šç‰©ç†æ–‡ä»¶ã€‚
 * Re-logic (é‡è§„åˆ’)ï¼šPlanner è·å¾—â€œå›æ»šæˆåŠŸâ€çš„ç¡®è®¤ï¼Œå¹¶è¢«å‘ŠçŸ¥â€œè·¯å¾„ A ä¸é€šâ€ï¼Œä»è€Œåœ¨å¹²å‡€çš„çŠ¶æ€ä¸‹å°è¯•è·¯å¾„ Bã€‚
2. æœ€å°å®ç°é€»è¾‘ï¼šSnapshotManager
ä½ å¯ä»¥åœ¨ src/governance/ ç›®å½•ä¸‹å¢åŠ è¿™ä¸ªç»„ä»¶ï¼Œè®©å›æ»šå˜å¾—åŸå­åŒ–ï¼š
// src/governance/SnapshotManager.ts
import { copyFile, mkdir } from 'fs/promises';

export class SnapshotManager {
  private snapshotDir = '.yuangs/snapshots';

  async create(files: string[], stepId: string) {
    const versionDir = path.join(this.snapshotDir, stepId);
    await mkdir(versionDir, { recursive: true });
    
    for (const file of files) {
      // å­˜å‚¨åŸå§‹ç‰ˆæœ¬ï¼Œç”¨äºå›æ»š
      await copyFile(file, path.join(versionDir, path.basename(file)));
    }
  }

  async rollback(stepId: string, files: string[]) {
    const versionDir = path.join(this.snapshotDir, stepId);
    for (const file of files) {
      const backup = path.join(versionDir, path.basename(file));
      await copyFile(backup, file);
    }
    console.log(`[Governance] å·²å®Œæˆ Step ${stepId} çš„ç‰©ç†å›æ»šã€‚`);
  }
}

3. ç»™ AI çš„å›æ»šæŒ‡ä»¤ (The Rollback Prompt)
å½“è§¦å‘å›æ»šæ—¶ï¼Œç»™ Planner çš„ Prompt éœ€è¦ç‰¹åˆ«è®¾è®¡ï¼Œé˜²æ­¢å®ƒå†æ¬¡æ‰è¿›åŒä¸€ä¸ªå‘é‡Œï¼š
> â€œè­¦å‘Šï¼šä¹‹å‰çš„å°è¯• [Step 2] å¯¼è‡´äº†ä¸å¯æ¢å¤çš„ç¼–è¯‘é”™è¯¯ã€‚ç³»ç»Ÿå·²å¼ºåˆ¶å°†æ–‡ä»¶å›æ»šè‡³åˆå§‹çŠ¶æ€ã€‚è¯·åˆ†æå¤±è´¥åŸå› ï¼ˆå¯èƒ½æ˜¯åº“ç‰ˆæœ¬ä¸åŒ¹é…æˆ–è·¯å¾„å‡è®¾é”™è¯¯ï¼‰ï¼Œå¹¶æä¾›ä¸€æ¡é¿å¼€è¯¥é”™è¯¯çš„æ–°è·¯å¾„ã€‚â€
> 
4. ä¸ºä»€ä¹ˆå›æ»šå¯¹â€œçˆ½æ¨¡å¼â€è‡³å…³é‡è¦ï¼Ÿ
å¦‚æœ yuangs åªæœ‰ä¿®æ”¹èƒ½åŠ›è€Œæ²¡æœ‰æ’¤é”€èƒ½åŠ›ï¼Œç”¨æˆ·åœ¨æŒ‰ Enter æ—¶ä¼šçŠ¹è±«ã€‚
æœ‰äº†å›æ»šï¼Œç”¨æˆ·ä¼šéå¸¸å¤§èƒ†åœ°å°è¯•ï¼š
 * â€œåæ­£æ”¹é”™äº†å®ƒèƒ½è‡ªå·±é€€å›æ¥ã€‚â€
 * â€œåæ­£å®ƒæ¯ä¸€æ­¥éƒ½æœ‰å¿«ç…§ã€‚â€
è¿™ç§**â€œå®¹é”™å®‰å…¨æ„Ÿâ€**æ˜¯èµ„æ·±å·¥ç¨‹å¸ˆçˆ±ä¸Šä¸€ä¸ªå·¥å…·çš„åº•å±‚åŸå› ã€‚
ğŸš€ å®æˆ˜å»ºè®®
æ—¢ç„¶ä½ å·²ç»å†³å®šâ€œå¼€å§‹â€ï¼Œå»ºè®®å…ˆåœ¨ yuangs ai çš„åŒ Agent å¾ªç¯ä¸­åŠ å…¥è¿™ä¸‰ä¸ªåˆ¤å®šç‚¹ï¼š
 * Before Step: snapshotManager.create() (è®°å½•æ¡ˆå‘ç°åœº)
 * On Failure: è¯¢é—®ç”¨æˆ·ï¼š[1] å°è¯•ä¿®å¤ [2] å›æ»šå¹¶é‡æ–°è§„åˆ’ [3] é€€å‡º
 * On Choice [2]: æ‰§è¡Œ rollback() -> planner.replan()
è¿™å¥—é€»è¾‘ä¸€ä¸Šçº¿ï¼Œyuangs å°±ä¸å†æ˜¯ä¸€ä¸ªâ€œè„šæ‰‹æ¶â€ï¼Œå®ƒå·²ç»æ˜¯ä¸€ä¸ªå…·å¤‡â€œè‡ªæˆ‘ä¿®å¤ä¸è‡ªæˆ‘å¦å®šèƒ½åŠ›â€çš„ AI å®éªŒå®¤äº†ã€‚
ä½ ç°åœ¨çš„ ContextStore é‡Œå·²ç»æœ‰æ–‡ä»¶å†…å®¹çš„ Hash äº†å—ï¼Ÿæˆ‘ä»¬è¦ä¸è¦ç”¨å®ƒæ¥åšç§’çº§çš„å›æ»šæ ¡éªŒï¼Ÿ
æ—¢ç„¶å†³å®šå¼•å…¥å›æ»šï¼ˆRollbackï¼‰æœºåˆ¶ï¼Œé‚£æˆ‘ä»¬å°±æŠŠ yuangs çš„ç¡¬æ ¸ç¨‹åº¦æ¨å‘äº†äº‹åŠ¡çº§æ²»ç†çš„é«˜åº¦ã€‚
åœ¨åŒ Agent åŠ¨æ€è§„åˆ’ä¸­ï¼Œå›æ»šä¸åªæ˜¯â€œæ’¤é”€æ–‡ä»¶ä¿®æ”¹â€ï¼Œå®ƒæ˜¯ä¸€ç§**â€œè®¤çŸ¥ä¿®æ­£â€ã€‚å½“ Planner å‘ç°å½“å‰çš„çŠ¶æ€å·²ç»è¿›å…¥æ­»èƒ¡åŒï¼ˆä¾‹å¦‚ï¼šç”±äºé”™è¯¯çš„é‡æ„å¯¼è‡´äº†å¤§è§„æ¨¡çš„ç±»å‹æ±¡æŸ“ï¼‰ï¼Œæœ€ç†æ™ºçš„è¡Œä¸ºä¸æ˜¯è¡¥ä¸åŠ è¡¥ä¸ï¼Œè€Œæ˜¯å›åˆ°å·²çŸ¥çš„æœ€åä¸€ä¸ªç¨³å®šæ£€æŸ¥ç‚¹**ï¼Œé‡æ–°åˆ¶å®šè®¡åˆ’ã€‚
1. äº‹åŠ¡åŒ–æ²»ç†æµ (Transactional Governance Flow)
æˆ‘ä»¬éœ€è¦åœ¨ DualAgentRuntime ä¸­å¼•å…¥ä¸€ä¸ªç±»ä¼¼æ•°æ®åº“äº‹åŠ¡çš„ Snapshot æœºåˆ¶ã€‚
 * Checkpoint (æ£€æŸ¥ç‚¹)ï¼šåœ¨æ‰§è¡Œ Planner çš„æ¯ä¸€æ‰¹æ¬¡ä»»åŠ¡å‰ï¼Œè‡ªåŠ¨å¯¹å—å½±å“çš„æ–‡ä»¶è¿›è¡Œç‰©ç†å¿«ç…§ã€‚
 * Failure Analysis (æ•…éšœåˆ¤å®š)ï¼šå¦‚æœ Executor æŠ¥é”™ï¼Œä¸”åˆ¤å®šä¸º RECOVERABLE_ONLY_BY_ROLLBACKã€‚
 * Restore (å›æ»š)ï¼šåˆ©ç”¨ GovernanceEngine å¼ºåˆ¶å›æ»šç‰©ç†æ–‡ä»¶ã€‚
 * Re-logic (é‡è§„åˆ’)ï¼šPlanner è·å¾—â€œå›æ»šæˆåŠŸâ€çš„ç¡®è®¤ï¼Œå¹¶è¢«å‘ŠçŸ¥â€œè·¯å¾„ A ä¸é€šâ€ï¼Œä»è€Œåœ¨å¹²å‡€çš„çŠ¶æ€ä¸‹å°è¯•è·¯å¾„ Bã€‚
2. æœ€å°å®ç°é€»è¾‘ï¼šSnapshotManager
ä½ å¯ä»¥åœ¨ src/governance/ ç›®å½•ä¸‹å¢åŠ è¿™ä¸ªç»„ä»¶ï¼Œè®©å›æ»šå˜å¾—åŸå­åŒ–ï¼š
// src/governance/SnapshotManager.ts
import { copyFile, mkdir } from 'fs/promises';
import path from 'path';

export class SnapshotManager {
  private snapshotDir = '.yuangs/snapshots';

  async create(files: string[], stepId: string) {
    const versionDir = path.join(this.snapshotDir, stepId);
    await mkdir(versionDir, { recursive: true });
    
    for (const file of files) {
      // å­˜å‚¨åŸå§‹ç‰ˆæœ¬ï¼Œç”¨äºå›æ»š
      await copyFile(file, path.join(versionDir, path.basename(file)));
    }
  }

  async rollback(stepId: string, files: string[]) {
    const versionDir = path.join(this.snapshotDir, stepId);
    for (const file of files) {
      const backup = path.join(versionDir, path.basename(file));
      await copyFile(backup, file);
    }
    console.log(`[Governance] å·²å®Œæˆ Step ${stepId} çš„ç‰©ç†å›æ»šã€‚`);
  }
}

3. ç»™ AI çš„å›æ»šæŒ‡ä»¤ (The Rollback Prompt)
å½“è§¦å‘å›æ»šæ—¶ï¼Œç»™ Planner çš„ Prompt éœ€è¦ç‰¹åˆ«è®¾è®¡ï¼Œé˜²æ­¢å®ƒå†æ¬¡æ‰è¿›åŒä¸€ä¸ªå‘é‡Œï¼š
> â€œè­¦å‘Šï¼šä¹‹å‰çš„å°è¯• [Step 2] å¯¼è‡´äº†ä¸å¯æ¢å¤çš„ç¼–è¯‘é”™è¯¯ã€‚ç³»ç»Ÿå·²å¼ºåˆ¶å°†æ–‡ä»¶å›æ»šè‡³åˆå§‹çŠ¶æ€ã€‚è¯·åˆ†æå¤±è´¥åŸå› ï¼ˆå¯èƒ½æ˜¯åº“ç‰ˆæœ¬ä¸åŒ¹é…æˆ–è·¯å¾„å‡è®¾é”™è¯¯ï¼‰ï¼Œå¹¶æä¾›ä¸€æ¡é¿å¼€è¯¥é”™è¯¯çš„æ–°è·¯å¾„ã€‚â€
> 
4. ä¸ºä»€ä¹ˆå›æ»šå¯¹â€œçˆ½æ¨¡å¼â€è‡³å…³é‡è¦ï¼Ÿ
å¦‚æœ yuangs åªæœ‰ä¿®æ”¹èƒ½åŠ›è€Œæ²¡æœ‰æ’¤é”€èƒ½åŠ›ï¼Œç”¨æˆ·åœ¨æŒ‰ Enter æ—¶ä¼šçŠ¹è±«ã€‚
æœ‰äº†å›æ»šï¼Œç”¨æˆ·ä¼šéå¸¸å¤§èƒ†åœ°å°è¯•ï¼š
 * â€œåæ­£æ”¹é”™äº†å®ƒèƒ½è‡ªå·±é€€å›æ¥ã€‚â€
 * â€œåæ­£å®ƒæ¯ä¸€æ­¥éƒ½æœ‰å¿«ç…§ã€‚â€
è¿™ç§**â€œå®¹é”™å®‰å…¨æ„Ÿâ€**æ˜¯èµ„æ·±å·¥ç¨‹å¸ˆçˆ±ä¸Šä¸€ä¸ªå·¥å…·çš„åº•å±‚åŸå› ã€‚
ğŸš€ å®æˆ˜å»ºè®®
æ—¢ç„¶ä½ å·²ç»å†³å®šâ€œå¼€å§‹â€ï¼Œå»ºè®®å…ˆåœ¨ yuangs ai çš„åŒ Agent å¾ªç¯ä¸­åŠ å…¥è¿™ä¸‰ä¸ªåˆ¤å®šç‚¹ï¼š
 * Before Step: snapshotManager.create() (è®°å½•æ¡ˆå‘ç°åœº)
 * On Failure: è¯¢é—®ç”¨æˆ·ï¼š[1] å°è¯•ä¿®å¤ [2] å›æ»šå¹¶é‡æ–°è§„åˆ’ [3] é€€å‡º
 * On Choice [2]: æ‰§è¡Œ rollback() -> planner.replan()
è¿™å¥—é€»è¾‘ä¸€ä¸Šçº¿ï¼Œyuangs å°±ä¸å†æ˜¯ä¸€ä¸ªâ€œè„šæ‰‹æ¶â€ï¼Œå®ƒå·²ç»æ˜¯ä¸€ä¸ªå…·å¤‡â€œè‡ªæˆ‘ä¿®å¤ä¸è‡ªæˆ‘å¦å®šèƒ½åŠ›â€çš„ AI å®éªŒå®¤äº†ã€‚
ä½ ç°åœ¨çš„ ContextStore é‡Œå·²ç»æœ‰æ–‡ä»¶å†…å®¹çš„ Hash äº†å—ï¼Ÿæˆ‘ä»¬è¦ä¸è¦ç”¨å®ƒæ¥åšç§’çº§çš„å›æ»šæ ¡éªŒï¼Ÿ
å¤ªæ£’äº†ã€‚å¼•å…¥åŸºäº Hash æ ¡éªŒçš„ç§’çº§å›æ»šï¼Œå°†ä¸º yuangs æä¾›ä¸€ç§å·¥ä¸šçº§çš„â€œäº‹åŠ¡ä¸€è‡´æ€§â€ä¿éšœã€‚
æ—¢ç„¶ä½ å·²ç»æœ‰äº† ContextStore é‡Œçš„æ–‡ä»¶ Hashï¼Œæˆ‘ä»¬å°±ä¸å¿…æ¯æ¬¡éƒ½åšæ²‰é‡çš„ç‰©ç†å¤‡ä»½ï¼Œè€Œæ˜¯å¯ä»¥åˆ©ç”¨è¿™ä¸ª Hash å»ºç«‹ä¸€ä¸ª è™šå®ç»“åˆçš„å¿«ç…§ç³»ç»Ÿã€‚
1. ç§’çº§å›æ»šæ ¡éªŒæ¶æ„ (Hash-based Verification)
è¿™ç§è®¾è®¡çš„ä¼˜é›…ä¹‹å¤„åœ¨äºï¼šåªåœ¨æ£€æµ‹åˆ°â€œç‰©ç†åç¦»â€æ—¶æ‰è§¦å‘è­¦æŠ¥æˆ–å›æ»šã€‚
 * Pre-check: æ‰§è¡Œå‰ï¼Œè®°å½• ContextStore ä¸­å½“å‰æ–‡ä»¶çš„ ExpectedHashã€‚
 * Execution: Executor ä¿®æ”¹æ–‡ä»¶ã€‚
 * Post-check:
   * å¦‚æœæˆåŠŸï¼Œæ›´æ–° ContextStore ä¸ºæ–° Hashã€‚
   * å¦‚æœå¤±è´¥ï¼Œå¯¹æ¯” ActualHash ä¸ ExpectedHashã€‚
   * å¦‚æœç”¨æˆ·é€‰æ‹©å›æ»šï¼Œç›´æ¥ç”¨å¿«ç…§æ¢å¤ã€‚
2. æœ€å°å®ç°é€»è¾‘ï¼šåŸºäº Hash çš„å›æ»šæ§åˆ¶å™¨
ä½ å¯ä»¥å°† SnapshotManager å‡çº§ä¸ºå…·å¤‡ Hash æ ¡éªŒèƒ½åŠ›çš„ TransactionManagerï¼š
// src/governance/TransactionManager.ts

export class TransactionManager {
  private checkpoints: Map<string, { files: string[], snapshotId: string }> = new Map();

  constructor(
    private snapshotManager: SnapshotManager,
    private contextStore: ContextStore
  ) {}

  /**
   * å¼€å¯äº‹åŠ¡ï¼šè®°å½•åˆå§‹ Hash å’Œ ç‰©ç†å¤‡ä»½
   */
  async begin(stepId: string, filePaths: string[]) {
    // è®°å½•åœ¨æ‰§è¡Œè¿™ä¸€æ­¥ä¹‹å‰ï¼Œè¿™äº›æ–‡ä»¶åœ¨ ContextStore é‡Œçš„â€œæƒå¨ Hashâ€
    const fileHashes = filePaths.map(p => ({
      path: p,
      hash: this.contextStore.getHash(p)
    }));

    // ç‰©ç†å¿«ç…§
    await this.snapshotManager.create(filePaths, stepId);
    this.checkpoints.set(stepId, { files: filePaths, snapshotId: stepId });
    
    console.log(`[Transaction] äº‹åŠ¡ ${stepId} å·²å¼€å¯ï¼Œå·²é”å®š ${filePaths.length} ä¸ªæ–‡ä»¶ã€‚`);
  }

  /**
   * è§¦å‘å›æ»šï¼šç‰©ç†æ¢å¤ + Hash å¤ä½
   */
  async rollback(stepId: string) {
    const checkpoint = this.checkpoints.get(stepId);
    if (!checkpoint) return;

    // 1. ç‰©ç†å›æ»š
    await this.snapshotManager.rollback(checkpoint.snapshotId, checkpoint.files);

    // 2. çŠ¶æ€ä¸€è‡´æ€§å¤ä½
    for (const path of checkpoint.files) {
      // å¼ºåˆ¶è§¦å‘ä¸€æ¬¡åŒæ­¥ï¼Œç¡®ä¿ ContextStore é‡Œçš„ Hash é‡æ–°å›åˆ°å›æ»šåçš„çŠ¶æ€
      await this.contextStore.refreshFile(path);
    }

    console.log(`[Transaction] æ­¥éª¤ ${stepId} å·²æˆåŠŸå›æ»šè‡³å®‰å…¨ç‚¹ã€‚`);
  }
}

3. ç»™ AI çš„â€œå›æ»šåâ€é‡è§„åˆ’ Prompt å¢å¼º
å½“å›æ»šå‘ç”Ÿåï¼Œæˆ‘ä»¬å¿…é¡»åœ¨ Replanning çš„ Context ä¸­æ˜ç¡®å‘ŠçŸ¥ AIï¼šâ€œä¸–ç•Œå·²é‡ç½®â€ã€‚
> Replanning Context Addon:
> "ATTENTION: The previous action [Step ID] failed critically.
> System State: Successfully performed ROLLBACK.
> Current Hash Check: All files match pre-execution state.
> Constraint: Do NOT repeat the previous logic. Analyze why the previous diff caused a failure and propose a fundamentally different approach."
> 
4. è½åœ°å»ºè®®ï¼šä»â€œå•æ­¥äº‹åŠ¡â€åˆ°â€œé€»è¾‘ç»„äº‹åŠ¡â€
æ—¢ç„¶ä½ å·²ç»å¼€å§‹åŠ¨è¿™å—äº†ï¼Œæˆ‘å»ºè®®æŠŠè¿™ä¸ªèƒ½åŠ›ç›´æ¥æŒ‚è½½åˆ° DualAgentRuntime çš„å¾ªç¯é‡Œï¼š
 * åŸå­æ€§ï¼šæ¯ä¸€è¡Œ planner.steps éƒ½æ˜¯ä¸€ä¸ªæœ€å°äº‹åŠ¡ã€‚
 * å¯è§†åŒ–ï¼šå›æ»šæ—¶ï¼Œç»™è€å‘¨ï¼ˆç”¨æˆ·ï¼‰æ˜¾ç¤ºä¸€ä¸ª Rollback Progress Barï¼Œè®©ä»–æ„Ÿè§‰åˆ°ç³»ç»Ÿæ­£åœ¨ä¿æŠ¤ä»–çš„æºç ã€‚
ä½ ç°åœ¨çš„ SnapshotManager æ˜¯æ‰“ç®—å­˜åœ¨ .yuangs/backups ä¸‹ï¼Œè¿˜æ˜¯ç›´æ¥å­˜åœ¨å†…å­˜é‡Œï¼Ÿ å¯¹äºç¡¬æ ¸é¡¹ç›®ï¼Œæˆ‘å»ºè®®å­˜åœ¨ç£ç›˜ï¼ˆå³ä¾¿æ˜¯åœ¨ /tmpï¼‰ï¼Œè¿™æ ·å³ä½¿ CLI å´©æºƒäº†ï¼Œç”¨æˆ·é‡å¯åä¾ç„¶èƒ½çœ‹åˆ°â€œæŒ‚èµ·â€çš„äº‹åŠ¡å¹¶æ‰‹åŠ¨æ¢å¤ã€‚
é€‰æ‹©å­˜ç£ç›˜æ˜¯æå…¶æ­£ç¡®çš„å†³å®šã€‚è¿™ä¸ä»…æ˜¯ç¡¬æ ¸å¼€å‘è€…çš„ç›´è§‰ï¼Œæ›´æ˜¯ä»â€œç©å…·â€å‘â€œå·¥ä¸šçº§å·¥å…·â€è·¨è¶Šçš„æ ‡å¿—ã€‚
åœ¨ .yuangs/snapshots/ ä¸‹è¿›è¡Œç‰©ç†å­˜å‚¨ï¼Œæ„å‘³ç€ yuangs å…·å¤‡äº†**ç¾éš¾æ¢å¤ï¼ˆDisaster Recoveryï¼‰**çš„èƒ½åŠ›ã€‚å³ä½¿ä½ çš„ CLI å› ä¸º OOM å´©æºƒã€ç»ˆç«¯æ–­ç”µæˆ–è€…è¢« Ctrl+C å¼ºæ€ï¼Œé‚£äº›è¢«æ”¹äº†ä¸€åŠçš„ä»£ç ä¾ç„¶æœ‰æ®å¯æŸ¥ï¼Œæœ‰å¾„å¯é€€ã€‚
1. ç£ç›˜äº‹åŠ¡å¿«ç…§çš„è®¾è®¡æ‹“æ‰‘
æˆ‘ä»¬å°†é‡‡ç”¨ä¸€ç§ç±»ä¼¼äº Git Object æˆ– OverlayFS çš„ç®€å•åˆ†å±‚ç»“æ„ï¼š
 * .yuangs/snapshots/active_transaction.jsonï¼šè®°å½•å½“å‰æ­£åœ¨è¿›è¡Œçš„äº‹åŠ¡ IDã€æ¶‰åŠçš„æ–‡ä»¶åŠå…¶åŸå§‹ Hashã€‚
 * .yuangs/snapshots/[step_id]/ï¼šå­˜æ”¾è¯¥æ­¥éª¤æ‰€æœ‰å—å½±å“æ–‡ä»¶çš„åŸå§‹å‰¯æœ¬ã€‚
2. å¢å¼ºç‰ˆ DiskSnapshotManager å®ç°
è¿™é‡Œæ˜¯ä¸€ä¸ªè€ƒè™‘åˆ°å¥å£®æ€§çš„å®ç°å‚è€ƒï¼š
// src/governance/DiskSnapshotManager.ts
import { copyFile, mkdir, rm, readFile, writeFile } from 'fs/promises';
import path from 'path';

export class DiskSnapshotManager {
  private readonly root = '.yuangs/snapshots';

  async init() {
    await mkdir(this.root, { recursive: true });
  }

  async create(stepId: string, filePaths: string[]) {
    const sessionDir = path.join(this.root, stepId);
    await mkdir(sessionDir, { recursive: true });

    const manifest = {
      stepId,
      timestamp: Date.now(),
      files: [] as { original: string; backup: string; hash: string }[]
    };

    for (const filePath of filePaths) {
      const fileName = path.basename(filePath);
      const backupPath = path.join(sessionDir, `${Date.now()}_${fileName}`);
      
      // ç‰©ç†å¤‡ä»½
      await copyFile(filePath, backupPath);
      
      manifest.files.push({
        original: filePath,
        backup: backupPath,
        hash: "" // ä» ContextStore è·å–
      });
    }

    // å†™å…¥äº‹åŠ¡æ¸…å•ï¼Œç”¨äºå´©æºƒæ¢å¤
    await writeFile(
      path.join(this.root, 'last_transaction.json'),
      JSON.stringify(manifest, null, 2)
    );
  }

  async rollback(stepId: string) {
    const sessionDir = path.join(this.root, stepId);
    const manifestPath = path.join(this.root, 'last_transaction.json');
    const data = JSON.parse(await readFile(manifestPath, 'utf-8'));

    if (data.stepId !== stepId) throw new Error("äº‹åŠ¡ ID ä¸åŒ¹é…ï¼Œæ— æ³•å®‰å…¨å›æ»š");

    for (const file of data.files) {
      await copyFile(file.backup, file.original);
    }

    // å›æ»šæˆåŠŸåæ¸…ç†
    await rm(sessionDir, { recursive: true, force: true });
    await rm(manifestPath);
    console.log(`[DiskSnapshot] ç‰©ç†çŠ¶æ€å·²ä»ç£ç›˜å¤‡ä»½æˆåŠŸæ¢å¤ã€‚`);
  }
}

3. â€œè€å‘¨â€è§†è§’ä¸‹çš„å´©æºƒæ¢å¤æµ
æƒ³è±¡ä¸€ä¸‹è¿™ä¸ªåœºæ™¯ï¼š
 * yuangs æ­£åœ¨æ‰§è¡Œä¸€ä¸ªå¤æ‚çš„è·¨æ–‡ä»¶é‡æ„ã€‚
 * Executor åˆšæ”¹äº† 3 ä¸ªæ–‡ä»¶ï¼Œçªç„¶ä½ çš„ç”µè„‘æ²¡ç”µå…³æœºäº†ã€‚
 * é‡å¯åï¼Œä½ å†æ¬¡è¾“å…¥ yuangs aiã€‚
 * ç³»ç»Ÿé€»è¾‘ï¼š
   * UniversalContextManager å¯åŠ¨æ—¶æ‰«æ .yuangs/snapshots/last_transaction.jsonã€‚
   * å‘ç°å­˜åœ¨æœªå®Œæˆçš„äº‹åŠ¡ã€‚
   * æç¤ºç”¨æˆ·ï¼šâ€œæ£€æµ‹åˆ°ä¸Šæ¬¡æ‰§è¡Œéæ­£å¸¸ä¸­æ–­ï¼Œå—å½±å“æ–‡ä»¶å¯èƒ½å¤„äºä¸­é—´æ€ã€‚æ˜¯å¦æ‰§è¡Œå›æ»šæ¢å¤åˆ°ä¿®æ”¹å‰ï¼Ÿâ€
4. ä¸ºä»€ä¹ˆè¿™æ¯”å†…å­˜å¤‡ä»½å¼ºï¼Ÿ
 * çœŸæ­£çš„äº‹åŠ¡æ€§ï¼šç£ç›˜æ˜¯è¯šå®çš„ã€‚åªè¦å¤‡ä»½æ–‡ä»¶å†™å…¥æˆåŠŸï¼ŒçŠ¶æ€å°±é”å®šäº†ã€‚
 * å®¡è®¡ä»·å€¼ï¼šç”¨æˆ·å¯ä»¥æ‰‹åŠ¨å» .yuangs/snapshots ç›®å½•ä¸‹ç”¨ diff å‘½ä»¤å¯¹æ¯”ï¼šâ€œè¿™ AI åˆšæ‰åˆ°åº•æ‰“ç®—æ€ä¹ˆæ”¹æˆ‘çš„ä»£ç ï¼Ÿâ€
 * è°ƒè¯•å‹å¥½ï¼šå¦‚æœå›æ»šé€»è¾‘æœ¬èº«å‡º Bug äº†ï¼ˆè™½ç„¶ä¸å¸Œæœ›å‘ç”Ÿï¼‰ï¼Œå¤‡ä»½æ–‡ä»¶è¿˜åœ¨ç£ç›˜ä¸Šï¼Œä»£ç ä¸¢ä¸äº†ã€‚
ğŸš€ æ¶æ„é—­ç¯æŒ‡ä»¤
ä½ ç°åœ¨å¯ä»¥ç€æ‰‹åˆå¹¶è¿™å¥—é€»è¾‘äº†ã€‚å½“ Dual-Agent é‡åˆ°å¤±è´¥æ—¶ï¼Œæµç¨‹å¦‚ä¸‹ï¼š
 * åˆ¤å®šï¼šå¤±è´¥äº†ï¼Œéœ€è¦å›æ»šã€‚
 * åŠ¨ä½œï¼šTransactionManager.rollback(stepId)ã€‚
 * åˆ·æ–°ï¼šContextStore.refreshAll()ã€‚
 * é‡è°‹ï¼šPlanner.replan()ã€‚
è¿™æ ·ä¸€æ¥ï¼Œä½ çš„ç³»ç»Ÿå°±æ‹¥æœ‰äº†â€œç‰©ç†çº§â€çš„å®‰å…¨ç½‘ã€‚
æœ€åé—®ä¸€ä¸ªç»†èŠ‚ï¼šåœ¨ .gitignore é‡Œï¼Œæˆ‘ä»¬è¦ä¸è¦è‡ªåŠ¨åŠ ä¸Š .yuangs/snapshotsï¼Ÿï¼ˆå¼ºçƒˆå»ºè®®åŠ ä¸Šï¼Œé˜²æ­¢ç”¨æˆ·ä¸å°å¿ƒæŠŠå·¨å¤§çš„å¤‡ä»½æ–‡ä»¶æåˆ° Git é‡Œå»ï¼‰ã€‚
å¿…é¡»åŠ ï¼Œè€Œä¸”è¦è‡ªåŠ¨åŠ ã€å¼ºåˆ¶åŠ ã€‚
åœ¨ .gitignore ä¸­åŠ å…¥ .yuangs/snapshots æ˜¯ä¿è¯é¡¹ç›®â€œç¡¬æ ¸ä¸”ä½“é¢â€çš„æœ€åä¸€é“é˜²çº¿ã€‚å¦‚æœä¸åŠ ï¼Œç”¨æˆ·ä¸€æ—¦ git status çœ‹åˆ°æˆç™¾ä¸Šåƒä¸ªå¤‡ä»½æ–‡ä»¶ï¼Œæˆ–è€…ä¸å°å¿ƒæŠŠåŒ…å«æ•æ„Ÿæ•°æ®çš„å¿«ç…§æ¨é€åˆ°å…¬å…±ä»“åº“ï¼Œé‚£ yuangs çš„æ²»ç†å½¢è±¡å°±å´©å¡Œäº†ã€‚
1. å®ç°â€œè‡ªåŠ¨åˆå§‹åŒ–æ²»ç†â€
å»ºè®®åœ¨ DiskSnapshotManager çš„ init() æ–¹æ³•ä¸­åŠ å…¥ä¸€ä¸ªâ€œè‡ªåŠ¨é™é»˜é…ç½®â€é€»è¾‘ã€‚
// src/governance/DiskSnapshotManager.ts

async init() {
  // 1. åˆ›å»ºå¿«ç…§æ ¹ç›®å½•
  await mkdir(this.root, { recursive: true });

  // 2. è‡ªåŠ¨ç»´æŠ¤ .gitignore
  const gitignorePath = '.gitignore';
  const entry = '\n# yuangs AI governance snapshots\n.yuangs/snapshots\n';
  
  try {
    const content = await readFile(gitignorePath, 'utf-8');
    if (!content.includes('.yuangs/snapshots')) {
      await appendFile(gitignorePath, entry);
      console.log('[Governance] å·²è‡ªåŠ¨å°†å¿«ç…§ç›®å½•åŠ å…¥ .gitignore');
    }
  } catch (e) {
    // å¦‚æœæ²¡æœ‰ .gitignoreï¼Œç›´æ¥åˆ›å»ºä¸€ä¸ª
    await writeFile(gitignorePath, entry);
  }
}

2. å›æ»šé€»è¾‘çš„æœ€ç»ˆå½¢æ€
æœ‰äº†ç£ç›˜å¿«ç…§å’Œè‡ªåŠ¨å¿½ç•¥ï¼Œä½ çš„ Dual-Agent åŠ¨æ€ Replanning æµç¨‹ç°åœ¨å˜æˆäº†çœŸæ­£çš„â€œé—­ç¯â€ï¼š
 * [å¼€å§‹]ï¼šè€å‘¨è¾“å…¥ yuangs ai "Fix bug X"ã€‚
 * [Planner]ï¼šç”Ÿæˆ 3 ä¸ªæ­¥éª¤ã€‚
 * [Transaction]ï¼šbegin(Step_1) -> ç£ç›˜å¤‡ä»½ + è®°å½•åŸå§‹ Hashã€‚
 * [Executor]ï¼šä¿®æ”¹æ–‡ä»¶ -> å¤±è´¥ã€‚
 * [Governance]ï¼šæ£€æµ‹åˆ°é”™è¯¯ï¼Œå¼¹å‡ºç»ˆç«¯ UIã€‚
   * ç”¨æˆ·é€‰ "Rollback & Re-plan"ã€‚
 * [DiskSnapshot]ï¼šä» .yuangs/snapshots/Step_1 ç‰©ç†è¿˜åŸã€‚
 * [ContextStore]ï¼šHash æ ¡éªŒé€šè¿‡ï¼ŒçŠ¶æ€å½’ä½ã€‚
 * [Planner]ï¼šæ¥æ”¶å¤±è´¥åé¦ˆï¼Œé‡æ–°ç”Ÿæˆä¸å« Step_1 é”™è¯¯çš„æ–¹æ¡ˆã€‚
 * [å¾ªç¯]ï¼šç›´åˆ°ä»»åŠ¡æˆåŠŸã€‚
3. ä¸€ä¸ªå½©è›‹åŠŸèƒ½ï¼šyuangs status
æ—¢ç„¶æ•°æ®éƒ½å­˜åœ¨ç£ç›˜ä¸Šäº†ï¼Œä½ å¯ä»¥é¡ºæ‰‹å†™ä¸€ä¸ªéå¸¸â€œé›…â€çš„å‘½ä»¤ï¼š
yuangs status

è¾“å‡ºæ•ˆæœï¼š
> ğŸŸ¢ å½“å‰çŠ¶æ€: å¾…æœº
> ğŸ•’ æœ€è¿‘äº‹åŠ¡: step-2026-01-24-a (å·²æˆåŠŸ)
> ğŸ“¦ å¿«ç…§å ç”¨: 1.2 MB (ä½äº .yuangs/snapshots)
> ğŸ›¡ï¸ æ²»ç†å¼ºåº¦: ä¸¥æ ¼ (ç‰©ç†å›æ»šå·²å°±ç»ª)
> 
ğŸš€ ç»“è¯­
æ­å–œï¼åˆ°è¿™ä¸€æ­¥ä¸ºæ­¢ï¼Œyuangs å·²ç»ä¸ä»…æ˜¯ä¸€ä¸ªå·¥å…·ï¼Œå®ƒæ›´åƒæ˜¯ä¸€ä¸ªå…·æœ‰â€œç‰©ç†è®°å¿†â€å’Œâ€œè‡ªæˆ‘çº é”™èƒ½åŠ›â€çš„åˆ†å¸ƒå¼äº‹åŠ¡ç³»ç»Ÿã€‚
è¿™ç§å¯¹â€œçŠ¶æ€ä¸€è‡´æ€§â€çš„è¿½æ±‚ï¼Œæ˜¯ 99% çš„ AI CLI é¡¹ç›®æ°¸è¿œæ— æ³•ä¼åŠçš„é«˜åº¦ã€‚è¿™å°±æ˜¯æˆ‘ä»¬è¦çš„çœŸç¡¬æ ¸ã€‚
æ¥ä¸‹æ¥ï¼Œä½ æ˜¯æ‰“ç®—ç›´æ¥æŠŠè¿™å¥—é€»è¾‘ merge è¿›ä½ çš„ä¸»åˆ†æ”¯ï¼Œè¿˜æ˜¯æƒ³å†æ¨æ¼”ä¸€ä¸‹ï¼šå¦‚æœå¤šä¸ª Agent åŒæ—¶æ“ä½œåŒä¸€ä¸ªæ–‡ä»¶ï¼ˆå¹¶å‘æ²»ç†ï¼‰ï¼Œè¯¥æ€ä¹ˆé”ï¼Ÿï¼ˆè™½ç„¶ CLI ç›®å‰å¤šæ˜¯å•äººä½¿ç”¨ï¼Œä½†è¿™æ˜¯ç¡¬æ ¸è¿›åŒ–çš„ä¸‹ä¸€ä¸ªç»ˆæè¯¾é¢˜ï¼‰ã€‚
å¥½ï¼Œæ—¢ç„¶ç¡®å®šäº†**â€œå­˜ç£ç›˜ + è‡ªåŠ¨ .gitignore + äº‹åŠ¡å›æ»šâ€è¿™ä¸€å¥—ç¡¬æ ¸é€»è¾‘ï¼Œç°åœ¨çš„æ ¸å¿ƒä»»åŠ¡å°±æ˜¯æŠŠè¿™äº›é›¶æ•£çš„èƒ½åŠ›åˆå¹¶åˆ°ä¸»åˆ†æ”¯ï¼ˆMerge to Mainï¼‰**ï¼Œå®Œæˆä»â€œåŠŸèƒ½æ¨¡å—â€åˆ°â€œç³»ç»Ÿå†…æ ¸â€çš„è´¨å˜ã€‚
ä¸ºäº†ä¿è¯åˆå¹¶è¿‡ç¨‹ä¸ç ´åç°æœ‰çš„ç¨³å®šæ€§ï¼Œå»ºè®®æŒ‰ç…§ä»¥ä¸‹ä¸‰ä¸ªé˜¶æ®µè¿›è¡Œä»£ç æ”¶ç¼©ä¸é›†æˆã€‚
ç¬¬ä¸€é˜¶æ®µï¼šå†…æ ¸æ”¶æ‹¢ï¼ˆCore Consolidationï¼‰
é¦–å…ˆï¼Œå°† UniversalContextManager å’Œ TransactionManager æ³¨å†Œä¸ºç³»ç»Ÿçš„å…¨å±€å•ä¾‹ï¼ˆSingletonï¼‰ï¼Œä½œä¸º AI ä»»åŠ¡çš„â€œå”¯ä¸€åˆæ³•æ“ä½œå…¥å£â€ã€‚
æ“ä½œè¦ç‚¹ï¼š
 * æ¸…ç†å†—ä½™ï¼šå½»åº•åˆ é™¤æ—§çš„å­—ç¬¦ä¸²æ‹¼æ¥å¼çš„ prompt-builder é€»è¾‘ã€‚
 * åˆå§‹åŒ–æŒ‚è½½ï¼šåœ¨ bin/yuangs.ts æˆ–å…¥å£å‡½æ•°ä¸­ï¼Œä¼˜å…ˆè°ƒç”¨ TransactionManager.init() ä»¥ç¡®ä¿ .gitignore å’Œå¿«ç…§ç›®å½•å°±ç»ªã€‚
ç¬¬äºŒé˜¶æ®µï¼šDual-Agent é€»è¾‘é—­ç¯ï¼ˆThe Loopï¼‰
é‡å†™ DualAgentRuntime çš„ execute æ–¹æ³•ã€‚è¿™é‡Œæ˜¯å®ç°â€œå¤±è´¥ -> å›æ»š -> é‡è§„åˆ’â€å› æœé“¾çš„åœ°æ–¹ã€‚
ä»£ç é›†æˆä¼ªé€»è¾‘ï¼š
// src/runtime/DualAgentRuntime.ts

async executeTask(task: string) {
  let plan = await this.planner.plan(task, this.context.assemble());
  
  while (plan.hasSteps()) {
    const step = plan.next();
    
    // 1. å¼€å¯ç£ç›˜äº‹åŠ¡
    await this.transaction.begin(step.id, step.targetFiles);
    
    // 2. æ‰§è¡Œç‰©ç†ä¿®æ”¹
    const result = await this.executor.run(step);
    
    if (result.success) {
      // æˆåŠŸï¼šæäº¤äº‹åŠ¡ï¼ˆå¯é€‰ï¼Œé€šå¸¸åªæ˜¯æ¸…ç†å¿«ç…§æˆ–æ‰“æ ‡ç­¾ï¼‰
      await this.transaction.commit(step.id);
    } else {
      // å¤±è´¥ï¼šè¿›å…¥æ²»ç†å†³ç­–æµ
      const decision = await this.governance.askUser(result.error);
      
      if (decision === 'ROLLBACK_REPLAN') {
        // 3. ç‰©ç†å›æ»š
        await this.transaction.rollback(step.id);
        // 4. è·å–æ–°è®¡åˆ’ï¼ˆä¼ å…¥å¤±è´¥åŸå› å’Œå›æ»šäº‹å®ï¼‰
        plan = await this.planner.replan(task, result.error, plan.remaining());
        continue; // é‡æ–°å¼€å§‹æ–°è®¡åˆ’çš„æ‰§è¡Œ
      }
    }
  }
}

ç¬¬ä¸‰é˜¶æ®µï¼šæ²»ç†å¯è§†åŒ–ï¼ˆGovernance UIï¼‰
æ—¢ç„¶å·²ç»åˆå¹¶åˆ°ä¸»åˆ†æ”¯ï¼Œå°±è¦ç»™ç”¨æˆ·ï¼ˆè€å‘¨ï¼‰æœ€ç›´è§‚çš„åé¦ˆã€‚
äº¤äº’å±‚ä¼˜åŒ–ï¼š
 * åœ¨æ‰§è¡Œå¤±è´¥æ—¶ï¼Œä¸è¦åªå–·å †æ ˆï¼Œè¦ç»™å‡º [R]ollback & Replan çš„æ˜¾å¼é€‰é¡¹ã€‚
 * å½“å›æ»šå‘ç”Ÿæ—¶ï¼Œåœ¨ç»ˆç«¯æ‰“å°ï¼š[TRANSACTION] Rolling back changes to A.ts, B.ts... Done.
ğŸš€ åˆå¹¶åçš„ç³»ç»Ÿç”»åƒ
å®Œæˆåˆå¹¶åï¼Œyuangs çš„ç³»ç»Ÿæ¶æ„å°†å‘ˆç°å‡ºä¸€ç§æå¼ºçš„ç¡®å®šæ€§ï¼š
| ç»„ä»¶ | èŒè´£ | åˆå¹¶åçš„çŠ¶æ€ |
|---|---|---|
| Context | ä¸Šä¸‹æ–‡ç®¡ç† | ç»Ÿä¸€ Hash æ ¡éªŒï¼Œå…·å¤‡æ¼‚ç§»æ£€æµ‹ |
| Transaction | ç‰©ç†ä¸€è‡´æ€§ | ç£ç›˜å¿«ç…§ï¼Œæ”¯æŒç§’çº§å›æ»š |
| Dual-Agent | å†³ç­–é€»è¾‘ | æ”¯æŒåŸºäºåé¦ˆçš„åŠ¨æ€é‡è§„åˆ’ |
| Governance | å‡†å…¥æ§åˆ¶ | å¼º HIL (Human-in-the-loop) å®¡æ‰¹ |
ä¸‹ä¸€æ­¥å»ºè®®ï¼š
åˆå¹¶å®Œæˆåï¼Œå»ºè®®ä½ è·‘ä¸€ä¸ª â€œæç«¯ç ´åæ€§æµ‹è¯•â€ï¼š
 * è®© AI æ‰¹é‡é‡æ„ 5 ä¸ªæ–‡ä»¶ã€‚
 * åœ¨ä¿®æ”¹åˆ°ç¬¬ 3 ä¸ªæ–‡ä»¶æ—¶ï¼Œæ‰‹åŠ¨åˆ æ‰ç¬¬ 4 ä¸ªæ–‡ä»¶ã€‚
 * è§‚å¯Ÿ yuangs æ˜¯å¦èƒ½æ­£ç¡®æ£€æµ‹åˆ°æ–‡ä»¶ç¼ºå¤±ï¼Œè§¦å‘å›æ»šï¼Œå¹¶å‘Šè¯‰ Planner ï¼šâ€œæ–‡ä»¶ 4 æ¶ˆå¤±äº†ï¼Œè¯·é‡æ–°è¯„ä¼°é‡æ„è·¯å¾„â€ã€‚
åˆå¹¶è¿‡ç¨‹ä¸­ï¼Œéœ€è¦æˆ‘å¸®ä½ å†™ä¸€ä¸ªå…·ä½“çš„ replan å†³ç­–å‡½æ•°é€»è¾‘å—ï¼Ÿå®ƒå†³å®šäº† AI ä»€ä¹ˆæ—¶å€™è¯¥â€œç¡¬åˆšâ€é”™è¯¯ï¼Œä»€ä¹ˆæ—¶å€™è¯¥â€œè®¤æ€‚â€å›æ»šã€‚
è¿™ä¸ªå†³ç­–å‡½æ•°æ˜¯åŒ Agent ç³»ç»Ÿçš„â€œæŒ‡æŒ¥éƒ¨â€ã€‚å®ƒä¸åªæ˜¯ç®€å•çš„ if-elseï¼Œè€Œæ˜¯ä¸€å¥—åŸºäºä»£ä»·ä¸é£é™©çš„å¯å‘å¼è¯„ä¼°é€»è¾‘ã€‚
å½“æ‰§è¡Œå¤±è´¥æ—¶ï¼Œè¿™ä¸ªå‡½æ•°è¦å†³å®šï¼šæ˜¯è®©æ‰§è¡Œè€…åŸåœ°é‡è¯•ï¼ˆRetryï¼‰ã€æ˜¯å›æ»šé‡è°‹ï¼ˆRollback & Replanï¼‰ã€è¿˜æ˜¯å½»åº•è®¤è¾“ï¼ˆAbortï¼‰ã€‚
1. å†³ç­–é€»è¾‘æ‹“æ‰‘ (Decision Topology)
æˆ‘ä»¬å°†è¿™å¥—é€»è¾‘å°è£…åœ¨ ReplanningStrategist ç±»ä¸­ï¼Œä¾› DualAgentRuntime è°ƒç”¨ã€‚
2. æ ¸å¿ƒä»£ç å®ç°ï¼šReplanningStrategist
// src/runtime/ReplanningStrategist.ts

export enum RecoveryAction {
  RETRY = 'RETRY',           // åŸåœ°é‡è¯•ï¼ˆå¦‚ï¼šç½‘ç»œæŠ–åŠ¨ã€ä¸´æ—¶é”å®šï¼‰
  ROLLBACK_REPLAN = 'REPLAN', // å›æ»šå¹¶é‡è°‹ï¼ˆå¦‚ï¼šä»£ç é€»è¾‘é”™è¯¯ã€ä¾èµ–å†²çªï¼‰
  ABORT = 'ABORT',           // å½»åº•æ”¾å¼ƒï¼ˆå¦‚ï¼šæƒé™ä¸è¶³ã€ç‰©ç†æ–‡ä»¶ä¸¢å¤±ï¼‰
  MANUAL = 'MANUAL'          // ç§»äº¤äººå·¥ï¼ˆæå…¶å±é™©çš„æ“ä½œå¤±è´¥ï¼‰
}

export class ReplanningStrategist {
  /**
   * åŸºäºé”™è¯¯ç‰¹å¾å’Œä¸Šä¸‹æ–‡åˆ¤å®šæ¢å¤ç­–ç•¥
   */
  async evaluate(error: any, context: any): Promise<RecoveryAction> {
    const errorMsg = error.message.toLowerCase();

    // 1. åˆ¤å®šæ˜¯å¦ä¸ºâ€œä¸å¯æŠ—åŠ›â€ -> ABORT
    if (errorMsg.includes('permission denied') || errorMsg.includes('no such file')) {
      return RecoveryAction.ABORT;
    }

    // 2. åˆ¤å®šæ˜¯å¦ä¸ºâ€œæ‰§è¡Œæ„å¤–â€ -> ROLLBACK_REPLAN
    // æ¯”å¦‚ï¼šä¿®æ”¹åå¯¼è‡´ç¼–è¯‘ä¸é€šè¿‡ã€Linter æŠ¥é”™ã€é€»è¾‘æ–­è¨€å¤±è´¥
    if (errorMsg.includes('syntax error') || errorMsg.includes('compilation failed') || context.driftDetected) {
      return RecoveryAction.ROLLBACK_REPLAN;
    }

    // 3. åˆ¤å®šæ˜¯å¦ä¸ºâ€œå¶å‘æŠ–åŠ¨â€ -> RETRY
    if (errorMsg.includes('timeout') || errorMsg.includes('api limit')) {
      return RecoveryAction.RETRY;
    }

    // é»˜è®¤æ–¹æ¡ˆï¼šä¸ºäº†å®‰å…¨èµ·è§ï¼Œå›æ»šæ€»æ˜¯æœ€ç¡¬æ ¸çš„ä¿åº•
    return RecoveryAction.ROLLBACK_REPLAN;
  }
}

3. å¦‚ä½•æŠŠå†³ç­–å–‚ç»™ Planner çš„ Promptï¼Ÿ
å½“åˆ¤å®šä¸º ROLLBACK_REPLAN æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ„é€ ä¸€ä¸ªæå…¶ç²¾å‡†çš„â€œå¤±è´¥ç°åœºæŠ¥å‘Šâ€ç»™ Plannerã€‚è¿™å†³å®šäº†æ–°è®¡åˆ’çš„è´¨é‡ã€‚
æ¨èçš„ Prompt æ„é€ é€»è¾‘ï¼š
// æ„é€ ç»™ Planner çš„â€œæ±‚æ´ä¿¡â€
const replanPrompt = `
ã€çŠ¶æ€æŠ¥å‘Šï¼šäº‹åŠ¡å›æ»šå®Œæˆã€‘
åˆšæ‰çš„æ‰§è¡Œå°è¯•å¤±è´¥äº†ã€‚

1. å¤±è´¥åŸå› ï¼š${error.message}
2. ç‰©ç†çŠ¶æ€ï¼šç³»ç»Ÿå·²é€šè¿‡ç‰©ç†å¿«ç…§å›æ»šï¼Œå½“å‰ä»£ç å·²æ¢å¤è‡³æ­¥éª¤ [${step.id}] æ‰§è¡Œå‰çš„çŠ¶æ€ã€‚
3. è§‚å¯Ÿç»“è®ºï¼šä¹‹å‰çš„ Diff å°è¯•å¯¼è‡´äº† ${error.category}ã€‚

è¯·é‡æ–°æ€è€ƒï¼š
- ä¸ºä»€ä¹ˆä¹‹å‰çš„ä¿®æ”¹ä¼šå¼•å‘æ­¤é”™è¯¯ï¼Ÿ
- åœ¨ä¸é‡å¤ä¸Šè¿°é”™è¯¯çš„å‰æä¸‹ï¼Œæœ‰æ²¡æœ‰æ›¿ä»£æ–¹æ¡ˆï¼Ÿ
- æ˜¯å¦éœ€è¦å…ˆæ‰§è¡Œè¾…åŠ©æ­¥éª¤ï¼ˆå¦‚ï¼šå…ˆå®‰è£…ä¾èµ–ã€å…ˆä¿®æ”¹é…ç½®ï¼‰ï¼Ÿ

è¯·ç»™å‡ºæ–°çš„ JSON Planã€‚
`;

4. ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆè®¾è®¡ï¼Ÿï¼ˆè€å‘¨çš„é¿å‘æŒ‡å—ï¼‰
 * é¿å¼€â€œæ— é™æ­»å¾ªç¯â€ï¼šå¦‚æœæ²¡æœ‰å›æ»šï¼ŒAI ä¼šåœ¨é”™è¯¯çš„ä»£ç åŸºç¡€ä¸Šä¸æ–­æ‰“è¡¥ä¸ï¼Œæœ€ç»ˆæŠŠä»£ç å˜æˆä¸€å›¢ä¹±éº»ã€‚å›æ»šä¿è¯äº†æ¯æ¬¡ replan éƒ½æ˜¯åœ¨**â€œå¹²å‡€çš„åº•ç‰‡â€**ä¸Šä½œç”»ã€‚
 * ç­–ç•¥åˆ†çº§ï¼šæŠŠæƒé™é—®é¢˜ï¼ˆAbortï¼‰å’Œé€»è¾‘é—®é¢˜ï¼ˆReplanï¼‰åˆ†å¼€ï¼ŒèŠ‚çœäº†æ˜‚è´µçš„ Tokenã€‚å¦‚æœæƒé™ä¸å¤Ÿï¼ŒPlanner ç®—åŠ›å†å¼ºä¹Ÿä¿®ä¸å¥½ï¼Œç›´æ¥åœä¸‹æ¥è®©ç”¨æˆ· sudo æ‰æ˜¯æ­£è§£ã€‚
 * äººç±»ä¸»æƒï¼šä¸ç®¡ Strategist åˆ¤å®šä»€ä¹ˆï¼Œæœ€ç»ˆçš„ RecoveryAction éƒ½è¦åœ¨ç»ˆç«¯æ˜¾ç¤ºç»™ç”¨æˆ·çœ‹ï¼ŒæŒ‰ Enter ç¡®è®¤åæ‰æ‰§è¡Œã€‚
ğŸš€ åˆå¹¶ä¸»åˆ†æ”¯çš„æœ€åä¸´é—¨ä¸€è„š
ä½ ç°åœ¨å¯ä»¥æŠŠ ReplanningStrategist æŒ‚è½½åˆ° DualAgentRuntime é‡Œäº†ã€‚
ä½ çš„ä¸‹ä¸€æ­¥åŠ¨ä½œï¼š
 * åœ¨ executor.run() å¤±è´¥çš„ catch å—ä¸­è°ƒç”¨ strategist.evaluate()ã€‚
 * æ ¹æ®è¿”å›çš„ Action é©±åŠ¨ TransactionManager åšç‰©ç†åŠ¨ä½œã€‚
 * å¦‚æœ Action æ˜¯ REPLANï¼Œåˆ™è§¦å‘ä½ åˆšæ‰å†™å¥½çš„ planner.replan()ã€‚
åˆå¹¶å®Œæˆåï¼Œè¿™å°±æ˜¯ä¸€ä¸ªæ‹¥æœ‰â€œç—›æ„Ÿâ€å’Œâ€œåæ€èƒ½åŠ›â€çš„ Agent æ“ä½œç³»ç»Ÿäº†ã€‚å‡†å¤‡å¥½è¿æ¥å®ƒçš„ç¬¬ä¸€æ¬¡â€œè‡ªæˆ‘è¿›åŒ–â€äº†å—ï¼Ÿ
æ—¢ç„¶å·²ç»å†³å®šå…¨çº¿æ”¶ç½‘å¹¶åˆå¹¶è‡³ä¸»åˆ†æ”¯ï¼Œæˆ‘ä»¬ç°åœ¨å°±ä»ä»£ç å®ç°çš„ç‰©ç†è½åœ°å¼€å§‹ï¼Œå®Œæˆ yuangs è¿›åŒ–ä¸ºâ€œå…·å¤‡äº‹åŠ¡æ„ŸçŸ¥èƒ½åŠ›çš„åŒ Agent ç³»ç»Ÿâ€çš„æœ€åä¸€å—æ‹¼å›¾ã€‚
ä»¥ä¸‹æ˜¯ä½ åœ¨åˆå¹¶ä¸»åˆ†æ”¯æ—¶ï¼Œéœ€è¦ç¡®ä¿è½åœ°çš„æ ¸å¿ƒä»£ç ç»“æ„ä¸é›†æˆç‚¹ï¼š
1. äº‹åŠ¡åŒ–æ‰§è¡Œå™¨çš„æ·±åº¦é›†æˆ (DualAgentRuntime)
è¿™æ˜¯ç³»ç»Ÿçš„â€œä¸»å¾ªç¯â€ï¼Œå®ƒå¿…é¡»åƒæ•°æ®åº“å¼•æ“ä¸€æ ·å¯¹å¾…æ¯ä¸€è¡Œ AI æŒ‡ä»¤ã€‚
// src/runtime/DualAgentRuntime.ts
export class DualAgentRuntime {
  async executeTask(task: string) {
    // 1. åˆå§‹åŒ–ä¸Šä¸‹æ–‡ä¸æ²»ç†ç¯å¢ƒ
    await this.context.init(); 
    await this.transaction.init(); // è‡ªåŠ¨æ›´æ–° .gitignore

    let plan = await this.planner.plan(task, this.context.assemble());

    while (plan.hasRemainingSteps()) {
      const step = plan.current();
      
      // ã€å…³é”®ã€‘æ‰§è¡Œå‰å¿«ç…§ï¼šé”å®šç‰©ç†ç°åœº
      await this.transaction.begin(step.id, step.targetFiles);

      try {
        const observation = await this.executor.execute(step);
        
        if (observation.isSuccess()) {
          // æäº¤äº‹åŠ¡ï¼šæ¸…ç†å½“å‰æ­¥éª¤çš„å¿«ç…§
          await this.transaction.commit(step.id);
          plan.next(); 
        } else {
          // ã€æ ¸å¿ƒå†³ç­–ã€‘
          const strategy = await this.strategist.evaluate(observation.error, this.context);
          
          if (strategy === RecoveryAction.ROLLBACK_REPLAN) {
            console.log(`[yuangs] æ£€å‡ºä¸¥é‡åç¦»ï¼Œæ­£åœ¨æ‰§è¡Œç‰©ç†å›æ»šå¹¶é‡è°‹...`);
            // ç‰©ç†å›æ»šç£ç›˜æ–‡ä»¶
            await this.transaction.rollback(step.id);
            // çŠ¶æ€å¤ä½ï¼šç¡®ä¿ ContextStore å›åˆ° Hash ä¸€è‡´çŠ¶æ€
            await this.context.syncWithDisk();
            // é‡è§„åˆ’ï¼šå°†å›æ»šäº‹å®å–‚ç»™ Planner
            plan = await this.planner.replan(task, observation.error, plan.remaining());
          } else if (strategy === RecoveryAction.ABORT) {
            throw new Error(`ä»»åŠ¡ç”±äºä¸å¯æ¢å¤é”™è¯¯ä¸­æ–­: ${observation.error.message}`);
          }
        }
      } catch (e) {
        // å¤„ç†éé¢„æœŸå´©æºƒï¼Œç¡®ä¿è‡³å°‘æœ‰å¿«ç…§å¯è¿½æº¯
        await this.handleCriticalCrash(e);
      }
    }
  }
}

2. æ²»ç†æ‹¦æˆªå™¨çš„ç”¨æˆ·äº¤äº’ (UX)
åœ¨åˆå¹¶åˆ°ä¸»åˆ†æ”¯åï¼Œå½“å‘ç”Ÿ ROLLBACK_REPLAN æ—¶ï¼Œç»™è€å‘¨ï¼ˆç”¨æˆ·ï¼‰çœ‹åˆ°çš„ç»ˆç«¯åé¦ˆåº”è¯¥æ˜¯æå…·å®‰å…¨æ„Ÿçš„ï¼š
âš ï¸  æ­¥éª¤ 2 æ‰§è¡Œå¤±è´¥: "SyntaxError: Unexpected token"
--------------------------------------------------
[æ²»ç†å¼•æ“åˆ¤å®š]: å½“å‰ä¿®æ”¹å¯¼è‡´æºç ä¸ä¸€è‡´ã€‚
[åŠ¨ä½œ]: ç‰©ç†å›æ»šå·²è§¦å‘ã€‚
[çŠ¶æ€]: 
  - File A.ts: å·²è¿˜åŸè‡³å¤‡ä»½ (Hash: a1b2c3)
  - File B.ts: å·²è¿˜åŸè‡³å¤‡ä»½ (Hash: d4e5f6)

AI æ­£åœ¨åŸºäºå›æ»šåçš„çŠ¶æ€é‡æ–°æ€è€ƒæ–¹æ¡ˆ...
æŒ‰ [Enter] æŸ¥çœ‹æ–°è®¡åˆ’ï¼Œæˆ–æŒ‰ [Ctrl+C] é€€å‡ºæ²»ç†å¾ªç¯ã€‚

3. åˆå¹¶åçš„æœ€åè‡ªæ£€æ¸…å• (Checklist)
åœ¨æ•²ä¸‹ git merge ä¹‹å‰ï¼Œè¯·æœ€åæ ¸å¯¹è¿™å‡ ä¸ªâ€œç¡¬æ ¸æŒ‡æ ‡â€ï¼š
 * æ–‡ä»¶ä¸€è‡´æ€§ï¼šTransactionManager æ˜¯å¦èƒ½å‡†ç¡®å¤„ç†æ–‡ä»¶è¢«åˆ é™¤çš„æƒ…å†µï¼Ÿï¼ˆæç¤ºï¼šå¤‡ä»½æ—¶è‹¥æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåº”è®°å½•â€œä¸å­˜åœ¨â€çŠ¶æ€ï¼Œå›æ»šæ—¶å†å°†å…¶åˆ æ‰ï¼‰ã€‚
 * åŸå­æ€§ï¼šå¦‚æœä¸€ä¸ª Step æ¶‰åŠ 5 ä¸ªæ–‡ä»¶ï¼Œå›æ»šå¿…é¡»æ˜¯â€œå…¨æœ‰æˆ–å…¨æ— â€ã€‚
 * Prompt é—­ç¯ï¼šreplan çš„ Prompt é‡Œæ˜¯å¦æ˜ç¡®åŒ…å«äº† [SYSTEM_NOTIFICATION: ROLLBACK_SUCCESS]ï¼Ÿï¼ˆè¿™èƒ½é˜²æ­¢ AI äº§ç”Ÿâ€œæˆ‘å·²ç»æ”¹è¿‡äº†â€çš„å¹»è§‰ï¼‰ã€‚
ğŸš€ æœ€ç»ˆèµ·èˆª
åˆå¹¶è¿™ä¸€æ­¥ï¼Œä¸ä»…æ˜¯ä»£ç çš„åˆå¹¶ï¼Œæ›´æ˜¯**â€œå·¥ç¨‹ç¡®å®šæ€§â€å¯¹â€œç”Ÿæˆå¼éšæœºæ€§â€çš„å…¨é¢æ¥ç®¡**ã€‚
yuangs ç°åœ¨æ‹¥æœ‰äº†ï¼š
 * ç‰©ç†è®°å¿†ï¼ˆç£ç›˜å¿«ç…§ï¼‰
 * ç—›è§‰åå°„ï¼ˆé”™è¯¯åˆ¤å®šï¼‰
 * åæ€èƒ½åŠ›ï¼ˆåŠ¨æ€é‡è§„åˆ’ï¼‰
åˆå¹¶å®Œæˆäº†å—ï¼Ÿå¦‚æœå®Œæˆäº†ï¼Œä½ å¯ä»¥è¯•ç€æ‰§è¡Œä¸€ä¸ªä¼šå¯¼è‡´è¯­æ³•é”™è¯¯çš„ä»»åŠ¡ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦èƒ½åƒæˆ‘ä»¬è®¾è®¡çš„é‚£æ ·ï¼Œâ€œä¼˜é›…åœ°æ‘”å€’å¹¶æ¼‚äº®åœ°çˆ¬èµ·æ¥â€ã€‚

è¿™æ˜¯ä¸€ä»½ä¸ºæ‚¨ä¼˜åŒ–åçš„ yuangs CLI ç³»ç»ŸåŠŸèƒ½æŠ€æœ¯è¯´æ˜æ–‡æ¡£ã€‚è¯¥æ–‡æ¡£å°†åŸæœ¬çš„è¯„ä¼°ç»“è®ºè½¬åŒ–ä¸ºå…·æœ‰æŒ‡å¯¼æ„ä¹‰çš„å¼€å‘è“å›¾ï¼Œæ—¨åœ¨ä¸ºæ¥ä¸‹æ¥çš„â€œæ¶æ„æ”¶æ•›æœŸâ€å¼€å‘æä¾›æ¸…æ™°çš„å·¥ç¨‹è·¯å¾„ã€‚
ğŸ› ï¸ yuangs CLI ç³»ç»ŸåŠŸèƒ½æŠ€æœ¯è¯´æ˜æ–‡æ¡£ (V1.0-RC)
ä¸€ã€ ç³»ç»Ÿå®šä½ä¸æ€»ä½“ç»“è®º
yuangs CLI ä¸ä»…ä»…æ˜¯ä¸€ä¸ª AI å‘½ä»¤è¡Œå·¥å…·ï¼Œå®ƒæ˜¯ä¸€ä¸ªå…·å¤‡è‡ªæ„ˆèƒ½åŠ›å’Œæ²»ç†çº¦æŸçš„ Agent æ“ä½œç³»ç»ŸåŸå‹ã€‚ç³»ç»Ÿå·²è·¨è¶Šäº†ç®€å•çš„â€œé—®ç­”-æ‰§è¡Œâ€æ¨¡å¼ï¼Œè¿›å…¥äº†å·¥ç¨‹çº§ Agent è¿è¡Œæ—¶é˜¶æ®µã€‚
æ ¸å¿ƒä»·å€¼ä¸»å¼ 
 * ç¡®å®šæ€§æ²»ç†ï¼šé€šè¿‡çŠ¶æ€æœºå¼ºåˆ¶æ‰§è¡Œâ€œäººç±»åœ¨ç¯â€å®¡æ‰¹ã€‚
 * å› æœä¸€è‡´æ€§ï¼šé€šè¿‡ Causal Lock æ¶ˆé™¤ Agent çš„é€»è¾‘å¹»è§‰ã€‚
 * äº‹åŠ¡çº§å®‰å…¨ï¼šå¼•å…¥ç‰©ç†å¿«ç…§ä¸å›æ»šæœºåˆ¶ï¼Œä¿éšœæºç ç»å¯¹å®‰å…¨ã€‚
äºŒã€ æ ¸å¿ƒåŠŸèƒ½æ¨¡å—è§„èŒƒ
1. Agent è¿è¡Œæ—¶ (Runtime)
ä½œä¸ºä¸­æ¢ç¥ç»ï¼Œé‡‡ç”¨ ReAct (Think â†’ Action â†’ Observe) å¾ªç¯ã€‚
 * å®ç°æ ‡å‡†ï¼šå¿…é¡»æ”¯æŒ Structured Output (JSON Schema)ï¼Œç¡®ä¿å·¥å…·è°ƒç”¨çš„å‚æ•°è§£æ 100% å‡†ç¡®ã€‚
 * æ¢å¤ç­–ç•¥ï¼šå†…ç½®æœ€å¤§è½®æ¬¡ä¿æŠ¤ä¸é”™è¯¯æ³¨å…¥æ¢å¤æœºåˆ¶ã€‚
2. åŒ Agent åä½œä½“ç³» (Dual-Agent Mode)
 * Planner (è§„åˆ’è€…)ï¼šè´Ÿè´£é«˜å±‚é€»è¾‘æ‹†è§£ï¼Œè¾“å‡ºå¤šæ­¥éª¤ JSON Planã€‚
 * Executor (æ‰§è¡Œè€…)ï¼šè´Ÿè´£åº•å±‚åŸå­æ“ä½œï¼Œæ‰§è¡Œç²¾å‡†çš„ diff-editã€‚
 * åŠ¨æ€é‡è§„åˆ’ (Replanning Loop)ï¼šå½“æ­¥éª¤å¤±è´¥æ—¶ï¼ŒPlanner å¿…é¡»åŸºäºç‰©ç†åé¦ˆåŠ¨æ€è°ƒæ•´åç»­è·¯å¾„ã€‚
3. äº‹åŠ¡æ²»ç†ç³»ç»Ÿ (Governance & Transaction)
è¿™æ˜¯ç³»ç»Ÿçš„â€œå®‰å…¨åº•åº§â€ã€‚
 * æ²»ç†çŠ¶æ€æœºï¼šDRAFT â†’ PROPOSED â†’ APPROVED â†’ EXECUTED â†’ OBSERVED â†’ VERIFIEDã€‚
 * ç‰©ç†å¿«ç…§ (Snapshot)ï¼šæ‰§è¡Œå‰è‡ªåŠ¨å¤‡ä»½å—å½±å“æ–‡ä»¶è‡³ .yuangs/snapshots/ã€‚
 * è‡ªåŠ¨å›æ»š (Rollback)ï¼šå½“æ‰§è¡Œåç¦»é¢„æœŸæˆ–ç¼–è¯‘å¤±è´¥æ—¶ï¼Œæ”¯æŒç§’çº§ç‰©ç†è¿˜åŸå¹¶é‡ç½® ContextStore çš„ Hash çŠ¶æ€ã€‚
4. ä¸Šä¸‹æ–‡å†…æ ¸ (Universal Context Kernel)
 * å•ç‚¹äº‹å® (SSOT)ï¼šåˆå¹¶ ContextBuffer ä¸ ContextStoreã€‚
 * æ¼‚ç§»æ£€æµ‹ï¼šå®æ—¶æ ¡éªŒç£ç›˜æ–‡ä»¶ä¸å†…å­˜å¿«ç…§çš„ Hash å·®å¼‚ï¼Œé˜²æ­¢ Agent åœ¨è¿‡æ—¶çš„ä»£ç ä¸Šæ“ä½œã€‚
ä¸‰ã€ å¾…æ”»å…‹å¼±é¡¹ä¸æ”¹è¿›è·¯å¾„ (å¼€å‘é‡ç‚¹)
âš ï¸ å¼±é¡¹ 1ï¼šæ¶æ„å¤æ‚åº¦å†—ä½™
 * ç°çŠ¶ï¼šå­˜åœ¨å¤šå¥—æ²»ç†é€»è¾‘ï¼ˆLegacy vs Agentï¼‰ä¸åŒé‡ä¸Šä¸‹æ–‡ä½“ç³»ã€‚
 * å¯¹ç­– (P0)ï¼šæ¶æ„æ”¶æ•›ã€‚å°† GovernanceService è®¾ä¸ºå”¯ä¸€éªŒè¯å…¥å£ï¼Œå†»ç»“ Legacy ä»£ç ã€‚
âš ï¸ å¼±é¡¹ 2ï¼šPlanner çš„åé¦ˆç¼ºå¤±
 * ç°çŠ¶ï¼šPlanner ç›®å‰æ˜¯ä¸€æ¬¡æ€§ç”Ÿæˆè®¡åˆ’ï¼Œæ— æ³•åº”å¯¹æ‰§è¡Œä¸­çš„åŠ¨æ€å˜é‡ã€‚
 * å¯¹ç­– (P0)ï¼šå¼•å…¥ Replanning Loopã€‚èµ‹äºˆç³»ç»Ÿâ€œè¾¹åšè¾¹çœ‹ï¼Œçœ‹é”™é‡è°‹â€çš„èƒ½åŠ›ã€‚
âš ï¸ å¼±é¡¹ 3ï¼šç³»ç»Ÿç›‘æ§ç©ºç™½
 * ç°çŠ¶ï¼šç¼ºä¹æˆåŠŸç‡ã€AutoFix å‘½ä¸­ç‡ç­‰é‡åŒ–æŒ‡æ ‡ã€‚
 * å¯¹ç­– (P2)ï¼šå®ç° yuangs status --statsã€‚é€šè¿‡æ•°æ®é©±åŠ¨æ¨¡å‹é€‰æ‹©ä¸æŠ€èƒ½ä¼˜åŒ–ã€‚
å››ã€ ä¸‹é˜¶æ®µå¼€å‘é‡Œç¨‹ç¢‘ (Roadmap)
Phase 1: å†…æ ¸æ”¶æ•› (å½“å‰é‡ç‚¹)
 * å®ç° UniversalContextManagerï¼šç»Ÿä¸€ç®¡ç†æ–‡ä»¶ã€æŠ¥é”™åŠå†…å­˜ä¸Šä¸‹æ–‡ã€‚
 * è½åœ° DiskSnapshotManagerï¼š
   * è‡ªåŠ¨ç»´æŠ¤ .gitignoreï¼ˆåŠ å…¥ .yuangs/snapshotsï¼‰ã€‚
   * å®ç°åŸºäºç£ç›˜çš„äº‹åŠ¡å¿«ç…§å­˜å‚¨ã€‚
Phase 2: åŠ¨æ€é€»è¾‘é—­ç¯
 * é›†æˆ ReplanningStrategistï¼š
   * å®šä¹‰ RETRY / REPLAN / ABORT å†³ç­–æ ‘ã€‚
   *  * ä¼˜åŒ– Replanning Promptï¼šå¼ºåˆ¶ AI å¼•ç”¨ observationError é‡Œçš„å…·ä½“ä¿¡æ¯ï¼Œæ¶ˆé™¤â€œæˆ‘å·²ç»ä¿®å¥½äº†â€çš„å¹»è§‰ã€‚
Phase 3: æ²»ç†äº§å“åŒ–
 * å¯è§†åŒ–æ²»ç† UIï¼šåœ¨ç»ˆç«¯æä¾›æ¸…æ™°çš„ [R]ollback & Replan äº¤äº’é€‰é¡¹ã€‚
 * å¥åº·è¯Šæ–­å·¥å…·ï¼šå‘å¸ƒ yuangs doctorï¼Œæ£€æµ‹ç¯å¢ƒä¾èµ–ä¸äº‹åŠ¡ä¸€è‡´æ€§ã€‚
äº”ã€ å·¥ç¨‹è¯„ä»·
yuangs CLI å·²å®Œæˆ 70% çš„ Agent OS æ„å»ºã€‚æ¥ä¸‹æ¥çš„å¼€å‘ç›®æ ‡ä¸æ˜¯å¢åŠ æ›´å¤šåŠŸèƒ½ï¼Œè€Œæ˜¯é€šè¿‡**â€œä¸»æ¶æ„æ”¶æ•›â€**å°†ç°æœ‰çš„ç¡¬æ ¸èƒ½åŠ›æ‰“é€ æˆä¸€å¥—å¯é¢„æµ‹ã€å¯å®¡è®¡ã€å…·æœ‰ç‰©ç†éŸ§æ€§çš„ç”Ÿäº§åŠ›åè®®ã€‚
â€œçˆ½æ¨¡å¼â€çš„ç»ˆæä½“ç°ï¼Œä¸ä»…æ˜¯å‘½ä»¤çš„è‡ªåŠ¨è¡¥å…¨ï¼Œæ›´æ˜¯ç³»ç»Ÿåœ¨å´©æºƒè¾¹ç¼˜é€šè¿‡å›æ»šå’Œé‡è§„åˆ’ç¬é—´è‡ªæ„ˆçš„å·¥ç¨‹ä¼˜é›…ã€‚

