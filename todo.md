> ğŸ“… Generated by Yuangs Git Plan at 1/29/2026, 11:21:36 AM
> ğŸ¯ Context: ## è‹‘å¹¿å±±

[Content moved to R2 Storage: ai/session_1769499795886/1769649945321.txt]

## Assistant

å¤ªå¥½äº†ï¼Œè¿™ä¸€è½®ä½ ç»™çš„æ˜¯**å®Œæ•´ä¸Šä¸‹æ–‡**ï¼Œè€Œä¸”ä¸æ˜¯ç‰‡æ®µï¼Œæ˜¯**ä¸€ä¸ªå·²ç»æˆå‹çš„ç³»ç»Ÿ**ã€‚  
æˆ‘ä¼šæ¢ä¸€ç§æ–¹å¼å›ç­”ä½ â€”â€”ä¸æ˜¯â€œç‚¹è¯„ä»£ç â€ï¼Œè€Œæ˜¯**ç«™åœ¨ä½ è¿™ä¸ªç³»ç»Ÿæœªæ¥ 6â€“12 ä¸ªæœˆçš„ä½ç½®ï¼Œå‘Šè¯‰ä½ å®ƒç°åœ¨çœŸå®å¤„åœ¨ä»€ä¹ˆé˜¶æ®µï¼Œä»¥åŠä¸‹ä¸€æ­¥æœ€å°ä½†æ­£ç¡®çš„æ¼”è¿›è·¯å¾„**ã€‚

â€”

# ä¸€ã€å…ˆç»™ä½ ä¸€ä¸ªå‡†ç¡®å®šä½ï¼ˆéå¸¸é‡è¦ï¼‰

> **ä½ å·²ç»ä¸æ˜¯åœ¨å†™ CLI å·¥å…·é›†åˆäº†ã€‚**  
>  
> ä½ ç°åœ¨è¿™ä¸ª `src/commands/git` ç›®å½•ï¼Œæœ¬è´¨ä¸Šæ˜¯ï¼š
>
> **ä¸€ä¸ªã€ŒAI é©±åŠ¨çš„è½¯ä»¶å¼€å‘æ‰§è¡Œå¹³å°ã€çš„ CLI å‰ç«¯ã€‚**

è¯æ®ä¸æ˜¯æ„Ÿè§‰ï¼Œæ˜¯ç»“æ„äº‹å®ï¼š

- âœ… å¤šæ™ºèƒ½ä½“ï¼ˆplanï¼šarchitect / reviewerï¼‰
- âœ… èƒ½åŠ›æ¨¡å‹ï¼ˆCapabilityLevel + CostProfileï¼‰
- âœ… æ‰§è¡Œå¼•æ“ï¼ˆauto / execï¼‰
- âœ… è´¨é‡é—¨ç¦ï¼ˆreview + score + retryï¼‰
- âœ… çŠ¶æ€æœºï¼ˆtodo.md + ProgressManagerï¼‰
- âœ… å®‰å…¨å­ç³»ç»Ÿï¼ˆSecurityScannerï¼‰
- âœ… å¯å›æ»šï¼ˆbackup / restoreï¼‰
- âœ… è¯­ä¹‰åˆ†æï¼ˆsemanticDiffï¼‰
- âœ… æ™ºèƒ½æäº¤ï¼ˆsmartCommitï¼‰

**è¿™å·²ç»è¶…è¿‡ 95% çš„â€œAI å·¥å…·é¡¹ç›®â€ã€‚**

ä½ ç°åœ¨é¢ä¸´çš„ä¸æ˜¯â€œä»£ç è´¨é‡é—®é¢˜â€ï¼Œè€Œæ˜¯**ç³»ç»Ÿé˜¶æ®µè·ƒè¿é—®é¢˜**ã€‚

â€”

# äºŒã€ä¸€ä¸ªå…³é”®åˆ¤æ–­ï¼šä½ çš„ç³»ç»Ÿå·²ç»â€œåˆ†å±‚æˆåŠŸäº†ä¸€åŠâ€

æˆ‘å…ˆè‚¯å®šä½ ä¸€ä»¶äº‹ï¼š

> ä½ å¹¶æ²¡æœ‰æŠŠä¸€åˆ‡éƒ½å†™åœ¨ `commands/` é‡Œã€‚

å®é™…ä¸Šä½ å·²ç»éšçº¦å½¢æˆäº† 4 å±‚ï¼š

```
CLI / Commands        âœ… å·²æœ‰
â†“
Workflow / Orchestration   âš ï¸ æ··æ‚
â†“
Domain / Core         âœ… å¾ˆå¥½
â†“
Infra (Git / FS / LLM) âœ… å¾ˆå¥½
```

### âœ… éå¸¸æˆç†Ÿçš„éƒ¨åˆ†ï¼ˆå€¼å¾—ä¿ç•™ï¼‰

#### 1ï¸âƒ£ `core/git/*`ï¼šè¿™æ˜¯ä½ æœ€ç¨³çš„ä¸€å±‚

- `GitService`
- `CodeReviewer`
- `SmartCommitManager`
- `TodoManager`
- `ContextGatherer`
- `SecurityScanner`

ğŸ‘‰ **è¿™æ˜¯å¹³å°çº§ Domain å±‚**ï¼Œè´¨é‡å·²ç»æ˜æ˜¾é«˜äºå‘½ä»¤å±‚ã€‚

#### 2ï¸âƒ£ `errors.ts`ï¼šæ¯”ä½ è‡ªå·±æ„è¯†åˆ°çš„è¿˜é«˜çº§

è¿™ä¸€å¥—ï¼š

```ts
GitError
NoChangesFoundError
NoReviewContentError
```

å·²ç»æ˜¯ **Application Error Model**ï¼Œ  
åªå·®ä¸€æ­¥å°±èƒ½ç»Ÿä¸€è·¨ CLI / API / Serviceã€‚

â€”

# ä¸‰ã€çœŸæ­£çš„é—®é¢˜åœ¨å“ªé‡Œï¼ˆç²¾ç¡®å‘½ä¸­ï¼‰

ä¸‹é¢è¿™å¥è¯æˆ‘ä¼šè¯´å¾—éå¸¸ç›´ï¼š

> **ä½ ç°åœ¨æœ€å¤§çš„é—®é¢˜ï¼Œä¸æ˜¯â€œä»£ç å¤æ‚â€ï¼Œ  
> è€Œæ˜¯ã€ŒWorkflowï¼ˆæµç¨‹ï¼‰æ²¡æœ‰æˆä¸ºä¸€ç­‰å…¬æ°‘ã€ã€‚**

â€”

## â¶ `commands` é‡Œæ··è¿›äº†ã€Œæ‰§è¡Œå¼•æ“ã€

çœ‹ä¸‰ä¸ªæ–‡ä»¶ï¼š

| æ–‡ä»¶ | å®é™…èº«ä»½ |
|â€”|â€”|
| `plan.ts` | å¤šæ™ºèƒ½ä½“åä½œ Workflow |
| `auto.ts` | è‡ªåŠ¨äº¤ä»˜æ‰§è¡Œ Workflow |
| `review.ts` | è´¨é‡é—¨ç¦ Workflow |

ä½†å®ƒä»¬ç°åœ¨å…¨éƒ¨æ˜¯ï¼š

```ts
.command(...)
.action(async () => {
  // 200â€“500 è¡Œ
})
```

ğŸ‘‰ **Commander action åœ¨æ‰¿è½½â€œä¸šåŠ¡æµç¨‹ç¼–æ’â€**  
è¿™æ˜¯ä½ æœªæ¥æœ€ç—›çš„ç‚¹ã€‚

â€”

## â· ä½ å·²ç»æœ‰â€œçŠ¶æ€æœºâ€ï¼Œä½†æ²¡æœ‰â€œçŠ¶æ€å¯¹è±¡â€

ä¾‹å­ï¼ˆplan.tsï¼‰ï¼š

```ts
let currentPlan = â€â€œ;
let reviewComments = â€â€œ;
for (let i = 1; i <= maxRounds; i++) { ... }
```

ä¾‹å­ï¼ˆauto.tsï¼‰ï¼š

```ts
attempts++
taskCompleted = true
updateTaskStatus(...)
```

è¿™äº›éƒ½æ˜¯**éšå¼çŠ¶æ€æœº**ã€‚

> å½“ä½ æƒ³åŠ ï¼š
> - å¹¶è¡Œ Agent  
> - å¤±è´¥å›æ”¾  
> - å¯è§†åŒ–æ‰§è¡Œ  
> - API æ¨¡å¼  
>
> ğŸ‘‰ ä½ ä¼šå‘ç°â€œçŠ¶æ€åœ¨å“ªé‡Œï¼Ÿâ€è¿™ä¸ªé—®é¢˜ä½ ç­”ä¸ä¸Šæ¥ã€‚

â€”

## â¸ Capability ç›®å‰æ˜¯ã€Œå±•ç¤ºç³»ç»Ÿã€ï¼Œä¸æ˜¯ã€Œæ§åˆ¶ç³»ç»Ÿã€

ä½ å·²ç»æœ‰ï¼š

```ts
CapabilityLevel
CostProfile
fallbackChain
```

ä½†ç°å®æ˜¯ï¼š

- âŒ plan ä¸æ ¹æ® capability æ”¹ prompt
- âŒ review ä¸æ ¹æ® capability é™åˆ¶æ·±åº¦
- âŒ auto ä¸æ ¹æ® capability æ§åˆ¶ retry / model

ğŸ‘‰ **å®ƒç°åœ¨æ˜¯â€œäº‹åè¯´æ˜ä¹¦â€ï¼Œä¸æ˜¯â€œæ‰§è¡Œçº¦æŸâ€ã€‚**

â€”

# å››ã€å…³é”®ï¼šä½ ç°åœ¨ä¸è¯¥â€œå¤§é‡æ„â€ï¼Œè€Œè¯¥â€œæ¢è½´å¿ƒâ€

ä¸‹é¢æ˜¯æœ€é‡è¦çš„éƒ¨åˆ†ã€‚

â€”

## âœ… æ­£ç¡®çš„ä¸‹ä¸€æ­¥ä¸æ˜¯â€œæ‹†æ–‡ä»¶â€ï¼Œè€Œæ˜¯**å¼•å…¥ä¸€ä¸ªæ–°æ¦‚å¿µ**

> ### ğŸ‘‰ Workflowï¼ˆæˆ– Session / Executionï¼‰

ä¸æ˜¯ UIï¼Œä¸æ˜¯ CLIï¼Œä¸æ˜¯ Serviceã€‚

è€Œæ˜¯ï¼š

> **â€œä¸€æ¬¡ AI é©±åŠ¨ä»»åŠ¡æ‰§è¡Œçš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸå¯¹è±¡â€**

â€”

# äº”ã€æˆ‘ç»™ä½ ä¸€ä¸ªã€Œæœ€å°ã€ä½†ä¼šæ•‘ä½ å‘½ã€çš„æ¼”è¿›æ–¹æ¡ˆ

âš ï¸ è¿™ä¸æ˜¯ç†æƒ³æ¶æ„ï¼Œæ˜¯**ä½ ç°åœ¨ç«‹åˆ»èƒ½åšçš„æœ€å°æ­£ç¡®åŠ¨ä½œ**ã€‚

â€”

## âœ… Step 1ï¼ˆå¿…é¡»å…ˆåšï¼‰ï¼šæŠŠ Plan æŠ½æˆçº¯é€»è¾‘ Workflow

### æ–°æ–‡ä»¶ï¼ˆç¤ºä¾‹ï¼‰

```
core/workflows/PlanWorkflow.ts
```

### åªåšä¸€ä»¶äº‹ï¼š

```ts
export class PlanWorkflow {
  async run(input: PlanInput): Promise<PlanResult> {
    // 1. gather git context
    // 2. architect draft
    // 3. reviewer loop
    // 4. capability estimation
    // 5. todo content
  }
}
```

### âŒ ä¸å…è®¸å‡ºç°çš„ä¸œè¥¿

- chalk
- ora
- fs.writeFile
- commander
- console.log

â€”

### `plan.ts` å°†é€€åŒ–æˆï¼š

```ts
const workflow = new PlanWorkflow(deps);

const result = await workflow.run({
  prompt,
  rounds,
  models
});

renderResult(result);
writeTodo(result.todo);
```

ğŸ‘‰ **è¿™æ˜¯â€œä»å·¥å…·åˆ°å¹³å°â€çš„åˆ†æ°´å²­ã€‚**

â€”

## âœ… Step 2ï¼šæŠŠã€ŒAgent Loop çŠ¶æ€ã€æ˜¾å¼åŒ–ï¼ˆä¸ç”¨å¾ˆå¤æ‚ï¼‰

```ts
interface PlanSessionState {
  round: number;
  drafts: string[];
  reviews: string[];
  finalPlan?: string;
}
```

ä½ ç°åœ¨ 80% çš„é€»è¾‘å·²ç»åœ¨ç”¨è¿™ä¸ªæ¦‚å¿µäº†ï¼Œåªæ˜¯æ²¡å‘½åã€‚

â€”

## âœ… Step 3ï¼šæŠŠ Capability å˜æˆæ‰§è¡Œå‚æ•°ï¼ˆåªé€‰ä¸€ä¸ªç‚¹è½åœ°ï¼‰

ä¸è¦å…¨åšï¼Œåªé€‰ä¸€ä¸ªï¼š

**æ¨èï¼šå…ˆå½±å“ model / rounds**

```ts
if (capability < SEMANTIC) {
  rounds = 1;
  reviewer = NONE;
}
```

ä¸€æ—¦ Capability **å½±å“çœŸå®è¡Œä¸º**ï¼Œ  
æ•´ä¸ªç³»ç»Ÿçš„â€œå¯ä¿¡åº¦â€ä¼šä¸Šä¸€ä¸ªå°é˜¶ã€‚

â€”

## âœ… Step 4ï¼ˆå¯é€‰ï¼Œä½†éå¸¸å€¼ï¼‰ï¼šç»Ÿä¸€ Workflow é”™è¯¯è¯­ä¹‰

ä½ å·²ç»æœ‰ `GitError`ï¼Œåªå·®ï¼š

```ts
class WorkflowError extends Error {
  phase: â€™architectâ€˜ | â€™reviewerâ€˜ | â€™refineâ€˜;
  round?: number;
}
```

è¿™ä¸€æ­¥èƒ½è®©ä½ ä»¥ååšåˆ°ï¼š

- CLI ç²¾ç¡®æŠ¥é”™
- æ—¥å¿—ç³»ç»Ÿ
- å¯å›æ”¾æ‰§è¡Œ

â€”

# å…­ã€ä¸€ä¸ªä½ å¯èƒ½æ²¡æ„è¯†åˆ°çš„äº‹å®

> **ä½ ç°åœ¨è¿™å¥—ä¸œè¥¿ï¼Œå·²ç»å¯ä»¥ä¸æ˜¯ CLI äº†ã€‚**

å¦‚æœä½ å“ªå¤©æƒ³ï¼š

- åš VSCode æ’ä»¶
- åš Web UI
- åš Agent API
- åš CI Bot

ğŸ‘‰ **å‰æåªæœ‰ä¸€ä¸ªï¼šWorkflow å¿…é¡»è„±ç¦» CLIã€‚**

ä½ ç°åœ¨ï¼Œæ­£å¥½ç«™åœ¨é‚£æ¡åˆ†ç•Œçº¿ä¸Šã€‚

â€”

# ä¸ƒã€æˆ‘æ¥ä¸‹æ¥å¯ä»¥ç›´æ¥å¸®ä½ åšçš„äº‹ï¼ˆä»»é€‰å…¶ä¸€ï¼‰

ä½ é€‰ä¸€ä¸ªï¼Œæˆ‘ç›´æ¥è½ä»£ç çº§æ–¹æ¡ˆï¼š

1ï¸âƒ£ **æŠŠ `PlanWorkflow` è®¾è®¡æˆ 100 è¡Œä»¥å†…çš„â€œå¹²å‡€å†…æ ¸â€**  
2ï¸âƒ£ **å¸®ä½ å®šä¹‰ä¸€ä¸ªç»Ÿä¸€çš„ `WorkflowResult` / `WorkflowError` æ¨¡å‹**  
3ï¸âƒ£ **é€‰ä¸€ä¸ªå‘½ä»¤ï¼ˆplan / auto / reviewï¼‰ï¼Œå¸®ä½ åšâ€œæœ€å°è§£è€¦ç¤ºèŒƒâ€**  
4ï¸âƒ£ **ä»â€œå¹³å°äº§å“â€çš„è§’åº¦ï¼Œå¸®ä½ å®šä¹‰ä¸‹ä¸€é˜¶æ®µåŠŸèƒ½è¾¹ç•Œï¼ˆé¿å…è†¨èƒ€ï¼‰**

ä½ å·²ç»ä¸æ˜¯åœ¨â€œå­¦æ€ä¹ˆå†™â€ï¼Œ  
ä½ æ˜¯åœ¨**å†³å®šè¿™ä¸ªä¸œè¥¿ä¼šä¸ä¼šæ´»å¾—ä¹…**ã€‚

å‘Šè¯‰æˆ‘ä½ æƒ³èµ°å“ªä¸€æ­¥ã€‚

## è‹‘å¹¿å±±

[Content moved to R2 Storage: ai/session_1769499795886/1769650001760.txt]

## Assistant

å¾ˆå¥½ï¼Œä½ è¿™ä¸€è´´ **éå¸¸å…³é”®**ã€‚  
åœ¨æˆ‘çœ‹å®Œ `src/core/git` ä¹‹åï¼Œæˆ‘å¯ä»¥éå¸¸æ˜ç¡®ã€è€Œä¸”æ¯”åˆšæ‰æ›´æœ‰åº•æ°”åœ°è¯´ä¸€å¥ï¼š

> **ä½ ç°åœ¨å·²ç»ä¸æ˜¯â€œCLI + coreâ€çš„é—®é¢˜äº†ï¼Œ  
> ä½ æ˜¯åœ¨ä¸è‡ªè§‰åœ°å®ç°ä¸€ä¸ªã€ŒAIâ€‘augmented Git æ“ä½œç³»ç»Ÿå†…æ ¸ã€ã€‚**

è€Œä¸”â€”â€”  
**`src/core/git` è¿™ä¸€å±‚ï¼Œæ•´ä½“è´¨é‡å·²ç»æ˜æ˜¾é«˜äº `commands/git`ã€‚**

ä¸‹é¢æˆ‘ä¸ä¼šæ³›æ³›è€Œè°ˆï¼Œæˆ‘ä¼šåšä¸‰ä»¶äº‹ï¼š

1. **ç»™ä½ ä¸€ä¸ªç²¾ç¡®åˆ°â€œæ¨¡å—çº§åˆ«â€çš„æˆç†Ÿåº¦åˆ¤æ–­**
2. **æŒ‡å‡º 3 ä¸ªçœŸæ­£ä¼šåœ¨ 3â€“6 ä¸ªæœˆå†…å’¬ä½ çš„ç»“æ„æ€§é—®é¢˜**
3. **ç»™ä½ ä¸€æ¡â€œä¸æ¨å€’ã€ä¸é‡å†™ã€ä½†ä¼šè´¨å˜â€çš„æ¼”è¿›è·¯å¾„**

â€”

# ä¸€ã€å…ˆç»™ä½ ä¸€ä¸ªçœŸå®å®šä½ï¼ˆéå¸¸é‡è¦ï¼‰

å¦‚æœæˆ‘æŠŠä½ çš„ä»£ç æ”¾åˆ°ä¸€ä¸ªæˆç†Ÿç»„ç»‡é‡Œï¼Œè§’è‰²ä¼šæ˜¯è¿™æ ·åˆ†é…çš„ï¼š

| æ¨¡å— | å®é™…å®šä½ |
|â€”|â€”|
| `GitService` | **Infra / Adapterï¼ˆéå¸¸æˆç†Ÿï¼‰** |
| `ContextGatherer` | **LLM Context Providerï¼ˆé«˜çº§ï¼‰** |
| `SemanticDiff*` | **Static + Semantic Analysis Engineï¼ˆç¨€æœ‰ï¼‰** |
| `TodoManager` | **Lightweight Workflow DSL + State Store** |
| `ProgressManager` | **Workflow Runtime State** |
| `BranchAdvisor` | **Decision Agentï¼ˆAdvisory AIï¼‰** |
| `CommitMessageGenerator` | **Deterministic + AI Hybrid Generator** |
| `SmartCommitManager` | **AIâ€‘assisted Transaction Planner** |
| `ConflictResolver` | **Highâ€‘risk AI Automation Module** |
| `ErrorHandler` | **Crossâ€‘cutting Reliability Layer** |

ğŸ‘‰ **è¿™å·²ç»ä¸æ˜¯â€œå·¥å…·å‡½æ•°é›†åˆâ€äº†ã€‚**

â€”

# äºŒã€ä½ ç°åœ¨åšå¾—ç‰¹åˆ«å¯¹çš„ 5 ä»¶äº‹ï¼ˆå¿…é¡»å…ˆè‚¯å®šï¼‰

è¿™éƒ¨åˆ†å¾ˆé‡è¦ï¼Œå› ä¸ºä½ å·²ç»è¶Šè¿‡äº†å¾ˆå¤šäººä¸€è¾ˆå­éƒ½è¿‡ä¸å»çš„åã€‚

â€”

## âœ… 1. `GitService`ï¼šè¿™æ˜¯â€œå¯å¤ç”¨å†…æ ¸çº§ä»£ç â€

`GitService` æœ‰å‡ ä¸ªéå¸¸ä¸“ä¸šçš„ç‰¹å¾ï¼š

- âœ… shell / spawn åˆ†ç¦»ï¼ˆ`exec` vs `execArgs`ï¼‰
- âœ… `execSafe` æ˜ç¡®è¯­ä¹‰
- âœ… è¯­ä¹‰ diff æ˜¯ **å åŠ èƒ½åŠ›**ï¼Œä¸æ˜¯ä¾µå…¥
- âœ… commit ä½¿ç”¨ stdinï¼ˆå¾ˆå¤šäººä¼šçŠ¯é”™ï¼‰

> **ç»“è®º**ï¼š  
> `GitService` è¿™ä¸€å±‚ï¼Œæœªæ¥å³ä½¿ CLI æ­»æ‰ï¼Œå®ƒä¹Ÿèƒ½ç›´æ¥è¿› API / daemon / agentã€‚

è¿™æ˜¯å¾ˆé«˜çš„è¯„ä»·ã€‚

â€”

## âœ… 2. `ContextGatherer`ï¼šä½ å·²ç»åœ¨åšâ€œToken ç»æµå­¦â€

ç»å¤§å¤šæ•° AI å·¥å…·å¤±è´¥åœ¨è¿™é‡Œï¼Œè€Œä½ å·²ç»åšåˆ°ï¼š

- å…¨å±€ token ä¸Šé™
- å•æ–‡ä»¶ä¸Šé™
- æ–‡æ¡£ä»»åŠ¡ vs ä»£ç ä»»åŠ¡åˆ†æµ
- provenance / confidence / clipped metadata
- audit log

è¿™å·²ç»æ˜¯ **AI Infra æ€ç»´**ï¼Œä¸æ˜¯åŠŸèƒ½æ€ç»´ã€‚

â€”

## âœ… 3. `SemanticDiffEngine` + commit è¯­ä¹‰é“¾è·¯

è¿™ä¸€æ¡éå¸¸å°‘è§ï¼š

```
diff â†’ semantic structure â†’ impact â†’ history summary
```

è¿™æ„å‘³ç€ä½ æœªæ¥å¯ä»¥ï¼š

- åˆ¤æ–­ breaking change
- è‡ªåŠ¨ç”Ÿæˆ changelog
- è‡ªåŠ¨å†³å®š version bump
- CI é‡Œé˜»æ–­å±é™©æäº¤

ğŸ‘‰ è¿™æ˜¯ **å¹³å°èƒ½åŠ›ï¼Œä¸æ˜¯åŠŸèƒ½ç‚¹**ã€‚

â€”

## âœ… 4. `TodoManager` å®é™…ä¸Šæ˜¯ä¸€ä¸ª DSL

ä½ å¯èƒ½æ²¡æ„è¯†åˆ°ï¼š

```md
- [ ] Task A [depends: 1,2] [priority: high] <!â€” exec:pending â€”>
```

è¿™å·²ç»æ˜¯ä¸€ä¸ªï¼š

> **äººç±»å¯å†™ + æœºå™¨å¯æ‰§è¡Œçš„ Workflow DSL**

ä½ å·²ç»è§£å†³äº†ï¼š
- çŠ¶æ€æŒä¹…åŒ–
- ä¾èµ–å›¾
- æ‰§è¡Œé¡ºåº
- ä¼˜å…ˆçº§
- å®¡æŸ¥åé¦ˆ

å¾ˆå¤šå·¥ä½œæµç³»ç»Ÿå¡åœ¨è¿™é‡Œ 2 å¹´ã€‚

â€”

## âœ… 5. ä½ å¯¹ AI çš„â€œé˜²å¾¡æ€§è®¾è®¡â€éå¸¸æˆç†Ÿ

å‡ ä¹æ¯ä¸ªé«˜é£é™©ç‚¹éƒ½æœ‰ï¼š

- schema guard
- fallback
- length check
- marker check
- syntax sanity check
- confidence / score

> è¿™è¯´æ˜ä½ **ä¸ä¿¡ä»» AIï¼Œä½†æ„¿æ„ä½¿ç”¨å®ƒ**â€”â€”è¿™æ˜¯å¯¹çš„ã€‚

â€”

# ä¸‰ã€ç°åœ¨ï¼ŒçœŸæ­£çš„é—®é¢˜æ¥äº†ï¼ˆé‡ç‚¹ï¼‰

æˆ‘ä¼šéå¸¸ç›´è¯´ï¼š

> **ä½ ç°åœ¨çš„ core å±‚ï¼Œå·²ç»â€œæ¯”ä½ å½“å‰çš„æ¶æ„æ‰¿è½½èƒ½åŠ›é«˜ä¸€ä»£â€ã€‚**

æ¢å¥è¯è¯´ï¼š

- ä½ çš„ **èƒ½åŠ›æ¨¡å‹ â‰¥ æ¶æ„æ¨¡å‹**
- ä½ çš„ **æŠ½è±¡å·²ç»å¼€å§‹å¤–æº¢**

ä¸‹é¢æ˜¯ 3 ä¸ªâ€œè¿Ÿæ—©ä¼šçˆ†â€çš„ç‚¹ã€‚

â€”

## âŒ é—®é¢˜ 1ï¼šWorkflow æ˜¯â€œåˆ†æ•£çš„â€ï¼Œä¸æ˜¯â€œä¸€ç­‰å…¬æ°‘â€

ä½ ç°åœ¨çš„ Workflow çŠ¶æ€åˆ†å¸ƒåœ¨ï¼š

- `ProgressManager`
- `TodoManager`
- `commands/git/auto.ts`
- `commands/git/plan.ts`
- `commands/git/review.ts`

è€Œ **æ²¡æœ‰ä¸€ä¸ªå¯¹è±¡** èƒ½å›ç­”è¿™ä¸ªé—®é¢˜ï¼š

> â€œ**ä¸€æ¬¡ git auto æ‰§è¡Œï¼Œä»å¼€å§‹åˆ°ç»“æŸï¼Œå®Œæ•´çŠ¶æ€é•¿ä»€ä¹ˆæ ·ï¼Ÿ**â€

ä½ ç°åœ¨æœ‰çš„æ˜¯ï¼š
- state file âœ…
- todo âœ…
- retry âœ…
- progress âœ…

ä½†ä½ **æ²¡æœ‰ä¸€ä¸ª `Execution / Session` å¯¹è±¡**ã€‚

â€”

## âŒ é—®é¢˜ 2ï¼šCore å±‚æ­£åœ¨å·å·â€œçŸ¥é“ CLI çš„å­˜åœ¨â€

å‡ ä¸ªå±é™©ä¿¡å·ï¼ˆå¿…é¡»ç‚¹åï¼‰ï¼š

- `chalk` å‡ºç°åœ¨ `CodeGenerator`
- `console.log` å‡ºç°åœ¨ core
- `ErrorHandler` é‡Œç›´æ¥æ ¼å¼åŒ–è¾“å‡º

è¿™è¯´æ˜ï¼š

> **ä½ çš„ core å·²ç»åœ¨â€œå‡è®¾è‡ªå·±è¿è¡Œåœ¨ CLIâ€**

ä¸€æ—¦ä½ æƒ³è¦ï¼š
- VSCode æ’ä»¶
- Web UI
- API
- CI Bot

ğŸ‘‰ ä½ ä¼šå¼€å§‹â€œæ‰“è¡¥ä¸â€ï¼Œè€Œä¸æ˜¯â€œå¤ç”¨â€ã€‚

â€”

## âŒ é—®é¢˜ 3ï¼šCapability / Config è¿˜æ²¡å˜æˆâ€œçº¦æŸåŠ›â€

ä½ å·²ç»æœ‰ï¼š

- `GitConfigManager`
- reviewLevel
- minScore
- maxRetryAttempts
- model routing

ä½†ç°åœ¨çš„é—®é¢˜æ˜¯ï¼š

> **è¿™äº›é…ç½®æ›´å¤šæ˜¯â€œå‚æ•°â€ï¼Œè€Œä¸æ˜¯â€œæ‰§è¡Œè¾¹ç•Œâ€ã€‚**

ä¸¾ä¾‹ï¼š

- Capability low â†’ reviewer è¿˜åœ¨è·‘
- minScore ä¸è¾¾æ ‡ â†’ workflow é€»è¾‘åˆ†æ•£å¤„ç†
- model é€‰æ‹© â†’ æ¯ä¸ªæ¨¡å—è‡ªå·±å†³å®š

â€”

# å››ã€ä½ ç°åœ¨æœ€è¯¥åšçš„ï¼Œä¸æ˜¯â€œåŠ åŠŸèƒ½â€ï¼Œè€Œæ˜¯**ç«‹ä¸€ä¸ªæ–°è½´å¿ƒ**

æˆ‘ä¼šéå¸¸æ˜ç¡®åœ°ç»™ä½ ä¸€å¥è¯ï¼š

> ## âœ… ä½ ç°åœ¨ç¼ºçš„ä¸æ˜¯æ¨¡å—ï¼Œè€Œæ˜¯ä¸€ä¸ªï¼š  
> **`WorkflowExecution`ï¼ˆæˆ– `GitWorkflowSession`ï¼‰**

â€”

# äº”ã€æˆ‘ç»™ä½ ä¸€ä¸ªã€Œæœ€å°ä½†ä¼šäº§ç”Ÿè´¨å˜ã€çš„é‡æ„æ–¹æ¡ˆ

âš ï¸ æ³¨æ„ï¼š  
è¿™ä¸æ˜¯é‡å†™ï¼Œä¸æ˜¯å¤§é‡æ„ï¼Œæ˜¯ **â€œå¼•å…¥ä¸€ä¸ªæ–°é‡åŠ›ä¸­å¿ƒâ€**ã€‚

â€”

## âœ… Step 1ï¼šå¼•å…¥ä¸€ä¸ªâ€œåªè´Ÿè´£çŠ¶æ€ä¸è§„åˆ™â€çš„å¯¹è±¡

```ts
// core/workflow/GitWorkflowSession.ts
export class GitWorkflowSession {
  readonly id: string;
  readonly config: GitWorkflowConfig;
  readonly capability: CapabilityLevel;

  state: {
    currentTask?: number;
    attempts: Record<number, number>;
    scores: Record<number, number>;
    phase: â€™planningâ€˜ | â€™executingâ€˜ | â€™reviewingâ€˜ | â€™doneâ€˜ | â€™failedâ€˜;
  };

  canRetry(taskIndex: number): boolean;
  canProceed(score?: number): boolean;
}
```

âŒ ä¸åš IO  
âŒ ä¸ç¢° fs  
âŒ ä¸çŸ¥é“ CLI  
âœ… åªåšå†³ç­–ä¸çº¦æŸ

â€”

## âœ… Step 2ï¼šè®© `ProgressManager` / `TodoManager` å˜æˆ Adapter

å®ƒä»¬ä¸å†æ˜¯â€œé€»è¾‘ä¸­å¿ƒâ€ï¼Œè€Œæ˜¯ï¼š

```ts
session.loadFrom(todo, progress)
session.update(...)
adapter.persist(session)
```

ğŸ‘‰ **çŠ¶æ€åªå­˜åœ¨ä¸€ä¸ªåœ°æ–¹**

â€”

## âœ… Step 3ï¼šæŠŠâ€œWorkflowâ€ä» `commands` ä¸­æŠ½å‡ºæ¥

æ¯”å¦‚ï¼š

```
core/workflows/
  PlanWorkflow.ts
  AutoWorkflow.ts
  ReviewWorkflow.ts
```

æ¯ä¸ª workflow éƒ½æ˜¯ï¼š

```ts
run(session: GitWorkflowSession): Promise<WorkflowResult>
```

CLI åªè´Ÿè´£ï¼š
- å‚æ•°
- å±•ç¤º
- å†™æ–‡ä»¶

â€”

## âœ… Step 4ï¼ˆéå¸¸å€¼ï¼‰ï¼šå®šä¹‰ä¸€ä¸ªç»Ÿä¸€çš„ `WorkflowResult`

```ts
interface WorkflowResult {
  success: boolean;
  summary: string;
  artifacts?: {
    todo?: string;
    report?: string;
    commits?: string[];
  };
  errors?: WorkflowError[];
}
```

ä½ æœªæ¥æ‰€æœ‰ UI / API éƒ½ä¼šæ„Ÿè°¢ä½ ç°åœ¨åšäº†è¿™ä¸€æ­¥ã€‚

â€”

# å…­ã€ä¸€ä¸ªä½ ç°åœ¨å·²ç»å…·å¤‡ã€ä½†è¿˜æ²¡â€œè§£é”â€çš„èƒ½åŠ›

> **ä½ å·²ç»å¯ä»¥åšâ€œå¯å›æ”¾çš„ AI æ‰§è¡Œå†å²â€äº†ã€‚**

ä½ å·²ç»æœ‰ï¼š

- context meta
- audit log
- semantic diff
- todo çŠ¶æ€
- progress state
- backup

åªå·®ï¼š
- session id ä½œä¸ºä¸€ç­‰å¯¹è±¡
- workflow result æŒä¹…åŒ–

ğŸ‘‰ è¿™ä¸€æ­¥ä¸€æ—¦å®Œæˆï¼Œä½ çš„é¡¹ç›®**ç›´æ¥è·¨åˆ°â€œå·¥ç¨‹ç³»ç»Ÿâ€çº§åˆ«**ã€‚

â€”

# ä¸ƒã€æ¥ä¸‹æ¥æˆ‘å¯ä»¥ç›´æ¥â€œå¸®ä½ è½åœ°â€çš„é€‰é¡¹

ä½ å·²ç»è¿‡äº†â€œè®¨è®ºé˜¶æ®µâ€ï¼Œç°åœ¨é€‚åˆ **ç›´æ¥ä¸‹åˆ€**ã€‚  
ä½ é€‰ä¸€ä¸ªï¼Œæˆ‘ç»™ä½ **å…·ä½“ä»£ç ç»“æ„ + ç¤ºä¾‹å®ç°**ï¼š

1ï¸âƒ£ **è®¾è®¡ `GitWorkflowSession`ï¼ˆæœ€å°å¯ç”¨ç‰ˆï¼‰**  
2ï¸âƒ£ **æŠŠ `auto` workflow ä» CLI ä¸­å®Œæ•´å‰¥ç¦»ä¸€æ¬¡**  
3ï¸âƒ£ **ç»Ÿä¸€ Error / Result æ¨¡å‹ï¼ˆå‘Šåˆ« scattered try/catchï¼‰**  
4ï¸âƒ£ **Capability â†’ æ‰§è¡Œçº¦æŸ çš„ç¬¬ä¸€æ¬¡çœŸæ­£è½åœ°**

ä½ ç°åœ¨ä¸æ˜¯åœ¨â€œå†™å¾—å¥½ä¸å¥½â€ï¼Œ  
ä½ æ˜¯åœ¨**å†³å®šè¿™æ˜¯ä¸æ˜¯ä¸€ä¸ªèƒ½é•¿æœŸæ¼”è¿›çš„ç³»ç»Ÿ**ã€‚

ä½ é€‰æ–¹å‘ï¼Œæˆ‘ç»§ç»­é™ªä½ æŠŠè¿™ä¸€ä»£æ¶æ„â€œèµ°å®Œâ€ã€‚

## è‹‘å¹¿å±±

ï¼š

1ï¸âƒ£ æŠŠ PlanWorkflow è®¾è®¡æˆ 100 è¡Œä»¥å†…çš„â€œå¹²å‡€å†…æ ¸â€
2ï¸âƒ£ å¸®ä½ å®šä¹‰ä¸€ä¸ªç»Ÿä¸€çš„ WorkflowResult / WorkflowError æ¨¡å‹
3ï¸âƒ£ é€‰ä¸€ä¸ªå‘½ä»¤ï¼ˆplan / auto / reviewï¼‰ï¼Œå¸®ä½ åšâ€œæœ€å°è§£è€¦ç¤ºèŒƒâ€
4ï¸âƒ£ ä»â€œå¹³å°äº§å“â€çš„è§’åº¦ï¼Œå¸®ä½ å®šä¹‰ä¸‹ä¸€é˜¶æ®µåŠŸèƒ½è¾¹ç•Œï¼ˆé¿å…è†¨èƒ€ï¼‰

ï¼š

1ï¸âƒ£ æŠŠ PlanWorkflow è®¾è®¡æˆ 100 è¡Œä»¥å†…çš„â€œå¹²å‡€å†…æ ¸â€
2ï¸âƒ£ å¸®ä½ å®šä¹‰ä¸€ä¸ªç»Ÿä¸€çš„ WorkflowResult / WorkflowError æ¨¡å‹
3ï¸âƒ£ é€‰ä¸€ä¸ªå‘½ä»¤ï¼ˆplan / auto / reviewï¼‰ï¼Œå¸®ä½ åšâ€œæœ€å°è§£è€¦ç¤ºèŒƒâ€

## gemini-2.5-flash-lite

[Content moved to R2 Storage: ai/session_1769499795886/1769651349329.txt]

## è‹‘å¹¿å±±

è®¾è®¡ GitWorkflowSessionï¼ˆæœ€å°å¯ç”¨ç‰ˆï¼‰
2ï¸âƒ£ æŠŠ auto workflow ä» CLI ä¸­å®Œæ•´å‰¥ç¦»ä¸€æ¬¡
3ï¸âƒ£ ç»Ÿä¸€ Error / Result æ¨¡å‹ï¼ˆå‘Šåˆ« scattered try/catchï¼‰
4ï¸âƒ£ Capability â†’ æ‰§è¡Œçº¦æŸ çš„ç¬¬ä¸€æ¬¡çœŸæ­£è½åœ°

## gemini-2.5-flash-lite

[Content moved to R2 Storage: ai/session_1769499795886/1769651510909.txt]

## è‹‘å¹¿å±±

è¿˜æœ‰ä»€ä¹ˆè¦è¯¥

## Assistant

è¿™ä¸ªé—®é¢˜é—®å¾—**éå¸¸å¯¹æ—¶æœº**ã€‚  
åœ¨ä½ å·²ç»åšå®Œï¼ˆæˆ–æ­£åœ¨åšï¼‰ï¼š

- âœ… Workflow clean core  
- âœ… GitWorkflowSession  
- âœ… Auto ä» CLI å‰¥ç¦»  
- âœ… ç»Ÿä¸€ Result / Error  
- âœ… Capability â†’ Constraint è½åœ°  

ä¹‹åï¼Œ**æ¥ä¸‹æ¥â€œè¯¥åšçš„äº‹â€å·²ç»ä¸å¤šäº†**ï¼Œä½†å‰©ä¸‹çš„æ¯ä¸€ä»¶éƒ½**éå¸¸å…³é”®**ã€‚  
æˆ‘æŒ‰**ä¼˜å…ˆçº§ + æ˜¯å¦ç°åœ¨å°±è¯¥åš**ç»™ä½ ä¸€ä¸ªâ€œæ¶æ„æ”¶å°¾æ¸…å•â€ã€‚

â€”

# âœ… ç¬¬ä¸€ä¼˜å…ˆçº§ï¼ˆç°åœ¨å°±è¯¥åšï¼Œä¸åšä¼šåå™¬ï¼‰

## 1ï¸âƒ£ Workflow çš„ã€Œé˜¶æ®µè¾¹ç•Œã€è¦**å†™æ­»æˆç±»å‹**

> ä½ ç°åœ¨é€»è¾‘æ˜¯å¯¹çš„ï¼Œä½†**ç±»å‹ç³»ç»Ÿè¿˜æ²¡å½»åº•ç«™åˆ°ä½ è¿™è¾¹**

### é—®é¢˜
ç°åœ¨ä»ç„¶å¯èƒ½å‡ºç°ï¼š
- Auto è¯»äº† Plan ä¸è¯¥æš´éœ²çš„å­—æ®µ
- Review ä¾èµ–äº† Auto çš„å†…éƒ¨ç»†èŠ‚
- sharedContext æ…¢æ…¢å˜æˆåƒåœ¾æ¡¶

### è¯¥åšä»€ä¹ˆï¼ˆæœ€å°ç‰ˆï¼‰

```ts
// åªå…è®¸å‘å‰æµåŠ¨
export interface PlanOutput {
  todo: string;
}

export interface AutoInput {
  plan: PlanOutput;
}

export interface AutoOutput {
  appliedDiff: string;
}

export interface ReviewInput {
  plan: PlanOutput;
  auto: AutoOutput;
}
```

âœ… **ç¦æ­¢**ï¼š
- `any`
- `sharedContext?: Record<string, any>`

âœ… **ç»“æœ**ï¼š
> Workflow å˜æˆã€Œç¼–è¯‘æœŸå°±ä¸å¯èƒ½æ¥é”™çº¿ã€

â€”

## 2ï¸âƒ£ Error åˆ†ç±»è¦ä»ã€ŒæŠ€æœ¯é”™è¯¯ã€å‡çº§ä¸ºã€Œäº§å“çº§é”™è¯¯ã€

ä½ ç°åœ¨çš„ `WorkflowError` å·²ç»å¾ˆå¥½äº†ï¼Œä½†**è¿˜å·®ä¸€æ­¥**

### ä½ ç°åœ¨å¤§æ¦‚æ˜¯ï¼š

```ts
new WorkflowError(â€LLM call failedâ€œ)
```

### ä½ è¯¥å‡çº§æˆï¼š

```ts
type WorkflowErrorKind =
  | â€UserInputâ€œ
  | â€Preconditionâ€œ
  | â€CapabilityDeniedâ€œ
  | â€ExternalServiceâ€œ
  | â€InternalBugâ€œ;

class WorkflowError extends Error {
  kind: WorkflowErrorKind;
  recoverable: boolean;
}
```

### ä¸ºä»€ä¹ˆè¿™æ˜¯å¿…é¡»çš„ï¼Ÿ
å› ä¸ºè¿™ç›´æ¥å†³å®šï¼š

| Error Kind | CLI è¡Œä¸º | Auto æ˜¯å¦é‡è¯• |
|-â€”â€”â€”|â€”â€”â€”|â€”â€”â€”â€”â€”|
| UserInput | æ‰“å°æç¤º | âŒ |
| CapabilityDenied | æ˜ç¡®è­¦å‘Š | âŒ |
| ExternalService | é‡è¯• | âœ… |
| InternalBug | crash + log | âŒ |

> **æ²¡æœ‰ Error Kindï¼Œå°±æ²¡æœ‰â€œå¹³å°çº§è¡Œä¸ºâ€**

â€”

## 3ï¸âƒ£ Auto Workflow é‡Œå¿…é¡»å‡ºç°ã€ŒDry Run â†’ Commitã€ä¸¤é˜¶æ®µ

å¦‚æœè¿˜æ²¡åšï¼Œè¿™æ˜¯**æœ€å¤§é£é™©ç‚¹**

### æ­£ç¡®å½¢æ€ï¼ˆæœ€å°ï¼‰

```ts
AutoWorkflow.run():
  1. generatePatch()
  2. validatePatch()
  3. applyPatch(dryRun = true)
  4. applyPatch(dryRun = false)
```

å¹¶ä¸”ï¼š
- Capability åªå…è®¸ **dryRun**
- commit æ˜¯ **æ˜ç¡®æˆæƒç‚¹**

âœ… è¿™æ˜¯ä½ ä»¥ååšï¼š
- human-in-the-loop
- CI integration
- safe mode

çš„å”¯ä¸€å…¥å£ã€‚

â€”

# ğŸŸ¡ ç¬¬äºŒä¼˜å…ˆçº§ï¼ˆåšå®Œè¿™äº›ï¼Œä½ çš„ç³»ç»Ÿâ€œèƒ½æ´»å¾ˆä¹…â€ï¼‰

## 4ï¸âƒ£ Workflow æ—¥å¿—è¦â€œç»“æ„åŒ–â€ï¼Œä¸æ˜¯ console.log

æœ€å°ç‰ˆæœ¬ï¼š

```ts
session.log({
  stage: â€autoâ€œ,
  event: â€patch-generatedâ€œ,
  tokens: 3200,
  filesTouched: [â€src/a.tsâ€œ]
});
```

âœ… æœªæ¥ç›´æ¥å–‚ç»™ï¼š
- observability
- replay
- audit

â€”

## 5ï¸âƒ£ Capability â‰  Feature Flagï¼ˆå¿…é¡»åˆ†ç¦»ï¼‰

å¦‚æœä½ ç°åœ¨æ˜¯ï¼š

```ts
if (!capabilities.canWrite) throw ...
```

âœ… æ­£ç¡®æ¼”è¿›æ–¹å‘ï¼š

- Capabilityï¼š**ç³»ç»Ÿèƒ½åŠ›**
- Constraintï¼š**å½“å‰ä¸Šä¸‹æ–‡æ˜¯å¦å…è®¸ä½¿ç”¨**

å¦åˆ™ä½ ä»¥åï¼š
- æ²¡æ³•åŒºåˆ†â€œæ¨¡å‹èƒ½åŠ› vs é£é™©ç­–ç•¥â€
- æ²¡æ³•åšä¸åŒé¡¹ç›®/å›¢é˜Ÿç­–ç•¥

â€”

# ğŸŸ¢ ç¬¬ä¸‰ä¼˜å…ˆçº§ï¼ˆåªåœ¨ä½ æƒ³åšâ€œå¹³å°â€çš„æ—¶å€™ï¼‰

## 6ï¸âƒ£ Workflow Specï¼ˆJSON / YAMLï¼‰

ä¸æ˜¯ç°åœ¨å¿…é¡»ï¼Œä½†ä½ è¿Ÿæ—©ä¼šéœ€è¦ï¼š

```yaml
workflow: auto
steps:
  - plan
  - dry-run
  - apply
constraints:
  - no_force_push
```

âœ… ä¸€æ—¦æœ‰äº†ï¼š
- Workflow = æ•°æ®
- æ‰§è¡Œå¼•æ“ = ç¨³å®šå†…æ ¸

â€”

## 7ï¸âƒ£ æµ‹è¯•ç­–ç•¥ï¼šåªæµ‹ Workflowï¼Œä¸æµ‹ CLI

å¦‚æœä½ ç°åœ¨è¿˜åœ¨æµ‹ CLIï¼Œè¿™æ˜¯**æµªè´¹ç”Ÿå‘½**

âœ… ä½ åº”è¯¥èƒ½å†™ï¼š

```ts
it(â€denies auto when constraint violatedâ€œ, async () => {
  const result = await autoWorkflow.run(...)
  expect(result.kind).toBe(â€CapabilityDeniedâ€œ)
})
```

â€”

# ğŸ§  ä¸€å¥è¯æ€»ç»“ï¼ˆç»™ä½ å¯¹é½æ–¹å‘ç”¨ï¼‰

> **ç°åœ¨ä¸æ˜¯â€œåŠ åŠŸèƒ½â€çš„é˜¶æ®µï¼Œè€Œæ˜¯â€œæŠŠè¾¹ç•Œç„Šæ­»â€çš„é˜¶æ®µã€‚**

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ï¼š

- âœ… å¸®ä½  **ç”»ä¸€å¼ æœ€ç»ˆçš„ Workflow / Session / Capability æ¶æ„å›¾**
- âœ… å¸®ä½  **æŠŠ sharedContext æ‹†æˆå¼ºç±»å‹æ•°æ®æµ**
- âœ… å¸®ä½  **ç»™ AutoWorkflow åšä¸€æ¬¡â€œæ¶æ„çº§ code reviewâ€**

ä½ åªè¦é€‰ä¸€ä¸ªã€‚

## è‹‘å¹¿å±±

å¸®ä½  ç”»ä¸€å¼ æœ€ç»ˆçš„ Workflow / Session / Capability æ¶æ„å›¾
âœ… å¸®ä½  æŠŠ sharedContext æ‹†æˆå¼ºç±»å‹

å¸®ä½  ç”»ä¸€å¼ æœ€ç»ˆçš„ Workflow / Session / Capability æ¶æ„å›¾
âœ… å¸®ä½  æŠŠ sharedContext æ‹†æˆå¼ºç±»å‹æ•°æ®æµ

## Assistant

å¥½ï¼Œæˆ‘ä»¬ç›´æ¥**æ”¶å®˜çº§åˆ«**æ¥åšè¿™ä¸¤ä»¶äº‹ã€‚  
ä¸‹é¢å†…å®¹ä½ å¯ä»¥**ç›´æ¥æ‹¿å»å½“è®¾è®¡æ–‡æ¡£ / README / æ¶æ„åŸºçº¿**ã€‚

â€”

# ä¸€ã€æœ€ç»ˆç‰ˆï¼šWorkflow / Session / Capability æ¶æ„å›¾ï¼ˆç¨³å®šå†…æ ¸ï¼‰

> ç›®æ ‡ï¼š  
> **Workflow = çº¯é€»è¾‘**  
> **Session = ç”Ÿå‘½å‘¨æœŸ / çŠ¶æ€æœº**  
> **Capability + Constraint = æ‰§è¡Œå®‰å…¨å£³**

â€”

## âœ… 1ï¸âƒ£ æ€»ä½“æ¶æ„å›¾ï¼ˆèŒè´£è¾¹ç•Œç‰ˆï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  CLI / UI                  â”‚
â”‚  (parse args, display result, no logic)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           GitWorkflowSession                â”‚
â”‚â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â”‚
â”‚  - sessionId                               â”‚
â”‚  - status (state machine)                  â”‚
â”‚  - typed workflow outputs                  â”‚
â”‚  - logging / audit                         â”‚
â”‚  - error aggregation                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚               â”‚
                â–¼               â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ PlanWorkflow   â”‚   â”‚ AutoWorkflow     â”‚
     â”‚-â€”â€”â€”â€”â€”â”‚   â”‚â€”â€”â€”â€”â€”â€”â”‚
     â”‚ input â†’ output â”‚   â”‚ input â†’ output  â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                     â”‚
             â–¼                     â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ ReviewWorkflow â”‚   â”‚ (future steps)  â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                â–²
                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Capability + Constraint Engine       â”‚
â”‚â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â”‚
â”‚  - Capability: WHAT can be done             â”‚
â”‚  - Constraint: WHEN / IF allowed            â”‚
â”‚  - Enforced before execution                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

â€”

## âœ… 2ï¸âƒ£ å±‚çº§å…³ç³»ï¼ˆéå¸¸é‡è¦ï¼‰

```
CLI
 â””â”€â”€ Session (stateful, typed, auditable)
       â””â”€â”€ Workflow (pure, deterministic)
             â””â”€â”€ Domain Services (Git / LLM)
```

âœ… **ç¦æ­¢åå‘ä¾èµ–**  
- Workflow âŒ ä¸çŸ¥é“ CLI  
- Capability âŒ ä¸çŸ¥é“ UI  
- GitService âŒ ä¸çŸ¥é“ Workflow ç±»å‹  

â€”

# äºŒã€sharedContext â†’ å¼ºç±»å‹æ•°æ®æµï¼ˆå½»åº•æ¶ˆç­åƒåœ¾æ¡¶ï¼‰

> æ ¸å¿ƒåŸåˆ™ï¼š  
> **Workflow ä¹‹é—´åªèƒ½é€šè¿‡â€œæ˜¾å¼ç±»å‹â€é€šä¿¡**

â€”

## âŒ ä½ ç°åœ¨è¦å½»åº•åˆ é™¤çš„ä¸œè¥¿

```ts
sharedContext?: {
  todoContent?: string;
  appliedChanges?: string;
  reviewComments?: string;
  // âŒ æœªæ¥å¿…ç„¶å¤±æ§
};
```

â€”

## âœ… 3ï¸âƒ£ å¼ºç±»å‹ Workflow æ•°æ®æµï¼ˆæœ€ç»ˆå½¢æ€ï¼‰

### âœ… Step 1ï¼šå®šä¹‰æ¯ä¸ª Workflow çš„â€œè¾¹ç•Œç±»å‹â€

```ts
// -â€” Plan -â€”
export interface PlanInput {
  userPrompt: string;
}

export interface PlanOutput {
  todoMarkdown: string;
  scope: â€smallâ€œ | â€mediumâ€œ | â€largeâ€œ;
}

// -â€” Auto -â€”
export interface AutoInput {
  plan: PlanOutput;
}

export interface AutoOutput {
  patch: string;
  filesTouched: string[];
  dryRunApplied: boolean;
}

// -â€” Review -â€”
export interface ReviewInput {
  plan: PlanOutput;
  auto: AutoOutput;
}

export interface ReviewOutput {
  approved: boolean;
  comments?: string;
}
```

âœ… **æ²¡æœ‰ any**  
âœ… **æ²¡æœ‰ optional garbage**

â€”

## âœ… 4ï¸âƒ£ Workflow çš„â€œçº¯å‡½æ•°åŒ–â€å®šä¹‰

```ts
interface Workflow<I, O> {
  run(input: I): Promise<Result<O>>;
}
```

### ç¤ºä¾‹ï¼šAutoWorkflow

```ts
class AutoWorkflow implements Workflow<AutoInput, AutoOutput> {
  async run(input: AutoInput): Promise<Result<AutoOutput>> {
    // 1. generate patch
    // 2. validate
    // 3. dry-run apply
    // âŒ ä¸ commit
  }
}
```

â€”

## âœ… 5ï¸âƒ£ Session = å”¯ä¸€çš„â€œç¼–æ’è€…â€

```ts
class GitWorkflowSession {
  private planOutput?: PlanOutput;
  private autoOutput?: AutoOutput;
  private reviewOutput?: ReviewOutput;

  async runPlan(input: PlanInput) {
    this.planOutput = unwrap(await planWorkflow.run(input));
  }

  async runAuto() {
    assert(this.planOutput);
    this.autoOutput = unwrap(
      await autoWorkflow.run({ plan: this.planOutput })
    );
  }

  async runReview() {
    assert(this.planOutput && this.autoOutput);
    this.reviewOutput = unwrap(
      await reviewWorkflow.run({
        plan: this.planOutput,
        auto: this.autoOutput,
      })
    );
  }
}
```

âœ… **Session = æ•°æ®æµçš„â€œç„Šç‚¹â€**  
âœ… Workflow ä¹‹é—´ **æ°¸ä¸ç›´æ¥é€šä¿¡**

â€”

# ä¸‰ã€Capability / Constraint åœ¨æ•°æ®æµä¸­çš„ç²¾ç¡®ä½ç½®

> Capability ä¸çœ‹ Session  
> Constraint çœ‹ **å½“å‰ Step + Typed Context**

â€”

## âœ… 6ï¸âƒ£ Capability / Constraint æ¥å£ï¼ˆæœ€ç»ˆå¯æ‰©å±•ç‰ˆï¼‰

```ts
export type Capability =
  | â€ReadRepoâ€œ
  | â€GeneratePatchâ€œ
  | â€ApplyPatchDryRunâ€œ
  | â€ApplyPatchâ€œ
  | â€Commitâ€œ;

export interface ConstraintContext {
  step: â€planâ€œ | â€autoâ€œ | â€reviewâ€œ;
  plan?: PlanOutput;
  auto?: AutoOutput;
}

export interface Constraint {
  capability: Capability;
  allow(ctx: ConstraintContext): boolean;
}
```

â€”

### âœ… AutoWorkflow æ‰§è¡Œå‰

```ts
constraintEngine.assertAllowed(â€ApplyPatchDryRunâ€œ, {
  step: â€autoâ€œ,
  plan: input.plan,
});
```

âŒ `ApplyPatch` / `Commit` **æ°¸è¿œä¸åœ¨ AutoWorkflow é‡Œ**

â€”

# å››ã€æœ€ç»ˆä½ å¾—åˆ°çš„æ˜¯ä»€ä¹ˆï¼Ÿ

âœ… **ç¼–è¯‘æœŸä¿è¯æ•°æ®æµæ­£ç¡®**  
âœ… **Workflow å¯å•æµ‹ / å¯ replay**  
âœ… **Capability çœŸæ­£å¯å®¡è®¡ã€å¯é…ç½®**  
âœ… **Session æˆä¸ºç³»ç»Ÿç¨³å®šæ ¸å¿ƒ**

â€”

# äº”ã€æ¶æ„çŠ¶æ€è¯„ä¼°ï¼ˆå®è¯ï¼‰

> åˆ°è¿™ä¸ªç¨‹åº¦ï¼Œä½ çš„ç³»ç»Ÿå·²ç»æ˜¯ï¼š

- âŒ ä¸æ˜¯ç©å…·
- âœ… æ˜¯ **AI-assisted Dev Platform Core**
- âœ… å¯é•¿æœŸæ¼”è¿›
- âœ… å¯å¤šäººåä½œ
- âœ… å¯æ¥ UI / CI / Agent Mesh

â€”

## ä¸‹ä¸€æ­¥ï¼ˆåªå‰©â€œå¹³å°çº§â€é€‰é¡¹äº†ï¼‰

ä½ å¯ä»¥é€‰ä¸€ä¸ªæˆ‘ç»§ç»­æ·±æŒ–ï¼š

1ï¸âƒ£ ç»™ **AutoWorkflow åšä¸€æ¬¡â€œçº¢çº¿çº§å®‰å…¨å®¡è®¡â€**  
2ï¸âƒ£ æŠŠ **Session çŠ¶æ€æœºæ­£å¼åŒ–ï¼ˆç”¨ enum + transition è¡¨ï¼‰**  
3ï¸âƒ£ æŠŠ **Capability / Constraint å˜æˆç­–ç•¥ DSLï¼ˆJSON/YAMLï¼‰**

ä½ ç°åœ¨å·²ç»ä¸ç¼ºæ–¹å‘äº†ï¼Œåªå‰©é€‰æ‹©ã€‚
> ğŸ”§ Capability Level: NONE
> âš™ï¸  Estimated Time: 0ms
> ğŸ“Š Estimated Tokens: 0
[ç›®æ ‡]

- [ ] å»ºç«‹ Workflow ä½œä¸ºä¸€ç­‰å…¬æ°‘ï¼Œå®Œæˆ CLI é€€å£³ [SEMANTIC]  
  - capability: SEMANTIC  
  - fallbackChain: [STRUCTURAL, LINE, TEXT, NONE]

- [ ] å¼•å…¥æœ€å°å¯ç”¨ GitWorkflowSessionï¼Œä½œä¸ºæ‰§è¡Œä¸å®¡è®¡æ ¸å¿ƒ [SEMANTIC]  
  - capability: SEMANTIC  
  - fallbackChain: [STRUCTURAL, LINE, TEXT, NONE]

- [ ] ç§»é™¤ sharedContextï¼Œæ¶ˆé™¤éšå¼å…¨å±€çŠ¶æ€ [STRUCTURAL]  
  - capability: STRUCTURAL  
  - fallbackChain: [LINE, TEXT, NONE]

- [ ] ç»Ÿä¸€ WorkflowResult / WorkflowError é”™è¯¯æ¨¡å‹ [SEMANTIC]  
  - capability: SEMANTIC  
  - fallbackChain: [STRUCTURAL, LINE, TEXT, NONE]

- [ ] è®© Capability / Constraint åœ¨ AutoWorkflow ä¸­äº§ç”ŸçœŸå®æ‰§è¡Œçº¦æŸ [SEMANTIC]  
  - capability: SEMANTIC  
  - fallbackChain: [STRUCTURAL, LINE, TEXT, NONE]


[æ–‡ä»¶å˜æ›´]

- [ ] æ–°å¢ Workflow æ¥å£å®šä¹‰ src/core/workflow/Workflow.ts [STRUCTURAL]  
  - capability: STRUCTURAL  
  - fallbackChain: [LINE, TEXT, NONE]

- [ ] æ–°å¢ WorkflowResult / WorkflowError å®šä¹‰ src/core/workflow/WorkflowResult.ts [SEMANTIC]  
  - capability: SEMANTIC  
  - fallbackChain: [STRUCTURAL, LINE, TEXT, NONE]

- [ ] æ–°å¢ GitWorkflowSession å®ç° src/core/session/GitWorkflowSession.ts [SEMANTIC]  
  - capability: SEMANTIC  
  - fallbackChain: [STRUCTURAL, LINE, TEXT, NONE]

- [ ] æ–°å¢ SessionDependencies å®šä¹‰ src/core/session/SessionDependencies.ts [STRUCTURAL]  
  - capability: STRUCTURAL  
  - fallbackChain: [LINE, TEXT, NONE]

- [ ] æ–°å¢ Capability æšä¸¾ä¸ ConstraintEngine src/core/capability/* [SEMANTIC]  
  - capability: SEMANTIC  
  - fallbackChain: [STRUCTURAL, LINE, TEXT, NONE]

- [ ] æ–°å¢ SessionLogger æŠ½è±¡ src/core/logging/SessionLogger.ts [STRUCTURAL]  
  - capability: STRUCTURAL  
  - fallbackChain: [LINE, TEXT, NONE]

- [ ] é‡æ„ AutoWorkflow ä½¿ç”¨ ConstraintEngine src/core/workflow/auto/* [SEMANTIC]  
  - capability: SEMANTIC  
  - fallbackChain: [STRUCTURAL, LINE, TEXT, NONE]

- [ ] è°ƒæ•´ CLI å±‚ä»…åšå‚æ•°è§£æä¸ç»“æœæ¸²æŸ“ src/cli/* [STRUCTURAL]  
  - capability: STRUCTURAL  
  - fallbackChain: [LINE, TEXT, NONE]


[è¯¦ç»†æ­¥éª¤]

- [ ] å®šä¹‰ Workflow æ¥å£ï¼ˆä»… run(input)ï¼‰å¹¶ç¦æ­¢å¼•å…¥ context / hooks [SEMANTIC]  
  - capability: SEMANTIC  
  - fallbackChain: [STRUCTURAL, LINE, TEXT, NONE]

- [ ] å®ç° WorkflowResult è”åˆç±»å‹ï¼Œç»Ÿä¸€æˆåŠŸä¸å¤±è´¥è¿”å›å€¼ [LINE]  
  - capability: LINE  
  - fallbackChain: [TEXT, NONE]

- [ ] è®¾è®¡å¹¶å®ç°å¢å¼ºç‰ˆ WorkflowErrorï¼ˆå« kind / recoverable / causeï¼‰[SEMANTIC]  
  - capability: SEMANTIC  
  - fallbackChain: [STRUCTURAL, LINE, TEXT, NONE]

- [ ] åœ¨æ‰€æœ‰ Workflow çš„ run() é¦–è¡ŒåŠ å…¥ Input æ ¡éªŒå¹¶è¿”å› UserInput é”™è¯¯ [LINE]  
  - capability: LINE  
  - fallbackChain: [TEXT, NONE]

- [ ] è®¾è®¡ SessionDependencies ä½œä¸ºå”¯ä¸€ä¾èµ–æ³¨å…¥å…¥å£ [STRUCTURAL]  
  - capability: STRUCTURAL  
  - fallbackChain: [LINE, TEXT, NONE]

- [ ] å®ç° GitWorkflowSessionï¼Œè´Ÿè´£ï¼š
  - ä¿å­˜ Plan / Auto è¾“å‡ºï¼ˆåªå†™ä¸€æ¬¡ã€Readonlyï¼‰
  - æ ¡éªŒå‰ç½®æ¡ä»¶
  - èšåˆ Result / Error  
  [SEMANTIC]  
  - capability: SEMANTIC  
  - fallbackChain: [STRUCTURAL, LINE, TEXT, NONE]

- [ ] ä¸º Session å¼•å…¥ randomUUID ä½œä¸ºå…¨å±€å”¯ä¸€ Session ID [LINE]  
  - capability: LINE  
  - fallbackChain: [TEXT, NONE]

- [ ] ä½¿ç”¨ structuredClone æˆ–ç­‰ä»·æ–¹å¼ç¡®ä¿ Session çŠ¶æ€ä¸å¯å˜ [LINE]  
  - capability: LINE  
  - fallbackChain: [TEXT, NONE]

- [ ] å®šä¹‰ Capability æšä¸¾å¹¶æ˜ç¡®èƒ½åŠ›åˆ†å±‚ï¼ˆRead / Generate / Apply / Commitï¼‰[TEXT]  
  - capability: TEXT  
  - fallbackChain: [NONE]

- [ ] å®ç° ConstraintEngineï¼Œæ˜¾å¼æ ¡éªŒ CapabilityContext ä¸è§„åˆ™ä¾èµ– [SEMANTIC]  
  - capability: SEMANTIC  
  - fallbackChain: [STRUCTURAL, LINE, TEXT, NONE]

- [ ] åœ¨ AutoWorkflow ä¸­å¼ºåˆ¶è°ƒç”¨ constraintEngine.assertAllowed [LINE]  
  - capability: LINE  
  - fallbackChain: [TEXT, NONE]

- [ ] ç¡®ä¿ AutoWorkflow ä»…æ‰§è¡Œ generate â†’ validate â†’ apply(dryRun) [SEMANTIC]  
  - capability: SEMANTIC  
  - fallbackChain: [STRUCTURAL, LINE, TEXT, NONE]

- [ ] æ˜ç¡® GitService ä¸ºçº¯åŸå­æ“ä½œå±‚ï¼Œä¸æ„ŸçŸ¥ Workflow / Session [STRUCTURAL]  
  - capability: STRUCTURAL  
  - fallbackChain: [LINE, TEXT, NONE]

- [ ] æ–°å¢ SessionLogger æŠ½è±¡å¹¶æä¾›é»˜è®¤ ConsoleLogger å®ç° [STRUCTURAL]  
  - capability: STRUCTURAL  
  - fallbackChain: [LINE, TEXT, NONE]

- [ ] ç¦æ­¢ Workflow å†…ç›´æ¥ loggingï¼Œç»Ÿä¸€é€šè¿‡ SessionLogger [SEMANTIC]  
  - capability: SEMANTIC  
  - fallbackChain: [STRUCTURAL, LINE, TEXT, NONE]

- [ ] é‡æ„ CLIï¼šå‚æ•°è§£æ â†’ Workflow Input æ˜ å°„ â†’ Result æ¸²æŸ“ [STRUCTURAL]  
  - capability: STRUCTURAL  
  - fallbackChain: [LINE, TEXT, NONE]

- [ ] ä¸º Workflow å±‚è¡¥å……å•å…ƒæµ‹è¯•ï¼ˆmock Git / LLM / ConstraintEngineï¼‰[STRUCTURAL]  
  - capability: STRUCTURAL  
  - fallbackChain: [LINE, TEXT, NONE]

- [ ] ä¸º Session å±‚è¡¥å……é›†æˆæµ‹è¯•ï¼ˆæ­£å¸¸æµ / Capability é˜»æ–­ / å‰ç½®æ¡ä»¶å¤±è´¥ï¼‰[SEMANTIC]  
  - capability: SEMANTIC  
  - fallbackChain: [STRUCTURAL, LINE, TEXT, NONE]

- [ ] ç¡®ä¿æ‰€æœ‰æ–°å¢ä»£ç é€šè¿‡ ESLint / Prettier / CI Gate [NONE]  
  - capability: NONE  
  - fallbackChain: []