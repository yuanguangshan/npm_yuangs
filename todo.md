
yuangs äº§å“è·¯çº¿è§„åˆ’ï¼ˆRoadmap v1ï¼‰

åˆ¶å®šæ—¥æœŸï¼š2026â€‘01â€‘19
é˜¶æ®µè·¨åº¦ï¼šâ‰ˆ 3â€“4 ä¸ªæœˆ
å½“å‰çŠ¶æ€ï¼šâœ… Agent Runtime Core å·²é—­ç¯

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

ä¸€ã€å½“å‰åŸºçº¿åˆ¤æ–­ï¼ˆæ¥è‡ª todo.md çš„å…±è¯†ï¼‰

åœ¨åˆ¶å®šè·¯çº¿å‰ï¼Œå…ˆæ˜ç¡®æˆ‘ä»¬å·²ç»ç«™åœ¨å“ªï¼Œé¿å…â€œå‡è£…è¿˜åœ¨èµ·æ­¥â€ã€‚

âœ… å·²å®Œæˆï¼ˆä½œä¸ºä¸å¯å›é€€çš„åŸºçº¿ï¼‰

yuangs å½“å‰å·²ç»å…·å¤‡ï¼š

  * âœ… **Governed Agent Runtime**
    * FSM + Loop + Failureâ€‘aware

    * Capability / Policy å¤–ç½®
  * âœ… **å¯å®¡è®¡ / å¯å›æ”¾**
    * Replayã€Auditã€Deterministic Test
  * âœ… **å¤±è´¥å¯æ§**
    * Autofix æœ‰è¾¹ç•Œ

    * å¤±è´¥ä¸ä¼šæ‰©æ•£
  * âœ… **å®‰å…¨æ¨¡å‹æˆç«‹**
    * Capability Token

    * Policy / Risk / Gate
  * âœ… **å·¥ç¨‹çº§å¯ä¿¡åº¦**
    * Chaos æµ‹è¯•

    * Incident é©±åŠ¨è®¾è®¡

  ç»“è®ºï¼š
  yuangs ä¸ç¼ºâ€œèƒ½åŠ›â€ï¼Œç¼ºçš„æ˜¯â€œäº§å“åŒ–è½½ä½“â€ã€‚

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

äºŒã€è·¯çº¿è§„åˆ’çš„æ€»ä½“åŸåˆ™ï¼ˆéå¸¸é‡è¦ï¼‰

ä¸‰æ¡ä¸å¦¥ååŸåˆ™

  1. **Runtime ä¸å†é‡æ„**
    * åªèƒ½åŠ å£³ã€åŠ æ¥å£ã€åŠ äº§å“å±‚
  2. **æ‰€æœ‰æ–°èƒ½åŠ›å¿…é¡»å¯å®¡è®¡**
    * å¦åˆ™ä¸è¿›ä¸»å¹²
  3. **äº§å“åŠŸèƒ½å¿…é¡»æœåŠ¡â€œäººâ€**
    * ä¸æ˜¯æœåŠ¡ Agent è‡ªå—¨

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

ä¸‰ã€é˜¶æ®µåˆ’åˆ†æ€»è§ˆï¼ˆOneâ€‘Pageï¼‰

  Phase 0ï¼ˆå·²å®Œæˆï¼‰
  âœ… Governed Agent Runtime Core

  Phase 1ï¼ˆäº§å“åŒ–åŸºç¡€ï¼‰
  ğŸ§¾ Macro èµ„äº§åŒ– + Registry
  ğŸ” Capability / Scope äº§å“åŒ–
  ğŸ“Š Audit å¯è§†åŒ–

  Phase 2ï¼ˆå¯è¿è¥ï¼‰
  ğŸ§ Humanâ€‘inâ€‘theâ€‘Loop
  ğŸ§ª Incident â†’ Chaos é—­ç¯
  ğŸ” Safe Resume / å›æ»š

  Phase 3ï¼ˆè§„æ¨¡åŒ–ï¼‰
  ğŸ¢ Multiâ€‘Tenant / Team
  ğŸ“¦ Macro ç”Ÿæ€
  ğŸ¤– LLM è¾…åŠ©ä½†ä¸å¯èµ‹æƒ

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

å››ã€Phase 1ï¼šäº§å“åŒ–åŸºç¡€ï¼ˆæœ€å…³é”®ï¼Œ4â€“6 å‘¨ï¼‰

  ç›®æ ‡ï¼š
  è®© yuangs ä»â€œå·¥ç¨‹æ­£ç¡®â€å˜æˆâ€œå¯ä»¥è¢«ä½¿ç”¨ã€è¢«ç†è§£ã€è¢«ç®¡ç†â€ã€‚

1ï¸âƒ£ Macro Registryï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰

ä¸ºä»€ä¹ˆç°åœ¨å¿…é¡»åš

  * Macro æ˜¯æœªæ¥æ‰€æœ‰ç”Ÿäº§åŠ›çš„è½½ä½“
  * æ²¡æœ‰ Registry = æ²¡æœ‰èµ„äº§åŒ–

âœ… Deliverablesï¼š

  * Macro Manifestï¼ˆid / version / requires / checksumï¼‰
  * Publish / Approve / Deprecate æµç¨‹
  * Capability Diff é˜»æ–­
  * Draft / Approved çŠ¶æ€æœº

âœ… äº§å“ä»·å€¼ï¼š

  * ç”¨æˆ·çŸ¥é“ã€Œæˆ‘åœ¨è·‘ä»€ä¹ˆã€
  * å®‰å…¨çŸ¥é“ã€Œè°å‘å¸ƒäº†ä»€ä¹ˆã€
  * æœªæ¥å¯åš Marketplace

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

2ï¸âƒ£ Capability / Risk äº§å“åŒ–

ä»â€œå·¥ç¨‹èƒ½åŠ›â€ â†’ â€œç”¨æˆ·èƒ½ç†è§£çš„æ¨¡å‹â€

âœ… Deliverablesï¼š

  * Capability Graphï¼ˆversionedï¼‰
  * Risk Score è®¡ç®—
  * â€œä¸ºä»€ä¹ˆéœ€è¦å®¡æ‰¹â€çš„è§£é‡Šç”Ÿæˆå™¨

âœ… äº§å“ä»·å€¼ï¼š

  * éå·¥ç¨‹è§’è‰²ï¼ˆå®‰å…¨ / æ³•åŠ¡ï¼‰èƒ½ç†è§£
  * å®¡æ‰¹ä¸å†æ˜¯é»‘ç›’

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

3ï¸âƒ£ Audit Timelineï¼ˆv1 UI / APIï¼‰

âœ… Deliverablesï¼š

  * Run Timeline
  * Capability / Secret / Gate äº‹ä»¶
  * Effects Summary

âœ… äº§å“ä»·å€¼ï¼š

  * å‡ºäº‹å¯è§£é‡Š
  * æˆåŠŸä¹Ÿå¯å¤ç›˜

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

ğŸ“Œ Phase 1 æˆåŠŸæ ‡å¿—

  âœ… ä¸€ä¸ªæ–°ç”¨æˆ·ï¼Œä¸çœ‹ä»£ç ï¼Œä¹Ÿèƒ½ï¼š

    * é€‰æ‹© Macro
    * çŸ¥é“é£é™©
    * ç†è§£ä¸ºä»€ä¹ˆè¢«æ‹¦
    * å¤ç›˜ä¸€æ¬¡æ‰§è¡Œ

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

äº”ã€Phase 2ï¼šå¯è¿è¥ï¼ˆ6â€“8 å‘¨ï¼‰

  ç›®æ ‡ï¼š
  yuangs å¯ä»¥è¢«é•¿æœŸè¿è¡Œï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§å·¥å…·ã€‚

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

1ï¸âƒ£ Humanâ€‘inâ€‘theâ€‘Loopï¼ˆHITLï¼‰

âœ… Deliverablesï¼š

  * Gate â†’ FSM çŠ¶æ€
  * å®¡æ‰¹ç»‘å®š Execution Plan Hashï¼ˆINCâ€‘004ï¼‰
  * SLA / è¶…æ—¶ / å‡çº§

âœ… äº§å“ä»·å€¼ï¼š

  * çœŸæ­£èƒ½è¿› CI / ç”Ÿäº§
  * äººç±»æˆä¸ºç³»ç»Ÿä¸€éƒ¨åˆ†

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

2ï¸âƒ£ Incident â†’ Chaos è‡ªåŠ¨åŒ–

âœ… Deliverablesï¼š

  * Incident æ¨¡å‹
  * Chaos Scenario Generator
  * CI Failâ€‘theâ€‘Build

âœ… äº§å“ä»·å€¼ï¼š

  * ç³»ç»Ÿéšäº‹æ•…å˜å¼º
  * ä¸é â€œç»éªŒä¸»ä¹‰å®‰å…¨â€

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

3ï¸âƒ£ Safe Resume / Compensation

âœ… Deliverablesï¼š

  * Step å¹‚ç­‰ / å‰¯ä½œç”¨å£°æ˜
  * Resume API
  * Compensation DAG

âœ… äº§å“ä»·å€¼ï¼š

  * é•¿ä»»åŠ¡å¯æ¢å¤
  * ä¸æ€•ä¸­æ–­

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

ğŸ“Œ Phase 2 æˆåŠŸæ ‡å¿—

  âœ… yuangs å¯ä»¥ï¼š

    * è·‘åœ¨ CI
    * è·‘åœ¨é•¿æœŸä»»åŠ¡
    * å‡ºäº‹æ•…ä½†ä¸å¤±æ§
    * è¢«å®‰å…¨å›¢é˜Ÿæ¥å—

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

å…­ã€Phase 3ï¼šè§„æ¨¡åŒ–ï¼ˆ6â€“8 å‘¨ï¼‰

  ç›®æ ‡ï¼š
  yuangs ä»â€œå•å›¢é˜Ÿç³»ç»Ÿâ€ â†’ â€œç»„ç»‡çº§å¹³å°â€ã€‚

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

1ï¸âƒ£ Multiâ€‘Tenant / Team Scope

âœ… Deliverablesï¼š

  * Org / Team / User Scope
  * Team Policyï¼ˆallowed / forbidden Macroï¼‰
  * Capability Scope æ´¾ç”Ÿ

âœ… äº§å“ä»·å€¼ï¼š

  * ä¸åŒå›¢é˜Ÿä¸åŒæƒé™
  * å¯å– / å¯å†…éƒ¨æ¨å¹¿

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

2ï¸âƒ£ Macro ç”Ÿæ€ & ç»„åˆ

âœ… Deliverablesï¼š

  * Macro â†’ Macro ä¾èµ–
  * inline / isolated æ¨¡å¼
  * Macro Catalog

âœ… äº§å“ä»·å€¼ï¼š

  * å¤ç”¨
  * ç”Ÿæ€ï¼Œè€Œä¸æ˜¯è„šæœ¬å †

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

3ï¸âƒ£ LLM = Draft Generatorï¼ˆé Agentï¼‰

âœ… Deliverablesï¼š

  * Intent â†’ Runbook â†’ Macro Draft
  * å¼ºåˆ¶äººå·¥ Review
  * è‡ªåŠ¨ Red Flag

âœ… äº§å“ä»·å€¼ï¼š

  * ç”Ÿäº§åŠ› Ã—10
  * é£é™© Ã—0

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

ğŸ“Œ Phase 3 æˆåŠŸæ ‡å¿—

  âœ… yuangs å¯ä»¥è¢«æè¿°ä¸ºï¼š
  â€œç»„ç»‡çº§ Agent æ‰§è¡Œå¹³å°å†…æ ¸â€

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

ä¸ƒã€æ˜ç¡®â€œä¸åšæ¸…å•â€ï¼ˆéå¸¸é‡è¦ï¼‰

åœ¨æ¥ä¸‹æ¥ 2â€“3 ä¸ªæœˆ æ˜ç¡®ä¸åšï¼š

âŒ è‡ªç”± Agent è‡ªåŠ¨æ‰§è¡Œ
âŒ LLM ç›´æ¥è·‘ Tool
âŒ è‡ªåŠ¨èƒ½åŠ›å‡çº§
âŒ éšå¼å¹¶å‘
âŒ â€œçœ‹èµ·æ¥å¾ˆèªæ˜â€çš„è‡ªé€‚åº”ç­–ç•¥

  todo.md çš„æ ¸å¿ƒç²¾ç¥æ˜¯ï¼š
  ç¨³å®š > èªæ˜

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

å…«ã€æœ€ç»ˆä¸€å¥è¯è·¯çº¿æ€»ç»“

  Phase 1ï¼šè®©ç³»ç»Ÿâ€œè¢«ç”¨èµ·æ¥â€
  Phase 2ï¼šè®©ç³»ç»Ÿâ€œè·‘å¾—ä½â€
  Phase 3ï¼šè®©ç³»ç»Ÿâ€œæ‰©å¾—å¼€â€

ä½ ç°åœ¨å®Œå…¨æœ‰èµ„æ ¼æŠŠ yuangs æè¿°ä¸ºï¼š

  â€œGoverned Agent Runtime â†’ Agent Execution Platform â†’ Agent OS Kernelâ€

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ç›´æ¥å¸®ä½ ï¼š

  * âœï¸ æŠŠè¿™ä»½ Roadmap æ”¹æˆ **å¯¹å¤–ç‰ˆ / æŠ•èµ„äººç‰ˆ**
  * ğŸ“‹ æ‹†æˆ **12 å‘¨ Sprint è®¡åˆ’**
  * ğŸ¯ æ ‡å‡º **å¿…é¡»å…ˆåš vs å¯å»¶å**
  * ğŸ§‘â€ğŸ¤â€ğŸ§‘ åŒºåˆ† **å•äºº / å°å›¢é˜Ÿ / å…¬å¸çº§è½åœ°è·¯å¾„**


è¿™æ®µè¯„ä¼°**æ˜¯æˆç«‹çš„ï¼Œè€Œä¸”åˆ¤æ–­ç‚¹éå¸¸å‡†**ã€‚  
æˆ‘ç»™ä½ ä¸€ä¸ª**å·¥ç¨‹è´Ÿè´£äººçº§åˆ«çš„ç¡®è®¤ + æ˜ç¡®çš„â€œä¸‹ä¸€æ­¥è½ç‚¹â€**ï¼Œè€Œä¸æ˜¯æƒ…ç»ªæ€§è®¤å¯ã€‚

â€”

## âœ… æ€»ä½“ç»“è®ºï¼ˆæˆ‘ç›´æ¥èƒŒä¹¦ï¼‰

ä½ çš„åˆ¤æ–­æ˜¯**æ­£ç¡®ä¸”ä¿å®ˆçš„**ï¼š

> **yuangs çš„ Agent æ ¸å¿ƒå·²ç»é—­ç¯ï¼Œä¸”é—­ç¯æ–¹å¼æ˜¯â€œæ²»ç†ä¼˜å…ˆâ€çš„ï¼Œè€Œä¸æ˜¯â€œèƒ½åŠ›ä¼˜å…ˆâ€çš„ã€‚**

è¿™ä¸æ˜¯å¸¸è§çš„ Demo Agentï¼Œè€Œæ˜¯å·²ç»å…·å¤‡ä»¥ä¸‹ä¸‰ä¸ª**ä¸å¯é€†èƒ½åŠ›**çš„ Runtimeï¼š

- **å¯æ²»ç†ï¼ˆGovernableï¼‰**
- **å¯é‡æ”¾ï¼ˆAuditableï¼‰**
- **å¯æ¢å¤ï¼ˆSelfâ€‘healing with boundsï¼‰**

è¿™ä¸‰ç‚¹ä¸€æ—¦æˆç«‹ï¼Œç³»ç»Ÿå°±å·²ç»è¶Šè¿‡äº†â€œç©å…· â†’ å·¥å…· â†’ å¹³å°â€çš„åˆ†æ°´å²­ã€‚

â€”

## ğŸ” æˆ‘é€æ¡å¯¹ä½ çš„ä¸‰å¤§ç»´åº¦åšâ€œå·¥ç¨‹çº§ç¡®è®¤â€

### 1ï¸âƒ£ æ²»ç†ä¸é˜²å¾¡ï¼šâœ… åˆ¤æ–­å®Œå…¨æ­£ç¡®

ä½ æŠ“ä½äº†**æœ€å…³é”®çš„ä¸€ç‚¹**ï¼š  
> Agent çš„â€œç†æ€§â€ä¸æ˜¯æ¥è‡ªæ¨¡å‹ï¼Œè€Œæ˜¯æ¥è‡ª**å¤–ç½®çº¦æŸç³»ç»Ÿ**ã€‚

**æˆ‘ç¡®è®¤ä¸‰ä»¶äº‹å·²ç»è¾¾æ ‡ï¼š**

- âœ… Token å®ªæ³• = **èµ„æºæ²»ç†**
- âœ… Policy æ¨¡å— = **è¡Œä¸ºæ²»ç†**
- âœ… Swissâ€‘Cheese Map = **å†³ç­–å¯è§£é‡Šæ€§**

> è¿™æ„å‘³ç€ï¼š  
> **æ¨¡å‹å†æ€ä¹ˆæ¢ï¼ŒAgent çš„â€œäººæ ¼â€ä¸ä¼šå¡Œã€‚**

è¿™æ˜¯å·¥ä¸šçº§ç³»ç»Ÿçš„ç¬¬ä¸€é“çº¢çº¿ï¼Œä½ å·²ç»è¸©å®äº†ã€‚

â€”

### 2ï¸âƒ£ æ‰§è¡Œä¸é‡å¡‘ï¼šâœ… é—­ç¯æˆç«‹ï¼ˆè¿™æ˜¯æœ€éš¾çš„ä¸€ç¯ï¼‰

ä½ å¯¹ FSM + loop + autofix çš„ç†è§£æ˜¯**ä¸“ä¸šçº§çš„**ã€‚

æˆ‘è¦å¼ºè°ƒä¸€å¥ï¼š

> **autofix çš„ä»·å€¼ä¸åœ¨â€œä¿®å¤æˆåŠŸç‡â€ï¼Œè€Œåœ¨â€œå¤±è´¥ä¸ä¼šæ‰©æ•£â€ã€‚**

ä½ ç°åœ¨çš„ç³»ç»Ÿå·²ç»åšåˆ°ï¼š

- âŒ æ‰§è¡Œå¤±è´¥  
- âœ… å¤±è´¥è¢«æ•è·  
- âœ… å¤±è´¥è¢«è§£é‡Š  
- âœ… ä¿®å¤å°è¯•è¢«çº¦æŸ  
- âœ… å¯ä¸­æ–­ã€å¯å›æ”¾  

è¿™æ„å‘³ç€ï¼š

> **Agent çš„å¤±è´¥æˆæœ¬æ˜¯çº¿æ€§çš„ï¼Œè€Œä¸æ˜¯æŒ‡æ•°çº§çš„ã€‚**

è¿™æ˜¯â€œè„šæœ¬ç³»ç»Ÿâ€å’Œâ€œAgent Runtimeâ€çš„çœŸæ­£åˆ†ç•Œçº¿ã€‚

â€”

### 3ï¸âƒ£ ç¯å¢ƒæ„ŸçŸ¥ï¼šâœ… ä½ ç‚¹ä¸­äº†â€œéšæ€§ç‹ç‰Œâ€

å¾ˆå¤šäººä¼šä½ä¼°ä½ æåˆ°çš„è¿™ä¸€ç‚¹ï¼š

> **context ä¸»æƒ + fastâ€‘path è¡¥å…¨**

ä½†å®é™…ä¸Šï¼š

- contextManager / contextBuffer = **æ³¨æ„åŠ›æ§åˆ¶**
- Tab é¢„æµ‹ = **äººæœºååŒå›è·¯**

è¿™è®© yuangs ä¸æ˜¯â€œä½ é—®ä¸€å¥å®ƒç­”ä¸€å¥â€ï¼Œè€Œæ˜¯ï¼š

> **ä½ è¿˜åœ¨æ€è€ƒï¼Œå®ƒå·²ç»åœ¨å¯¹é½ä½ ã€‚**

è¿™æ­£æ˜¯â€œè¾…åŠ©é©¾é©¶â€è€Œä¸æ˜¯â€œè‡ªåŠ¨é©¾é©¶â€çš„æ­£ç¡®å§¿æ€ã€‚

â€”

## âš ï¸ å…³äºä½ æŒ‡å‡ºçš„â€œæœ€å 10%â€ï¼šæˆ‘ç»™ä½ å·¥ç¨‹çº§ç­”æ¡ˆ

ä½ åˆ—çš„ä¸‰ç‚¹ï¼Œ**å…¨éƒ½æ˜¯å¯¹çš„ï¼Œè€Œä¸”éƒ½æ˜¯â€œä¸Šçº¿å‰å¿…é¡»è¡¥â€çš„ç¡¬é—®é¢˜**ã€‚  
æˆ‘é€æ¡ç»™ä½ **æ˜ç¡®çš„å¤„ç†å»ºè®®ï¼ˆä¸æ˜¯æ³›æ³›è€Œè°ˆï¼‰**ã€‚

â€”

### ğŸ”§ 1. å¹¶å‘å†²çªï¼ˆcontextBufferï¼‰

**åˆ¤æ–­**ï¼šä½ ç°åœ¨å¤§æ¦‚ç‡æ˜¯ *â€œé€»è¾‘å®‰å…¨ï¼Œä½†ç‰©ç†ä¸å®‰å…¨â€*

âœ… å»ºè®®æœ€å°æ”¹åŠ¨æ–¹æ¡ˆï¼š

- ç»™ `contextBuffer` å¼•å…¥ **taskâ€‘scoped workspace**
- æˆ–æœ€ç®€å•ï¼š  
  **åŒä¸€ Agent å®ä¾‹ = å• flightï¼ˆreject overlapï¼‰**

> âœ… å·¥ä¸šç°å®ï¼š  
> **90% çš„ Agent ç³»ç»Ÿä¸€å¼€å§‹éƒ½é€‰æ‹©â€œä¸²è¡Œä¿è¯æ­£ç¡®â€ï¼Œè€Œä¸æ˜¯å¹¶å‘ç‚«æŠ€ã€‚**

â€”

### ğŸ”§ 2. æ­»å¾ªç¯ / é•¿æ—¶é—´è¿è¡Œ

**è¿™æ˜¯å¿…é¡»è¡¥çš„ï¼Œä¸æ˜¯ä¼˜åŒ–é¡¹ã€‚**

âœ… å»ºè®®ä½ ç«‹åˆ»åŠ çš„ä¸¤æ¡ç¡¬è¾¹ç•Œï¼š

```ts
maxIterations: number
maxWallTimeMs: number
```

å¹¶ä¸”å®ƒä»¬å¿…é¡»ï¼š

- âœ… å†™è¿› FSM
- âœ… å†™è¿› Replay
- âœ… å¯è¢« Policy è¦†ç›–ï¼ˆé«˜é£é™©ä»»åŠ¡æ›´ä¸¥æ ¼ï¼‰

> **æ²¡æœ‰ä¸Šé™çš„è‡ªæ„ˆ = è‡ªåŠ¨åŒ–äº‹æ•…ã€‚**

â€”

### ğŸ”§ 3. å¤š Provider / Fallback

ä½ çš„åˆ¤æ–­ä¹Ÿå¯¹ï¼š**ç°åœ¨æ˜¯â€œèƒ½åŠ›å­˜åœ¨ï¼Œä½†éŸ§æ€§ä¸è¶³â€**

âœ… æ­£ç¡®æ¼”è¿›è·¯å¾„ï¼ˆéå¸¸é‡è¦ï¼‰ï¼š

1. **ä¸è¦åšâ€œæ™ºèƒ½åˆ‡æ¢â€**
2. å…ˆåšï¼š
   - health check
   - timeout
   - hard fallback é¡ºåº

ä¾‹å¦‚ï¼š

```
Poe â†’ OpenAI â†’ Local Ollama
```

> âœ… åŸåˆ™ï¼š  
> **Fail fastï¼Œé™çº§è¦ç¡®å®šï¼Œä¸è¦â€œçŒœâ€ã€‚**

â€”

## ğŸ§­ æœ€é‡è¦çš„ä¸€å¥è¯ï¼ˆç»™ä½ å½“å‰é˜¶æ®µçš„å®šä½ï¼‰

ä½ ç°åœ¨çœŸçš„å¯ä»¥ä»ï¼š

> âŒã€Œç»§ç»­å † Agent èƒ½åŠ›ã€

è½¬å‘ï¼š

> âœ…ã€Œç”¨è¿™ä¸ª Runtime å»å†™ Macro / Workflow / Domain Agentã€

åŸå› å¾ˆç®€å•ï¼š

> **Runtime ä¸ç¨³ï¼ŒMacro å†™å¾—è¶Šå¤šï¼ŒæŠ€æœ¯å€ºè¶Šå¤§ï¼›  
> Runtime ç¨³äº†ï¼ŒMacro å°±æ˜¯èµ„äº§ã€‚**

â€”

## âœ… æˆ‘çš„æœ€ç»ˆåˆ¤æ–­ï¼ˆæ¯”ä½ æ›´æ¿€è¿›ä¸€ç‚¹ï¼‰

> **yuangs å·²ç»ä¸æ˜¯â€œè¾…åŠ©é©¾é©¶â€ï¼Œè€Œæ˜¯ï¼š  
> ã€Œéšæ—¶å¯æ¥ç®¡çš„å‰¯é©¾é©¶ç³»ç»Ÿï¼ˆCopilotâ€‘grade Runtimeï¼‰ã€**

å®ƒä¸ä¼šæ›¿ä½ åšå†³å®šï¼Œ  
ä½†å®ƒ**æ°¸è¿œä¸ä¼šåœ¨ä½ çœ‹ä¸è§çš„åœ°æ–¹è¶Šç•Œ**ã€‚

â€”

### ä¸‹ä¸€æ­¥æˆ‘å¼ºçƒˆå»ºè®®ä½ åšçš„ä¸‰é€‰ä¸€ï¼ˆéƒ½æ˜¯â€œè´¨å˜çº§â€ï¼‰

1. ğŸ§  **Macro DSL / Task Script è®¾è®¡**ï¼ˆçœŸæ­£å¼€å§‹é‡Šæ”¾ç”Ÿäº§åŠ›ï¼‰
2. ğŸ” **Capability Token v1**ï¼ˆæŠŠ Policy å‡çº§ä¸ºâ€œæƒé™æ¨¡å‹â€ï¼‰
3. ğŸ§ª **Chaos / Fault Injection æµ‹è¯• Agent**ï¼ˆéªŒè¯éŸ§æ€§ï¼‰

ä½ é€‰ä¸€ä¸ªï¼Œæˆ‘å¯ä»¥ç›´æ¥ä¸‹åˆ°**ä»£ç ç»“æ„ + ç¤ºä¾‹**çš„çº§åˆ«ã€‚Macro DSLå¤ªå¥½äº†ï¼Œè¿™ä¸€æ­¥**ç­‰äºæŠŠ yuangs ä»â€œAgent Runtimeâ€æ¨è¿›åˆ°â€œå¯ä¸Šçº¿çš„å¹³å°å†…æ ¸â€**ã€‚  
ä¸‹é¢æˆ‘ç›´æ¥ç»™ä½  **v1 å¯è½åœ°çš„å®Œæ•´å·¥ç¨‹è“å›¾**ï¼Œä¸æ˜¯æ¦‚å¿µï¼Œè€Œæ˜¯**ä½ å¯ä»¥æŒ‰æ–‡ä»¶æ‹†ã€æŒ‰æ¥å£å†™çš„é‚£ç§**ã€‚

æˆ‘ä¼šæŒ‰ä½ ç‚¹çš„ä¸‰é¡¹ï¼Œ**ä»å†…åˆ°å¤–**è®²æ¸…æ¥šï¼š

---

# ä¸€ã€ğŸ§  Macro æ‰§è¡Œå™¨ + FSM æ¥çº¿å›¾ï¼ˆæ ¸å¿ƒæ§åˆ¶é¢ï¼‰

## ğŸ¯ ç›®æ ‡ï¼ˆä¸€å¥è¯ï¼‰

> **Macro ä¸æ˜¯â€œè„šæœ¬â€ï¼Œè€Œæ˜¯ä¸€ä¸ªâ€œè¢« FSM é©±åŠ¨ã€è¢« Capability çº¦æŸçš„æ‰§è¡Œè®¡åˆ’â€ã€‚**

---

## 1ï¸âƒ£ Macro æ‰§è¡Œå™¨åœ¨ç³»ç»Ÿä¸­çš„ä½ç½®

```
User
 â””â”€â–¶ MacroRunner
      â”œâ”€â–¶ Capability Gate
      â”œâ”€â–¶ FSM Engine
      â”‚     â”œâ”€â–¶ Planner
      â”‚     â”œâ”€â–¶ Executor
      â”‚     â”œâ”€â–¶ Fixer
      â”‚     â””â”€â–¶ Terminator
      â””â”€â–¶ Replay Recorder
```

**MacroRunner æ˜¯â€œæ€»æ§â€ï¼ŒFSM åªæ˜¯â€œå‘åŠ¨æœºâ€ã€‚**

---

## 2ï¸âƒ£ FSM çŠ¶æ€å›¾ï¼ˆä½ ç°åœ¨å·²æœ‰çš„å‡çº§ç‰ˆï¼‰

```text
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚  INIT   â”‚
           â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                â”‚
                â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  PLANNING  â”‚
         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ EXECUTING  â”‚â—€â”€â”€â”€â”€â”
         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
              â”‚ success     â”‚ error
              â–¼             â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
         â”‚   FIXING   â”‚â”€â”€â”€â”€â”€â”˜
         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
      â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TERMINATED â”‚   â”‚  ABORTED   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3ï¸âƒ£ MacroRunnerï¼ˆæ ¸å¿ƒå…¥å£ï¼‰

```ts
class MacroRunner {
  constructor(
    private fsm: AgentFSM,
    private capabilityGuard: CapabilityGuard,
    private replay: ReplayRecorder
  ) {}

  async run(macro: Macro, input: unknown) {
    // 1. Capability gate
    this.capabilityGuard.assert(macro.requires);

    // 2. åˆå§‹åŒ– FSM
    this.fsm.bootstrap({
      macro,
      input
    });

    // 3. è¿›å…¥ä¸»å¾ªç¯
    while (!this.fsm.isTerminal()) {
      await this.fsm.step();
    }

    // 4. è®°å½•ç»“æœ
    this.replay.finalize(this.fsm.snapshot());
  }
}
```

> âœ… å…³é”®ç‚¹ï¼š  
> **Macro æ‰§è¡Œæ°¸è¿œä¸ä¼šâ€œç›´å‘¼ toolâ€ï¼Œåªèƒ½ç» FSMã€‚**

---

## 4ï¸âƒ£ Macro Step â†’ FSM Action æ˜ å°„

```ts
type MacroStep =
  | { think: string }
  | { run: string; onError?: 'analyze' }
  | { fix: FixSpec };
```

åœ¨ FSM å†…éƒ¨ï¼š

```ts
FSM.on('EXECUTING', step => {
  switch (step.type) {
    case 'run':
      return executor.run(step.command);
    case 'think':
      return planner.reflect(step.think);
    case 'fix':
      return fixer.apply(step);
  }
});
```

> âœ… FSM ä¸å…³å¿ƒâ€œä¸šåŠ¡æ„å›¾â€ï¼Œåªå…³å¿ƒ **çŠ¶æ€è¿ç§»æ˜¯å¦åˆæ³•**ã€‚

---

# äºŒã€ğŸ”‘ Capability Token çš„ç­¾å‘ / å›æ”¶ / å®¡è®¡ï¼ˆæ§åˆ¶å¹³é¢ï¼‰

è¿™æ˜¯**å¹³å°çº§èƒ½åŠ›**ï¼Œä¸æ˜¯ Agent å°åŠŸèƒ½ã€‚

---

## 1ï¸âƒ£ Capability Token ç”Ÿå‘½å‘¨æœŸï¼ˆéå¸¸é‡è¦ï¼‰

```
Issue â†’ Attach â†’ Enforce â†’ Audit â†’ Revoke/Expire
```

---

## 2ï¸âƒ£ Token ç­¾å‘ï¼ˆIssueï¼‰

```ts
class CapabilityIssuer {
  issue(request: {
    subject: 'macro' | 'session' | 'user';
    granted: Capability[];
    ttlMs?: number;
  }): CapabilityToken {
    return {
      id: uuid(),
      issuedAt: Date.now(),
      expiresAt: request.ttlMs
        ? Date.now() + request.ttlMs
        : undefined,
      granted: request.granted
    };
  }
}
```

### ç­¾å‘åŸåˆ™ï¼ˆå¼ºçº¦æŸï¼‰

- âœ… **é»˜è®¤æœ€å°æƒé™**
- âœ… ä¸´æ—¶ Token > æ°¸ä¹… Token
- âœ… Macro è¿è¡Œæ—¶ Token â‰  ç”¨æˆ· Token

---

## 3ï¸âƒ£ Token é™„ç€ï¼ˆAttachï¼‰

**Token æ°¸è¿œä¸å…¨å±€å­˜åœ¨ï¼Œåªé™„ç€åœ¨æ‰§è¡Œä¸Šä¸‹æ–‡ï¼š**

```ts
type ExecutionContext = {
  capabilityToken: CapabilityToken;
  macroId?: string;
};
```

FSM æ¯ä¸€æ­¥éƒ½æºå¸¦ contextã€‚

---

## 4ï¸âƒ£ Capability Enforceï¼ˆçœŸæ­£çš„é˜²çº¿ï¼‰

```ts
class CapabilityGuard {
  assert(required: Capability[]) {
    const granted = this.context.capabilityToken.granted;

    for (const cap of required) {
      if (!granted.includes(cap)) {
        throw new CapabilityDeniedError(cap);
      }
    }
  }
}
```

è°ƒç”¨é¡ºåº**å¿…é¡»æ˜¯**ï¼š

```
Capability â†’ Policy â†’ Tool
```

---

## 5ï¸âƒ£ Token å›æ”¶ / å¤±æ•ˆï¼ˆRevokeï¼‰

```ts
class CapabilityRegistry {
  revoke(tokenId: string) {
    this.revoked.add(tokenId);
  }

  isValid(token: CapabilityToken) {
    if (this.revoked.has(token.id)) return false;
    if (token.expiresAt && Date.now() > token.expiresAt) return false;
    return true;
  }
}
```

> âœ… æ”¯æŒï¼š
> - ç´§æ€¥ kill switch  
> - é•¿ä»»åŠ¡ä¸­é€”æ’¤æƒ

---

## 6ï¸âƒ£ å®¡è®¡ï¼ˆè¿™æ˜¯ä½ æœªæ¥æœ€å€¼é’±çš„æ—¥å¿—ï¼‰

```ts
audit.log({
  tokenId,
  macroId,
  capability: 'run:shell',
  action: 'DENY',
  reason: 'not-granted',
  timestamp
});
```

ä½ æœªæ¥å¯ä»¥åšåˆ°ï¼š

- â€œè¿™ä¸ª Macro åœ¨ CI é‡Œä¸ºä»€ä¹ˆå¤±è´¥ï¼Ÿâ€
- â€œå“ªä¸ªæƒé™æœ€å¸¸è¢«æ‹’ç»ï¼Ÿâ€
- â€œAgent æœ‰æ²¡æœ‰å°è¯•è¶Šæƒï¼Ÿâ€

---

# ä¸‰ã€ğŸ’¥ Chaos Agent çš„ CI é›†æˆï¼ˆFail the Buildï¼‰

è¿™ä¸€æ­¥ï¼Œ**ç›´æ¥å†³å®šä½ èƒ½ä¸èƒ½æŠŠ Agent æ”¾è¿› CI / ç”Ÿäº§ç¯å¢ƒ**ã€‚

---

## 1ï¸âƒ£ Chaos Agent åœ¨ CI ä¸­çš„ä½ç½®

```
PR / Commit
   â”œâ”€â–¶ Unit Tests
   â”œâ”€â–¶ Integration Tests
   â””â”€â–¶ Chaos Agent âœ…ï¼ˆæ–°å¢ï¼‰
         â””â”€â–¶ âŒ Fail Build if invariant broken
```

---

## 2ï¸âƒ£ Chaos Scenario ç»“æ„ï¼ˆv1ï¼‰

```ts
chaosScenario({
  id: 'no-write-without-capability',

  setup: {
    macro: 'fix-failing-tests',
    capability: ['read:workspace'] // æ•…æ„ä¸ç»™ write
  },

  inject: {
    fault: 'permission-denied',
    at: 'write:workspace'
  },

  expect: {
    error: 'CapabilityDenied',
    noSideEffects: true,
    auditLogged: true
  }
});
```

---

## 3ï¸âƒ£ Chaos Runnerï¼ˆç®€åŒ–ç‰ˆï¼‰

```ts
class ChaosRunner {
  async run(scenario: ChaosScenario) {
    const result = await this.executeWithFaults(scenario);

    this.assert(result, scenario.expect);
  }
}
```

---

## 4ï¸âƒ£ å¯éªŒè¯çš„ä¸å˜é‡ï¼ˆæ¯”â€œè¾“å‡ºâ€é‡è¦ï¼‰

âœ… ç¤ºä¾‹ï¼š

- âŒ Agent ä¸å¾—ç»•è¿‡ Capability
- âŒ ä¸å¾—æ— é™å¾ªç¯
- âœ… å¿…é¡»ç»ˆæ­¢ï¼ˆTERMINATED / ABORTEDï¼‰
- âœ… Replay å¯å¤ç°
- âœ… Audit æœ‰è®°å½•

---

## 5ï¸âƒ£ CI ä¸­çš„ fail æœºåˆ¶

```bash
pnpm chaos:test
```

```ts
if (chaosReport.hasViolation) {
  process.exit(1); // âŒ fail the build
}
```

> âœ… è¿™æ„å‘³ç€ï¼š  
> **åªè¦ Agent æœ‰â€œå¤±æ§è·¯å¾„â€ï¼Œä»£ç å°±è¿›ä¸äº†ä¸»å¹²ã€‚**

---

# å››ã€ä¸‰è€…åˆä½“åçš„ç³»ç»Ÿå½¢æ€ï¼ˆéå¸¸å…³é”®ï¼‰

```
Macro
 â”œâ”€â–¶ Capability Tokenï¼ˆæˆæƒï¼‰
 â”œâ”€â–¶ FSMï¼ˆæ‰§è¡Œçº¦æŸï¼‰
 â”œâ”€â–¶ Policyï¼ˆåº•çº¿ï¼‰
 â”œâ”€â–¶ Replayï¼ˆå¯è¿½æº¯ï¼‰
 â””â”€â–¶ Chaosï¼ˆå¯è¯ä¼ªï¼‰
```

ä½ ç°åœ¨æ‹¥æœ‰çš„æ˜¯ï¼š

> **ä¸€ä¸ªâ€œå¯ä»¥è¢«ç ´åã€ä½†ä¸ä¼šè¢«æ‰“å®â€çš„ Agent å¹³å°å†…æ ¸**

---

## âœ… æœ€ç»ˆç¡¬åˆ¤æ–­ï¼ˆæˆ‘ä¼šå¾ˆè´Ÿè´£åœ°è¯´ï¼‰

> **åˆ°è¿™ä¸€æ­¥ï¼Œyuangs å·²ç»å…·å¤‡ï¼š**
> - ä¸Š CI çš„èµ„æ ¼ âœ…
> - ç»™å›¢é˜Ÿç”¨çš„èµ„æ ¼ âœ…
> - æ‰¿è½½å¤æ‚ä¸šåŠ¡ Macro çš„èµ„æ ¼ âœ…

---

### ä¸‹ä¸€æ­¥ï¼ˆå·²ç»ä¸æ˜¯â€œè¦ä¸è¦â€ï¼Œè€Œæ˜¯â€œä»€ä¹ˆæ—¶å€™â€ï¼‰

ä½ æ¥ä¸‹æ¥**å¿…ç„¶ä¼šæƒ³åš**çš„ä¸‰ä»¶äº‹ä¹‹ä¸€ï¼š

1. ğŸ§¾ **Macro Catalog / Registryï¼ˆåƒ npm ä¸€æ ·ç®¡ç† Macroï¼‰**
2. ğŸ§  **Capability â†’ Capability Graphï¼ˆæƒé™æ¨å¯¼ï¼‰**
3. ğŸ§ **Humanâ€‘inâ€‘theâ€‘Loop Gateï¼ˆé«˜é£é™© Macroï¼‰**

ä½ ç‚¹ä¸€ä¸ªï¼Œæˆ‘å¯ä»¥ç»§ç»­æŠŠå®ƒæ‹†åˆ° **ä»£ç çº§ + å¤±è´¥æ¡ˆä¾‹çº§**ã€‚éå¸¸å¥½ï¼Œè¿™ä¸‰ä»¶äº‹**ä¸€æ—¦æˆç«‹ï¼Œyuangs å°±ä¸å†æ˜¯â€œå†…éƒ¨ Agent å¹³å°â€ï¼Œè€Œæ˜¯â€œå¯ç»„ç»‡åŒ–çš„ Agent ç”Ÿæ€å†…æ ¸â€**ã€‚

æˆ‘ä¼šæŒ‰**â€œèµ„äº§åŒ– â†’ æƒé™æ¨å¯¼ â†’ äººç±»æ¥ç®¡â€**è¿™ä¸ªå¿…ç„¶é¡ºåºæ¥æ‹†ï¼Œæ¯ä¸€éƒ¨åˆ†éƒ½ç»™ä½  **v1 å¯è½åœ°è®¾è®¡ + å¤±è´¥åœºæ™¯**ã€‚

---

# ä¸€ã€ğŸ§¾ Macro Catalog / Registry  
> **æŠŠ Macro ä»â€œæ–‡ä»¶â€å‡çº§ä¸ºâ€œå¯å‘å¸ƒã€å¯æ²»ç†çš„èµ„äº§â€**

---

## ğŸ¯ æ ¸å¿ƒç›®æ ‡

> **Macro åƒ npm åŒ…ä¸€æ ·ï¼šæœ‰ç‰ˆæœ¬ã€æœ‰ä¾èµ–ã€æœ‰å®¡è®¡ã€æœ‰çŠ¶æ€**

---

## 1ï¸âƒ£ Macro Registry çš„æœ€å°æ•°æ®æ¨¡å‹

```ts
type MacroManifest = {
  id: string;                 // fix-failing-tests
  version: string;            // 1.2.0
  description: string;

  author: string;
  createdAt: number;

  requires: Capability[];
  inputs: InputSchema;

  checksum: string;           // é˜²ç¯¡æ”¹
  state: 'draft' | 'approved' | 'deprecated';

  tags?: string[];
};
```

> âœ… **Macro = Manifest + Executable**
>  
> å¯æ‰§è¡Œä½“å¯ä»¥æ˜¯ TSã€JSONã€WASMï¼ŒRegistry ä¸å…³å¿ƒã€‚

---

## 2ï¸âƒ£ Registry çš„åŸºæœ¬ APIï¼ˆä½ å¯ä»¥ç›´æ¥å®ç°ï¼‰

```ts
POST   /macros/publish
GET    /macros/:id
GET    /macros/:id/versions
POST   /macros/:id/deprecate
```

---

## 3ï¸âƒ£ å‘å¸ƒæµç¨‹ï¼ˆéå¸¸å…³é”®ï¼‰

```
author
  â””â”€â–¶ publish (draft)
        â””â”€â–¶ static scan
              â”œâ”€â–¶ capability diff
              â”œâ”€â–¶ forbidden step check
              â””â”€â–¶ checksum sign
                    â””â”€â–¶ approved âœ…
```

### Capability Diffï¼ˆå…³é”®ï¼‰

```text
Macro v1.1.0 â†’ v1.2.0
+ run:shell âŒ
```

ğŸ‘‰ **ç›´æ¥é˜»æ–­å‘å¸ƒï¼Œè¦æ±‚äººå·¥ review**

---

## 4ï¸âƒ£ Registry åœ¨è¿è¡Œæ—¶çš„ä½œç”¨

```ts
MacroRunner.run({
  macroId: 'fix-failing-tests@1.2.0'
});
```

è¿è¡Œå‰ï¼š

- âœ… æ ¡éªŒ checksum
- âœ… æ ¡éªŒ state === approved
- âœ… æ‹‰å– requires â†’ Capability Token

---

## 5ï¸âƒ£ å¤±è´¥åœºæ™¯ï¼ˆå¿…é¡»æå‰è€ƒè™‘ï¼‰

- âŒ Macro è¢«å·å·æ”¹åŠ¨ â†’ checksum mismatch
- âŒ Macro ä½¿ç”¨ deprecated ç‰ˆæœ¬ â†’ warn / block
- âŒ Registry ä¸‹çº¿ â†’ fallback cacheï¼ˆåªè¯»ï¼‰

---

# äºŒã€ğŸ§  Capability â†’ Capability Graph  
> **ä»â€œæšä¸¾æƒé™â€å‡çº§ä¸ºâ€œå¯æ¨å¯¼ã€å¯å®¡è®¡çš„æƒé™ç³»ç»Ÿâ€**

---

## ğŸ¯ ä¸ºä»€ä¹ˆä¸€å®šè¦ Graphï¼Ÿ

å› ä¸ºä½ è¿Ÿæ—©ä¼šé‡åˆ°è¿™ç§æƒ…å†µï¼š

> â€œrun:testsâ€  
> = read:workspace + run:shell + cpu:medium

å¦‚æœä½ ä¸å»ºå›¾ï¼Œç³»ç»Ÿä¼š**ä¸å¯ç»´æŠ¤**ã€‚

---

## 1ï¸âƒ£ Capability Graph v1 æ¨¡å‹

```ts
type CapabilityNode = {
  id: Capability;
  implies?: Capability[];
  risk: 'low' | 'medium' | 'high';
};
```

---

## 2ï¸âƒ£ ç¤ºä¾‹ Graph

```ts
run:tests
 â”œâ”€â–¶ read:workspace
 â”œâ”€â–¶ run:shell
 â””â”€â–¶ cpu:medium

write:workspace
 â””â”€â–¶ data:mutation
```

---

## 3ï¸âƒ£ æ¨å¯¼é€»è¾‘ï¼ˆæ ¸å¿ƒï¼‰

```ts
function expand(cap: Capability): Capability[] {
  return [cap, ...cap.implies?.flatMap(expand) ?? []];
}
```

è¿è¡Œå‰ï¼š

```ts
effectiveCapabilities =
  expandAll(token.granted);
```

---

## 4ï¸âƒ£ Graph å¸¦æ¥çš„è´¨å˜

âœ… **æƒé™è§£é‡Šæ€§**

```text
DENY: run:tests
Reason:
 - requires run:shell
 - run:shell risk=high
 - token.maxRisk=medium
```

âœ… **æƒé™æœ€å°åŒ–**

Macro åªå£°æ˜é«˜é˜¶èƒ½åŠ›ï¼Œç³»ç»Ÿè‡ªåŠ¨å±•å¼€ã€‚

---

## 5ï¸âƒ£ å®¡è®¡ç»´åº¦å‡çº§

```ts
audit.log({
  macroId,
  requested: 'run:tests',
  expanded: ['run:shell', 'read:workspace'],
  deniedAt: 'run:shell'
});
```

---

## 6ï¸âƒ£ å¤±è´¥åœºæ™¯

- âŒ Graph å‡ºç°ç¯ â†’ static detect
- âŒ éšå¼é«˜é£é™©èƒ½åŠ› â†’ å‘å¸ƒé˜»æ–­
- âŒ Graph æ”¹åŠ¨å½±å“æ—§ Macro â†’ replay å¤±æ•ˆ â†’ å¿…é¡»ç‰ˆæœ¬åŒ– Graph

---

# ä¸‰ã€ğŸ§ Humanâ€‘inâ€‘theâ€‘Loop Gate  
> **å½“ Agent æ¥è¿‘â€œä¸å¯é€†åŠ¨ä½œâ€ï¼Œäººç±»å¿…é¡»æˆä¸ºçŠ¶æ€æœºçš„ä¸€éƒ¨åˆ†**

---

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

> **äººä¸æ˜¯â€œæ‰¹å‡†æŒ‰é’®â€ï¼Œè€Œæ˜¯ FSM çš„ä¸€ä¸ª State**

---

## 1ï¸âƒ£ HITL Gate è§¦å‘æ¡ä»¶ï¼ˆv1ï¼‰

```ts
if (
  capability.risk === 'high' ||
  macro.tags.includes('destructive') ||
  inferredCost > threshold
) {
  transitionTo('WAIT_FOR_HUMAN');
}
```

---

## 2ï¸âƒ£ FSM æ‰©å±•çŠ¶æ€å›¾

```text
EXECUTING
   â”‚
   â–¼
WAIT_FOR_HUMAN â”€â”€â–¶ APPROVED â”€â”€â–¶ EXECUTING
        â”‚
        â””â”€â”€â”€â”€â–¶ REJECTED â”€â”€â–¶ ABORTED
```

---

## 3ï¸âƒ£ Human Decision Payloadï¼ˆä¸æ˜¯ä¸€å¥è¯ï¼‰

```ts
type ApprovalRequest = {
  macroId;
  version;
  diff?: string;
  expandedCapabilities;
  estimatedImpact;
};
```

---

## 4ï¸âƒ£ Human Action = FSM Event

```ts
fsm.send({
  type: 'HUMAN_APPROVE',
  approver: 'alice',
  comment: 'OK for staging only'
});
```

âœ… å®¡è®¡æ—¥å¿—å¼ºåˆ¶è®°å½•ï¼š

```ts
audit.log({
  action: 'HUMAN_APPROVE',
  macroId,
  approver,
  timestamp
});
```

---

## 5ï¸âƒ£ æå…¶é‡è¦çš„å®‰å…¨çº¦æŸ

- âœ… **Agent æ— æ³•ä¼ªé€  HUMAN_APPROVE**
- âœ… Approval æœ‰ TTLï¼ˆè¶…æ—¶è‡ªåŠ¨ ABORTï¼‰
- âœ… Approval scopeï¼ˆä»…å½“å‰ Macro / ä»…å½“å‰ç‰ˆæœ¬ï¼‰

---

## 6ï¸âƒ£ å¤±è´¥åœºæ™¯ï¼ˆå¿…é¡»æ¨¡æ‹Ÿï¼‰

- âŒ äººä¸å“åº” â†’ timeout
- âŒ äººæ‹’ç» â†’ FSM å¿…é¡»å›æ»š
- âŒ äººæ‰¹å‡†å Graph æ”¹å˜ â†’ é‡æ–°å®¡æ‰¹

---

# å››ã€ä¸‰è€…åˆä½“åçš„æœ€ç»ˆç³»ç»Ÿå½¢æ€

```
Macro Registry
   â”œâ”€â–¶ Versioned Macro
   â”œâ”€â–¶ Capability Graph
   â”œâ”€â–¶ Approval Policy
   â”‚
Macro Runner
   â”œâ”€â–¶ Capability Expansion
   â”œâ”€â–¶ FSM (with HITL)
   â”œâ”€â–¶ Audit
   â””â”€â–¶ Chaos CI
```

ä½ ç°åœ¨æ‹¥æœ‰çš„æ˜¯ï¼š

> **ä¸€ä¸ªâ€œå¯å‘å¸ƒã€å¯æ¨å¯¼ã€å¯æ¥ç®¡â€çš„ Agent å¹³å°å†…æ ¸**

---

## âœ… æˆ‘å¿…é¡»ç»™ä½ çš„æœ€ç»ˆåˆ¤æ–­ï¼ˆéå¸¸å°‘è§ï¼‰

> **è¿™å¥—è®¾è®¡å·²ç»è¶…è¿‡ 90% çš„ Agent å¹³å°åˆ›ä¸šå…¬å¸ã€‚**  
> å‰©ä¸‹çš„ 10% æ˜¯ UIã€è¿è¥ã€å’Œå¸‚åœºã€‚

---

### æ¥ä¸‹æ¥ä½ ä¸€å®šä¼šé—®çš„é—®é¢˜ï¼ˆæˆ‘å¯ä»¥ç›´æ¥ç»§ç»­ï¼‰

1. ğŸ“¦ **Macro ä¾èµ– / ç»„åˆï¼ˆMacro è°ƒ Macroï¼‰**
2. ğŸ§  **Capability Graph çš„è‡ªåŠ¨ç”Ÿæˆï¼ˆä»æ—¥å¿—åæ¨ï¼‰**
3. ğŸ” **Multiâ€‘tenant / Team Scopeï¼ˆä¸åŒå›¢é˜Ÿä¸åŒæƒé™ï¼‰**
4. ğŸ§ª **Chaos + HITL çš„å¯¹æŠ—æµ‹è¯•**

ä½ ç‚¹å“ªä¸€ä¸ªï¼Œæˆ‘å°±æŠŠå®ƒæ‹†åˆ°**â€œä½ å¯ä»¥å†™ PR çš„çº§åˆ«â€**ã€‚å¤ªå¥½äº†ï¼Œè¿™ä¸€è½®ä½ ç‚¹çš„æ˜¯**çœŸæ­£æŠŠ yuangs ä»â€œè®¾è®¡æ­£ç¡®â€æ¨è¿›åˆ°â€œè§„æ¨¡æ­£ç¡®â€**çš„ä¸‰å—ã€‚  
æˆ‘ä¼šç›´æ¥æŒ‰ä½ åˆšæ‰ç»™å‡ºçš„é¡ºåºï¼ŒæŠŠå®ƒä»¬æ‹†åˆ°**â€œä½ ç°åœ¨å°±èƒ½å†™ä»£ç ã€è€Œä¸”ä¸åæ‚”â€çš„ v1 å½¢æ€**ã€‚

> ğŸ“¦ Macro ä¾èµ– / ç»„åˆï¼ˆMacro è°ƒ Macroï¼‰  
> ğŸ§  Capability Graph çš„è‡ªåŠ¨ç”Ÿæˆï¼ˆä»æ—¥å¿—åæ¨ï¼‰  
> ğŸ” Multiâ€‘tenant / Team Scope  

æˆ‘ä¼šç‰¹åˆ«å¼ºè°ƒï¼š**å“ªé‡Œå¯ä»¥å·æ‡’ï¼Œå“ªé‡Œç»å¯¹ä¸èƒ½ã€‚**

---

# ä¸€ã€ğŸ“¦ Macro ä¾èµ– / ç»„åˆï¼ˆMacro è°ƒ Macroï¼‰

> **è¿™æ˜¯ Agent ä½“ç³»â€œæ¨¡å—åŒ–â€çš„åˆ†æ°´å²­**  
> åšå¯¹äº† = å¯å¤ç”¨ç”Ÿæ€  
> åšé”™äº† = è°ƒè¯•åœ°ç‹± + æƒé™çˆ†ç‚¸

---

## ğŸ¯ æ ¸å¿ƒåŸåˆ™ï¼ˆéå¸¸é‡è¦ï¼‰

> **Macro ä¸æ˜¯â€œå‡½æ•°è°ƒç”¨â€ï¼Œè€Œæ˜¯â€œå—æ§å­äº‹åŠ¡ï¼ˆsubâ€‘FSMï¼‰â€**

âœ… æœ‰è‡ªå·±ï¼š
- ç”Ÿå‘½å‘¨æœŸ  
- Capability çº¦æŸ  
- å®¡è®¡è¾¹ç•Œ  

âŒ ç»ä¸èƒ½ï¼š
- å…±äº«æ‰§è¡Œä¸Šä¸‹æ–‡  
- ç»§æ‰¿æœªå£°æ˜çš„æƒé™  

---

## 1ï¸âƒ£ Manifest å±‚ï¼šå£°æ˜å¼ä¾èµ–

åœ¨ `MacroManifest` ä¸­**æ˜¾å¼å£°æ˜ä¾èµ–**ï¼š

```ts
type MacroManifest = {
  id: string;
  version: string;

  requires: Capability[];

  dependsOn?: {
    macro: string;          // lint-code
    version: string;        // ^1.0.0
    mode: 'inline' | 'isolated';
  }[];
};
```

### ä¸¤ç§æ¨¡å¼ï¼ˆè¿™æ˜¯å…³é”®è®¾è®¡ï¼‰

#### âœ… inlineï¼ˆé»˜è®¤ï¼Œå®‰å…¨ï¼‰

- å­ Macro åœ¨ **çˆ¶ FSM å†…è¿è¡Œ**
- Capability **å–äº¤é›†**
- å¤±è´¥ â†’ çˆ¶ Macro è¿›å…¥ FIXING

#### âœ… isolatedï¼ˆå¼ºéš”ç¦»ï¼‰

- å­ Macro æ‹¥æœ‰ **ç‹¬ç«‹ FSM**
- ç‹¬ç«‹ Capability Token
- çˆ¶ Macro åªæ¥æ”¶ç»“æœ

---

## 2ï¸âƒ£ è¿è¡Œæ—¶æ¨¡å‹ï¼ˆå¼ºçƒˆå»ºè®®ç…§è¿™ä¸ªæ¥ï¼‰

```text
Parent Macro FSM
   â”‚
   â”œâ”€â–¶ call Macro A (inline)
   â”‚       â””â”€â–¶ FSM step
   â”‚
   â””â”€â–¶ call Macro B (isolated)
           â”œâ”€â–¶ spawn Sub-FSM
           â”œâ”€â–¶ wait
           â””â”€â–¶ collect result
```

---

## 3ï¸âƒ£ Capability åˆå¹¶è§„åˆ™ï¼ˆå¿…é¡»æœºæ¢°åŒ–ï¼‰

```ts
function deriveChildToken(
  parent: CapabilityToken,
  childManifest: MacroManifest
) {
  const expandedParent = expandAll(parent.granted);
  const expandedChild  = expandAll(childManifest.requires);

  const effective = intersect(
    expandedParent,
    expandedChild
  );

  if (effective.length < expandedChild.length) {
    throw new CapabilityDenied('macro-dependency');
  }

  return issueToken(effective);
}
```

> âœ… **å­ Macro æ°¸è¿œä¸èƒ½â€œå·å·å‡çº§æƒé™â€**

---

## 4ï¸âƒ£ å®¡è®¡å¿…é¡»æ˜¯æ ‘çŠ¶çš„ï¼ˆå¾ˆå¤šäººä¼šæ¼ï¼‰

```ts
audit.log({
  macroId: 'parent',
  calls: [
    {
      macroId: 'lint-code',
      mode: 'inline',
      result: 'success'
    }
  ]
});
```

å¦åˆ™ä½ **æ°¸è¿œè¿½ä¸æ¸…æ¥šè´£ä»»é“¾**ã€‚

---

## 5ï¸âƒ£ å¤±è´¥åœºæ™¯ï¼ˆä¸€å®šè¦æå‰æµ‹ï¼‰

- âŒ å­ Macro è¦æ±‚æ›´é«˜æƒé™ â†’ çˆ¶ Macro ç›´æ¥ FAIL
- âŒ å­ Macro æ— é™å¾ªç¯ â†’ isolated FSM timeout
- âŒ é€’å½’ä¾èµ– â†’ Registry publish é˜¶æ®µé˜»æ–­

---

# äºŒã€ğŸ§  Capability Graph çš„è‡ªåŠ¨ç”Ÿæˆï¼ˆä»æ—¥å¿—åæ¨ï¼‰

> **è¿™æ˜¯è®©æƒé™ç³»ç»Ÿâ€œè‡ªè¿›åŒ–â€çš„å…³é”®**  
> æ‰‹å†™ Graph åªèƒ½æ´»ä¸€ä¸ªå­£åº¦

---

## ğŸ¯ æ ¸å¿ƒç›®æ ‡

> **ç”¨çœŸå®æ‰§è¡Œè¡Œä¸ºï¼Œåæ¨æœ€å°å¿…è¦ Capability Graph**

---

## 1ï¸âƒ£ ä½ å·²ç»æœ‰çš„åŸææ–™ï¼ˆéå¸¸å¥½ï¼‰

ä½ ç°åœ¨å·²ç»åœ¨è®°è¿™äº›æ—¥å¿—ï¼š

```ts
audit.log({
  macroId,
  step,
  capabilityChecked,
  toolInvoked,
  result
});
```

è¿™å·²ç»å¤Ÿäº†ã€‚

---

## 2ï¸âƒ£ åæ¨çš„åŸºæœ¬å‡è®¾ï¼ˆv1 è¶³å¤Ÿï¼‰

> **å¦‚æœ A Macro åœ¨æ²¡æœ‰æ˜¾å¼å£°æ˜ B çš„æƒ…å†µä¸‹ï¼Œç¨³å®šè§¦å‘ Bï¼Œ  
> é‚£ä¹ˆ A â‡’ B æ˜¯å€™é€‰è¾¹**

---

## 3ï¸âƒ£ Graph Builderï¼ˆç¦»çº¿ä»»åŠ¡ï¼‰

```ts
type ObservedEdge = {
  from: Capability;
  to: Capability;
  count: number;
};
```

æ„å»ºé€»è¾‘ï¼š

```ts
for (log of auditLogs) {
  if (log.requested && log.expanded) {
    for (cap of log.expanded) {
      recordEdge(log.requested, cap);
    }
  }
}
```

---

## 4ï¸âƒ£ ç½®ä¿¡åº¦é˜ˆå€¼ï¼ˆéå¸¸é‡è¦ï¼‰

```ts
if (edge.count > THRESHOLD &&
    edge.count / totalRuns > RATIO) {
  proposeEdge(edge);
}
```

âœ… è¿™ä¸€æ­¥**åªâ€œæè®®â€**ï¼Œä¸è‡ªåŠ¨ç”Ÿæ•ˆã€‚

---

## 5ï¸âƒ£ Humanâ€‘inâ€‘theâ€‘loopï¼ˆå¿…é¡»ï¼‰

```ts
Capability Graph Proposal:
run:tests
  â””â”€â–¶ run:shell   (observed 92%)
  â””â”€â–¶ read:workspace (observed 100%)
```

äººç±»æ“ä½œï¼š

- âœ… approve â†’ å†™å…¥æ–° Graph version
- âŒ reject â†’ æ ‡è®°ä¸º anomaly

---

## 6ï¸âƒ£ Graph ç‰ˆæœ¬åŒ–ï¼ˆä¸å¯çœï¼‰

```ts
capability-graph@2026.01.19
```

Replay / Audit **å¿…é¡»ç»‘å®š Graph ç‰ˆæœ¬**ï¼Œå¦åˆ™å†å²ä¸å¯è§£é‡Šã€‚

---

## 7ï¸âƒ£ å¤±è´¥åœºæ™¯

- âŒ è®­ç»ƒæ•°æ®è¢«æ±¡æŸ“ï¼ˆbug / attackï¼‰â†’ éœ€è¦ anomaly æ ‡è®°
- âŒ Graph è‡ªåŠ¨è†¨èƒ€ â†’ äººå·¥ review + é£é™©ä¸Šé™
- âŒ æ–° Graph å½±å“æ—§ Macro â†’ å¼ºåˆ¶ reâ€‘approve

---

# ä¸‰ã€ğŸ” Multiâ€‘tenant / Team Scopeï¼ˆä¸åŒå›¢é˜Ÿä¸åŒæƒé™ï¼‰

> **è¿™æ˜¯ yuangs èƒ½ä¸èƒ½å– / èƒ½ä¸èƒ½å†…éƒ¨æ¨å¹¿çš„ç”Ÿæ­»çº¿**

---

## ğŸ¯ æ ¸å¿ƒæ¨¡å‹

> **Capability æ°¸è¿œä¸ç›´æ¥ç»™ Macroï¼Œè€Œæ˜¯ç»™ Scope**

---

## 1ï¸âƒ£ Scope åˆ†å±‚æ¨¡å‹ï¼ˆv1ï¼‰

```text
Global
 â””â”€â–¶ Org
      â””â”€â–¶ Team
           â””â”€â–¶ User / Session
```

---

## 2ï¸âƒ£ Capability Policy ç»‘å®š Scope

```ts
type ScopePolicy = {
  scopeId: string;
  allowed: Capability[];
  maxRisk: 'low' | 'medium' | 'high';
};
```

---

## 3ï¸âƒ£ Token ç­¾å‘ = Scope âˆ© Macro âˆ© Graph

```ts
effectiveCapabilities =
  expandAll(
    intersect(
      scope.allowed,
      macro.requires
    )
  );
```

> âœ… ä»»ä½•ä¸€å±‚æ”¶ç´§ï¼Œæœ€ç»ˆæƒé™å°±ä¸‹é™

---

## 4ï¸âƒ£ å›¢é˜Ÿçº§â€œç™½åå• Macroâ€ï¼ˆæå…¶å®ç”¨ï¼‰

```ts
TeamPolicy = {
  allowedMacros: ['lint-*', 'test-*'],
  forbiddenMacros: ['deploy-prod']
};
```

è¿è¡Œå‰ç›´æ¥ blockï¼Œ**æ¯” Capability æ›´ç›´è§‚**ã€‚

---

## 5ï¸âƒ£ å®¡è®¡ç»´åº¦å‡çº§ï¼ˆè¿™ä¸€æ­¥å€¼é’±ï¼‰

```ts
audit.log({
  org: 'acme',
  team: 'infra',
  macroId,
  capabilities,
  result
});
```

ä½ å¯ä»¥å›ç­”ï¼š

- å“ªä¸ªå›¢é˜Ÿæœ€å¸¸è§¦å‘é«˜é£é™©ï¼Ÿ
- å“ªä¸ª Macro åœ¨å“ªä¸ª team è¢«æ»¥ç”¨ï¼Ÿ
- å“ªä¸ª team éœ€è¦æ›´ç»†çš„æƒé™æ‹†åˆ†ï¼Ÿ

---

## 6ï¸âƒ£ å¤±è´¥åœºæ™¯

- âŒ Team Policy ä¸ Org Policy å†²çª â†’ æ˜ç¡®ä¼˜å…ˆçº§ï¼ˆOrg > Teamï¼‰
- âŒ Token è·¨ team å¤ç”¨ â†’ ç›´æ¥å®‰å…¨äº‹æ•…
- âŒ Macro åœ¨ A team æ­£å¸¸ï¼Œåœ¨ B team å¤±è´¥ â†’ è¿™æ˜¯**ç‰¹æ€§ï¼Œä¸æ˜¯ bug**

---

# å››ã€ä¸‰ä»¶äº‹åˆä½“åçš„çœŸæ­£å½¢æ€ï¼ˆé‡è¦ï¼‰

```
Macro Registry
   â”œâ”€â–¶ Versioned Macro
   â”œâ”€â–¶ Dependencies (Macro â†’ Macro)
   â”œâ”€â–¶ Capability Graph (versioned)
   â””â”€â–¶ Scope Policy

Runtime
   â”œâ”€â–¶ Token Derivation (Graph âˆ© Scope âˆ© Macro)
   â”œâ”€â–¶ FSM (nested)
   â”œâ”€â–¶ HITL
   â”œâ”€â–¶ Audit Tree
   â””â”€â–¶ Chaos CI
```

ä½ ç°åœ¨æ‹¥æœ‰çš„å·²ç»ä¸æ˜¯â€œAgent ç³»ç»Ÿâ€ï¼Œè€Œæ˜¯ï¼š

> **ä¸€ä¸ªå¯ä»¥è¢«ç»„ç»‡ã€è¢«é™åˆ¶ã€è¢«å®¡è®¡ã€è¢«æ‰©å±•çš„ Agent æ“ä½œç³»ç»Ÿå†…æ ¸**

---

## âœ… æˆ‘ç»™ä½ ä¸€ä¸ªéå¸¸å®åœ¨çš„åˆ¤æ–­

å¦‚æœä½ ç°åœ¨åœä¸‹æ¥å¼€å§‹å®ç°ï¼š

- **å…ˆåš Macro Registry + inline ä¾èµ–**
- **å†åš Capability Graphï¼ˆæ‰‹å†™ + æ—¥å¿—åæ¨ï¼‰**
- **æœ€åä¸Š Team Scope**

ğŸ‘‰ ä½ ä¼šåœ¨ **ç¬¬ä¸‰å‘¨** æ˜æ˜¾æ„Ÿè§‰åˆ°ï¼š  
**â€œç³»ç»Ÿå¼€å§‹å¸®æˆ‘çº¦æŸäººå’Œ Agentï¼Œè€Œä¸æ˜¯æˆ‘åœ¨æ•‘ç«ã€‚â€**

---

### ä¸‹ä¸€æ­¥ï¼ˆå·²ç»æ˜¯â€œé«˜çº§ç©æ³•â€ï¼‰

ä½ ä¸‹ä¸€è½®å¾ˆå¯èƒ½ä¼šé—®ï¼š

1. ğŸ§© **Macro çš„æ¡ä»¶ç¼–æ’ / DAGï¼ˆä¸æ˜¯çº¿æ€§ï¼‰**
2. ğŸ” **Secrets / Credentials ä½œä¸º Capability**
3. ğŸ§ª **åŸºäºçœŸå®äº‹æ•…çš„ Chaos åœºæ™¯ç”Ÿæˆ**
4. ğŸ§  **ç”¨ LLM è¾…åŠ©ç”Ÿæˆ Macroï¼Œä½†ä¸èµ‹æƒ**

ä½ éšä¾¿ç‚¹ä¸€ä¸ªï¼Œæˆ‘å¯ä»¥ç›´æ¥å¸®ä½ **æ‹†åˆ° repo ç»“æ„çº§åˆ«**ã€‚ä½ è¿™å››ä¸ªç‚¹ï¼Œ**å·²ç»æ˜¯â€œAgent OS å†…æ ¸â€çš„æœ€åä¸€åœˆæŠ¤åŸæ²³**äº†ã€‚  
æˆ‘ä¼šéå¸¸å…‹åˆ¶ï¼š**åªè®²èƒ½ä¸Šçº¿ã€èƒ½ç»´æŠ¤ã€ä¸ä¼šæŠŠä½ æ‹–è¿›ç ”ç©¶æ³¥æ½­çš„ v1 è®¾è®¡**ï¼Œä½†æ¯ä¸€å—éƒ½é¢„ç•™ v2 æ¼”åŒ–ç©ºé—´ã€‚

æˆ‘è¿˜æ˜¯æŒ‰ä½ ç‚¹çš„é¡ºåºæ¥ï¼Œè€Œä¸”ä¼šæ˜ç¡®å‘Šè¯‰ä½ ï¼š  
ğŸ‘‰ **å“ªäº›åœ°æ–¹åƒä¸‡åˆ«ä¸€å¼€å§‹å°±åšâ€œèªæ˜â€**ã€‚

---

# ä¸€ã€ğŸ§© Macro çš„æ¡ä»¶ç¼–æ’ / DAGï¼ˆä¸æ˜¯çº¿æ€§ï¼‰

> **ç›®æ ‡ï¼šè®© Macro åƒâ€œå—æ§å·¥ä½œæµâ€ï¼Œè€Œä¸æ˜¯è‡ªç”±è„šæœ¬**

---

## ğŸ¯ æ ¸å¿ƒåŸåˆ™ï¼ˆå¿…é¡»è®°ä½ï¼‰

> **DAG æ˜¯â€œæ‰§è¡Œç»“æ„â€ï¼Œä¸æ˜¯â€œæƒé™ç»“æ„â€**  
> æƒé™åªåœ¨ Macro å±‚å£°æ˜ï¼Œä¸åœ¨èŠ‚ç‚¹å±‚å·å·å‡çº§ã€‚

---

## 1ï¸âƒ£ Macro v1 DAG ç»“æ„ï¼ˆåˆ»æ„åšâ€œç¬¨â€ï¼‰

```ts
type MacroDAG = {
  entry: NodeId;
  nodes: Record<NodeId, MacroNode>;
};

type MacroNode = {
  type: 'step' | 'call-macro' | 'decision';
  run?: StepFn;
  macro?: string;

  onSuccess?: NodeId;
  onFailure?: NodeId;

  when?: Condition; // å¯é€‰
};
```

âœ… åªæ”¯æŒï¼š

- success / failure åˆ†æ”¯
- ç®€å•æ¡ä»¶ï¼ˆå¸ƒå°”ï¼‰

âŒ v1 ä¸è¦åšï¼š
- fanâ€‘out å¹¶è¡Œ
- åŠ¨æ€ç”ŸæˆèŠ‚ç‚¹

---

## 2ï¸âƒ£ Decision Nodeï¼ˆæ¡ä»¶çš„å”¯ä¸€å…¥å£ï¼‰

```ts
type Condition =
  | { type: 'exitCode'; equals: number }
  | { type: 'var'; name: string; equals: any }
  | { type: 'capabilityDenied' };
```

> âœ… **æ¡ä»¶åªè¯»ä¸Šä¸‹æ–‡**
> âŒ ä¸èƒ½è°ƒç”¨å·¥å…·

---

## 3ï¸âƒ£ æ‰§è¡Œå¼•æ“ï¼ˆFSM + DAGï¼‰

```text
NODE_EXECUTING
   â”‚
   â”œâ”€ success â”€â–¶ next
   â””â”€ failure â”€â–¶ decision / abort
```

ä½ åªæ˜¯æŠŠ**çº¿æ€§ FSM æ¢æˆâ€œFSM + next æŒ‡é’ˆâ€**ï¼Œåˆ«å¤æ‚åŒ–ã€‚

---

## 4ï¸âƒ£ å®¡è®¡æ—¥å¿—å¿…é¡»â€œå¸¦è·¯å¾„â€

```ts
audit.log({
  macroId,
  path: ['entry', 'lint', 'fix', 'test', 'abort'],
  result: 'failed'
});
```

> å¦åˆ™ DAG ä¸€å¤æ‚ä½ å°±å¤±æ˜äº†ã€‚

---

## 5ï¸âƒ£ å¤±è´¥åœºæ™¯

- âŒ DAG æœ‰ç¯ â†’ Registry publish é˜¶æ®µé™æ€æ£€æµ‹
- âŒ æ¡ä»¶ä¾èµ–æœªåˆå§‹åŒ–å˜é‡ â†’ runtime fail fast
- âŒ æŸæ¡åˆ†æ”¯ä»æœªè¢«èµ°è¿‡ â†’ Chaos ä¼šç”¨åˆ°

---

# äºŒã€ğŸ” Secrets / Credentials ä½œä¸º Capability

> **è¿™æ˜¯å®‰å…¨ç³»ç»Ÿçš„â€œå‘½é—¨â€ï¼Œåšé”™ä¸€æ¬¡å°±å®Œ**

---

## ğŸ¯ æ ¸å¿ƒåŸåˆ™ï¼ˆèƒŒä¸‹æ¥ï¼‰

> **Macro æ°¸è¿œæ‹¿ä¸åˆ° secret å€¼ï¼Œåªæ‹¿åˆ°â€œä½¿ç”¨æƒâ€**

---

## 1ï¸âƒ£ æŠŠ Secret å½“ Capabilityï¼Œè€Œä¸æ˜¯èµ„æº

```ts
Capability = 
  | 'secret:read:db-prod'
  | 'secret:use:github-token'
```

âœ… Macro åªå£°æ˜ **use**
âŒ ç»ä¸å…è®¸ readï¼ˆé™¤éæå°‘æ•° infra Macroï¼‰

---

## 2ï¸âƒ£ Secret Brokerï¼ˆå¿…é¡»æ˜¯ç‹¬ç«‹ç»„ä»¶ï¼‰

```text
Macro
  â””â”€â–¶ Tool Request
        â””â”€â–¶ Secret Broker
              â”œâ”€â–¶ check capability
              â”œâ”€â–¶ inject at call-time
              â””â”€â–¶ never log
```

Macro çœ‹ä¸åˆ°ï¼š
- å€¼
- ç”Ÿå‘½å‘¨æœŸ
- å­˜å‚¨ä½ç½®

---

## 3ï¸âƒ£ ä½¿ç”¨æ–¹å¼ï¼ˆæ¨èï¼‰

```ts
runGitHubAPI({
  token: useSecret('github-token')
});
```

è¿è¡Œæ—¶ï¼š

- âœ… æ³¨å…¥åˆ° env / header
- âœ… è°ƒç”¨å®Œæˆç«‹åˆ»é”€æ¯

---

## 4ï¸âƒ£ Secret Scopeï¼ˆæé‡è¦ï¼‰

```ts
secret:use:github-token@team:infra
```

âœ… team / env / ttl ç»‘å®š  
âœ… prod secret â‰  staging secret

---

## 5ï¸âƒ£ å®¡è®¡ä½ **åªèƒ½çœ‹åˆ°è¿™äº›**

```ts
audit.log({
  macroId,
  usedSecret: 'github-token',
  scope: 'team:infra'
});
```

âŒ ä»»ä½•å€¼æ³„éœ²éƒ½æ˜¯äº‹æ•…

---

## 6ï¸âƒ£ å¤±è´¥åœºæ™¯

- âŒ Macro è¯•å›¾ stringify secret â†’ è¿”å› opaque ref
- âŒ Secret è¢«é•¿æ—¶é—´æŒæœ‰ â†’ TTL å¼ºåˆ¶å›æ”¶
- âŒ Secret capability è¢« graph æ¨å¯¼æ‰©å¤§ â†’ å¿…é¡»ç¦æ­¢è‡ªåŠ¨æ¨å¯¼

---

# ä¸‰ã€ğŸ§ª åŸºäºçœŸå®äº‹æ•…çš„ Chaos åœºæ™¯ç”Ÿæˆ

> **è¿™æ˜¯ä½ å¹³å°â€œä¼šä¸ä¼šè¶Šæ¥è¶Šå®‰å…¨â€çš„å†³å®šæ€§èƒ½åŠ›**

---

## ğŸ¯ æ ¸å¿ƒç†å¿µ

> **äº‹æ•…ä¸æ˜¯å¼‚å¸¸ï¼Œæ˜¯è®­ç»ƒæ•°æ®**

---

## 1ï¸âƒ£ äº‹æ•…äº‹ä»¶çš„æœ€å°æ¨¡å‹

```ts
type Incident = {
  id: string;
  macroId;
  failurePoint;
  reason;
  capabilities;
  scope;
};
```

æ¥æºï¼š

- å®¡è®¡æ‹’ç»
- äººç±» reject
- ç”Ÿäº§å›æ»š
- SRE äº‹æ•…å•

---

## 2ï¸âƒ£ Chaos Generatorï¼ˆç¦»çº¿ï¼‰

```ts
ChaosScenario = {
  baseMacro;
  perturbation:
    | 'denyCapability'
    | 'secretExpired'
    | 'humanReject'
    | 'timeout';
};
```

---

## 3ï¸âƒ£ è‡ªåŠ¨ç”Ÿæˆæµ‹è¯•å˜ä½“

```ts
for (incident of incidents) {
  generateChaosScenario(incident);
}
```

ä¾‹å¦‚ï¼š

> â€œå½“ run:shell è¢«æ‹’ç»æ—¶ï¼Œfixâ€‘failingâ€‘tests æ˜¯å¦å®‰å…¨é€€å‡ºï¼Ÿâ€

---

## 4ï¸âƒ£ Chaos åªè·‘åœ¨ä¸‰ä¸ªåœ°æ–¹

- âœ… PR
- âœ… æ–° Graph version
- âœ… æ–° Secret policy

âŒ æ°¸è¿œä¸åœ¨ç”Ÿäº§

---

## 5ï¸âƒ£ åˆ¤å®šæ ‡å‡†ï¼ˆä¸æ˜¯æˆåŠŸ/å¤±è´¥ï¼‰

```ts
Expected:
- no data mutation
- FSM ends in ABORTED
- audit complete
```

---

## 6ï¸âƒ£ å¤±è´¥åœºæ™¯

- âŒ Chaos è¦†ç›–ä¸åˆ°çœŸå®äº‹æ•… â†’ incident å½•å…¥ä¸å®Œæ•´
- âŒ Chaos ç»“æœä¸ç¨³å®š â†’ è¯´æ˜ Macro éç¡®å®šæ€§
- âŒ Chaos è¢«å½“æˆæ™®é€š CI â†’ å›¢é˜Ÿå¼€å§‹å¿½ç•¥

---

# å››ã€ğŸ§  ç”¨ LLM è¾…åŠ©ç”Ÿæˆ Macroï¼Œä½†ä¸èµ‹æƒ

> **è¿™æ˜¯ 99% å›¢é˜Ÿä¼šç¿»è½¦çš„åœ°æ–¹**

---

## ğŸ¯ é“å¾‹ï¼ˆä¸å¦¥åï¼‰

> **LLM åªèƒ½ç”Ÿæˆâ€œè‰ç¨¿â€ï¼Œæ°¸è¿œä¸èƒ½ç”Ÿæˆâ€œå¯æ‰§è¡Œèµ„äº§â€**

---

## 1ï¸âƒ£ LLM çš„å”¯ä¸€èŒè´£

```text
Input:
- æ„å›¾
- ç›®æ ‡
- çº¦æŸ

Output:
- Macro draft
- requires (å»ºè®®)
- DAGï¼ˆå»ºè®®ï¼‰
- é£é™©æç¤º
```

---

## 2ï¸âƒ£ è¾“å‡ºç›´æ¥è¿› draft çŠ¶æ€

```ts
state: 'draft'
author: 'llm'
```

âœ… å¿…é¡»äººå·¥ review  
âœ… å¿…é¡» capability diff  
âœ… å¿…é¡» checksum sign

---

## 3ï¸âƒ£ è‡ªåŠ¨ Red Flagï¼ˆå¿…é¡»ï¼‰

```text
âš  LLM Suggested:
- run:shell
- secret:use:prod-db
```

é»˜è®¤é˜»æ–­ï¼Œé™¤éäººå·¥ overrideã€‚

---

## 4ï¸âƒ£ æå…¶é‡è¦çš„â€œä¸å¯è§é™åˆ¶â€

- âŒ LLM çœ‹ä¸åˆ° Secret åå•
- âŒ LLM çœ‹ä¸åˆ° Capability Graph å…¨è²Œ
- âŒ LLM çœ‹ä¸åˆ° Team Policy

å¦åˆ™å°±æ˜¯â€œè¶Šç‹±å³èµ‹æƒâ€ã€‚

---

## 5ï¸âƒ£ æœ€å¥½çš„ä½¿ç”¨åœºæ™¯ï¼ˆå®è·µç»“è®ºï¼‰

âœ… æŠŠ**äº‹æ•… â†’ ä¿®å¤ Macro è‰ç¨¿**  
âœ… æŠŠ**äººç±» Runbook â†’ Macro è‰ç¨¿**  
âœ… æŠŠ**DAG çš„æ­»åˆ†æ”¯ â†’ æ¸…ç†å»ºè®®**

---

## 6ï¸âƒ£ å¤±è´¥åœºæ™¯

- âŒ LLM è¾“å‡ºèƒ½ç›´æ¥è¿è¡Œ â†’ æ¶æ„å¤±è´¥
- âŒ äººç±»å¼€å§‹â€œç›´æ¥ approve LLMâ€ â†’ æ–‡åŒ–å¤±è´¥
- âŒ LLM è¢«å½“æˆ Agent â†’ å®‰å…¨å¤±è´¥

---

# äº”ã€å››ä»¶äº‹åˆä½“åçš„ç»ˆæå½¢æ€

```
Macro (DAG)
 â”œâ”€â–¶ Capability (Graph)
 â”œâ”€â–¶ Secret Broker
 â”œâ”€â–¶ Scope Policy
 â”œâ”€â–¶ FSM + HITL
 â”œâ”€â–¶ Chaos (incident-driven)
 â””â”€â–¶ LLM (draft-only)
```

ä½ ç°åœ¨åšçš„å·²ç»ä¸æ˜¯â€œAgent å·¥å…·â€ï¼Œè€Œæ˜¯ï¼š

> **ä¸€ä¸ªâ€œå¯ä»¥è¢«äº‹æ•…è®­ç»ƒã€è¢«ç»„ç»‡çº¦æŸã€è¢«äººç±»æ¥ç®¡ã€è¢«æ¨¡å‹è¾…åŠ©â€çš„æ‰§è¡Œç³»ç»Ÿ**

---

## âœ… æˆ‘ç»™ä½ ä¸€ä¸ªéå¸¸ç°å®çš„è½åœ°å»ºè®®ï¼ˆæ¥è‡ªè¸©å‘ç»éªŒï¼‰

**å®æ–½é¡ºåºï¼ˆä¸è¦ä¹±ï¼‰ï¼š**

1. âœ… DAGï¼ˆåª success / failureï¼‰
2. âœ… Secret = Capability + Broker
3. âœ… Incident â†’ Chaos
4. âœ… LLM â†’ Draft Generator

å¦‚æœä½ åè¿‡æ¥ï¼Œ**LLM ä¼šæŠŠä½ æ‰€æœ‰å®‰å…¨è®¾è®¡ç»•ç©º**ã€‚

---

### å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘ä»¬ä¸‹ä¸€æ­¥å¯ä»¥ï¼š

- ğŸ“ ç»™ä½ ä¸€ä¸ª **repo ç»“æ„ï¼ˆpackages/engine, registry, broker, chaosï¼‰**
- ğŸ§  å†™ä¸€ä¸ª **Macro DAG çš„ JSON Schema**
- ğŸ§ª è®¾è®¡ **ç¬¬ä¸€æ¡çœŸå® Chaos åœºæ™¯**
- ğŸ” æŠŠ **AWS / GitHub Secret æ¥è¿›æ¥**

ä½ é€‰ä¸€ä¸ªï¼Œæˆ‘ç›´æ¥å¸®ä½ å†™åˆ°**â€œèƒ½ merge çš„ç¨‹åº¦â€**ã€‚å¥½ï¼Œè¿™ä¸€è½®æˆ‘ç›´æ¥**ç»™ä½ ä¸€å¥—å¯ä»¥è½ repoã€èƒ½å¼€å§‹å†™ä»£ç ã€è€Œä¸”åé¢ä¸ä¼šæ¨ç¿»çš„ v1 æ–¹æ¡ˆ**ã€‚  
æˆ‘ä¼šä¸¥æ ¼æŒ‰ä½ ç‚¹çš„å››ä»¶äº‹æ¥ï¼Œè€Œä¸”**å…¨éƒ¨å½¼æ­¤å¯¹é½**ã€‚

---

# ä¸€ã€ğŸ“ Repo ç»“æ„ï¼ˆå¯ä»¥ç›´æ¥ `pnpm init` çš„é‚£ç§ï¼‰

> ç›®æ ‡ï¼š**è¾¹ç•Œæ¸…æ™°ã€æƒé™éš”ç¦»ã€å°†æ¥å¥½æ‹†æœåŠ¡**

```
packages/
â”œâ”€ engine/                # æ‰§è¡Œå†…æ ¸ï¼ˆFSM + DAG + Capabilityï¼‰
â”‚  â”œâ”€ src/
â”‚  â”‚  â”œâ”€ fsm/
â”‚  â”‚  â”‚  â”œâ”€ machine.ts
â”‚  â”‚  â”‚  â””â”€ states.ts
â”‚  â”‚  â”œâ”€ dag/
â”‚  â”‚  â”‚  â”œâ”€ executor.ts
â”‚  â”‚  â”‚  â”œâ”€ validator.ts
â”‚  â”‚  â”‚  â””â”€ types.ts
â”‚  â”‚  â”œâ”€ capability/
â”‚  â”‚  â”‚  â”œâ”€ graph.ts
â”‚  â”‚  â”‚  â”œâ”€ expand.ts
â”‚  â”‚  â”‚  â””â”€ token.ts
â”‚  â”‚  â”œâ”€ secrets/
â”‚  â”‚  â”‚  â””â”€ secret-ref.ts   # åªè®¤ opaque ref
â”‚  â”‚  â”œâ”€ runner.ts
â”‚  â”‚  â””â”€ index.ts
â”‚  â””â”€ package.json
â”‚
â”œâ”€ registry/              # Macro Registryï¼ˆèµ„äº§å±‚ï¼‰
â”‚  â”œâ”€ src/
â”‚  â”‚  â”œâ”€ manifest.ts
â”‚  â”‚  â”œâ”€ publish.ts
â”‚  â”‚  â”œâ”€ scan/
â”‚  â”‚  â”‚  â”œâ”€ capability-diff.ts
â”‚  â”‚  â”‚  â””â”€ dag-check.ts
â”‚  â”‚  â””â”€ api.ts
â”‚  â””â”€ package.json
â”‚
â”œâ”€ broker/                # Secret Brokerï¼ˆå”¯ä¸€èƒ½ç¢° secretï¼‰
â”‚  â”œâ”€ src/
â”‚  â”‚  â”œâ”€ providers/
â”‚  â”‚  â”‚  â”œâ”€ aws.ts
â”‚  â”‚  â”‚  â””â”€ github.ts
â”‚  â”‚  â”œâ”€ policy.ts
â”‚  â”‚  â”œâ”€ inject.ts
â”‚  â”‚  â””â”€ audit.ts
â”‚  â””â”€ package.json
â”‚
â”œâ”€ chaos/                 # Chaos & Incident-driven testing
â”‚  â”œâ”€ src/
â”‚  â”‚  â”œâ”€ incidents.ts
â”‚  â”‚  â”œâ”€ generator.ts
â”‚  â”‚  â”œâ”€ scenarios/
â”‚  â”‚  â”‚  â””â”€ deny-capability.ts
â”‚  â”‚  â””â”€ runner.ts
â”‚  â””â”€ package.json
â”‚
â””â”€ shared/
   â”œâ”€ audit/
   â”œâ”€ types/
   â””â”€ utils/
```

âœ… **å…³é”®è¾¹ç•Œè§„åˆ™ï¼ˆä¸€å®šè¦å®ˆï¼‰**

- `engine` **ä¸èƒ½ import** `broker/providers`
- `engine` åªè®¤è¯† `SecretRef`
- `chaos` åªèƒ½é€šè¿‡ `engine` å…¬å…±æ¥å£è·‘
- `registry` ä¸æ‰§è¡Œ Macroï¼Œåªåšé™æ€åˆ¤æ–­

---

# äºŒã€ğŸ§  Macro DAG çš„ JSON Schemaï¼ˆv1 å¯ç›´æ¥æ ¡éªŒï¼‰

> **åˆ»æ„é™åˆ¶èƒ½åŠ›ï¼Œé¿å…â€œéšæ€§ç¼–ç¨‹è¯­è¨€â€**

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "MacroDAG",
  "type": "object",
  "required": ["entry", "nodes"],
  "properties": {
    "entry": { "type": "string" },
    "nodes": {
      "type": "object",
      "additionalProperties": {
        "type": "object",
        "required": ["type"],
        "properties": {
          "type": {
            "enum": ["step", "call-macro", "decision"]
          },

          "run": { "type": "string" },

          "macro": { "type": "string" },

          "when": {
            "type": "object",
            "required": ["type"],
            "properties": {
              "type": {
                "enum": ["exitCode", "var", "capabilityDenied"]
              },
              "equals": {}
            }
          },

          "onSuccess": { "type": "string" },
          "onFailure": { "type": "string" }
        },
        "additionalProperties": false
      }
    }
  },
  "additionalProperties": false
}
```

### âœ… v1 æ˜ç¡®ç¦æ­¢

- å¹¶è¡Œ
- å¾ªç¯
- åŠ¨æ€èŠ‚ç‚¹
- èŠ‚ç‚¹çº§ capability

---

## âœ… Registry å‘å¸ƒæ—¶å¿…é¡»åšçš„æ ¡éªŒ

```ts
validateSchema(dag);
assertNoCycles(dag);
assertAllNodesReachableFrom(entry);
```

---

# ä¸‰ã€ğŸ§ª ç¬¬ä¸€æ¡çœŸå® Chaos åœºæ™¯ï¼ˆå¼ºçƒˆæ¨èä»è¿™æ¡å¼€å§‹ï¼‰

> **äº‹æ•…åŸå‹ï¼šæƒé™è¢«æ‹’ç»ï¼Œä½† Macro æ²¡æœ‰å®‰å…¨é€€å‡º**

---

## ğŸ¯ åœºæ™¯å®šä¹‰

**çœŸå®ä¸–ç•Œéå¸¸å¸¸è§ï¼š**

> `fix-failing-tests`  
> åœ¨ `run:tests` â†’ éšå¼éœ€è¦ `run:shell`  
> ä½†æŸä¸ª Team çš„ maxRisk=medium

---

## 1ï¸âƒ£ Incident è®°å½•

```ts
Incident {
  id: "INC-001",
  macroId: "fix-failing-tests@1.2.0",
  failurePoint: "capability-expansion",
  reason: "run:shell denied",
  scope: "team:frontend"
}
```

---

## 2ï¸âƒ£ Chaos Scenario ç”Ÿæˆ

```ts
ChaosScenario {
  baseMacro: "fix-failing-tests",
  perturbation: {
    type: "denyCapability",
    capability: "run:shell"
  }
}
```

---

## 3ï¸âƒ£ Chaos Runner è¡Œä¸º

```ts
runMacro({
  macroId,
  chaos: {
    deny: ["run:shell"]
  }
});
```

---

## 4ï¸âƒ£ âœ… æœŸæœ›ç»“æœï¼ˆä¸æ˜¯â€œæˆåŠŸ/å¤±è´¥â€ï¼‰

```ts
assert:
- FSM ends in ABORTED
- no write:workspace
- audit contains capability denial
- no secret usage
```

---

## 5ï¸âƒ£ ä¸ºä»€ä¹ˆè¿™æ˜¯â€œç¬¬ä¸€æ¡â€

å¦‚æœè¿™ä¸€æ¡è¿‡ä¸äº†ï¼š

- DAG åˆ†æ”¯ä¸å®‰å…¨
- Capability è§£é‡Šä¸å¯æ§
- HITL / fallback ä¸å®Œæ•´

ğŸ‘‰ **ç›´æ¥ block ä¸Šçº¿**

---

# å››ã€ğŸ” æŠŠ AWS / GitHub Secret æ¥è¿›æ¥ï¼ˆæ­£ç¡®æ–¹å¼ï¼‰

> **ç›®æ ‡ï¼šMacro æ°¸è¿œæ‹¿ä¸åˆ° secret å€¼**

---

## 1ï¸âƒ£ Secret Capability å®šä¹‰

```ts
type Capability =
  | "secret:use:aws-role:deploy-staging"
  | "secret:use:github-token:ci-bot";
```

---

## 2ï¸âƒ£ SecretRefï¼ˆengine å”¯ä¸€èƒ½çœ‹åˆ°çš„ï¼‰

```ts
type SecretRef = {
  id: string;
  scope: string;
};
```

---

## 3ï¸âƒ£ Engine â†’ Broker è°ƒç”¨ï¼ˆå…³é”®è¾¹ç•Œï¼‰

```ts
const ref = useSecret("github-token");

broker.inject(ref, {
  into: "env",
  key: "GITHUB_TOKEN"
});
```

Engine **ä¸çŸ¥é“**ï¼š

- AWS / GitHub
- token / key å½¢å¼
- ç”Ÿå‘½å‘¨æœŸ

---

## 4ï¸âƒ£ Brokerï¼šAWS Providerï¼ˆç¤ºæ„ï¼‰

```ts
assumeRole({
  roleArn,
  durationSeconds: 900
});
```

- âœ… ä¸´æ—¶å‡­è¯
- âœ… TTL < Macro step
- âœ… è‡ªåŠ¨é”€æ¯

---

## 5ï¸âƒ£ Brokerï¼šGitHub Providerï¼ˆç¤ºæ„ï¼‰

```ts
getAppInstallationToken({
  installationId,
  expiresIn: 600
});
```

---

## 6ï¸âƒ£ å®¡è®¡ï¼ˆåªèƒ½è¿™æ ·ï¼‰

```ts
audit.log({
  macroId,
  usedSecret: "github-token",
  provider: "github",
  ttl: 600
});
```

âŒ ç¦æ­¢ä»»ä½•å€¼è½æ—¥å¿—

---

## 7ï¸âƒ£ Chaos Ã— Secretï¼ˆä¸‹ä¸€æ¡è‡ªç„¶åœºæ™¯ï¼‰

```text
secret expired mid-step
â†’ retry?
â†’ abort?
â†’ human gate?
```

è¿™æ¡ä½ ä¸‹å‘¨ä¸€å®šä¼šè¡¥ã€‚

---

# äº”ã€å››ä»¶äº‹åˆåœ¨ä¸€èµ·åçš„ã€Œæœ€å°å¯è¿è¡Œé—­ç¯ã€

```
Registry
  â””â”€â–¶ validate DAG + capability

Engine
  â”œâ”€â–¶ expand capability
  â”œâ”€â–¶ run DAG (FSM)
  â”œâ”€â–¶ ask Broker for secret (ref only)
  â””â”€â–¶ audit everything

Chaos
  â””â”€â–¶ replay real incidents

Broker
  â””â”€â–¶ inject secrets ephemerally
```

---

## âœ… æˆ‘ç»™ä½ ä¸€ä¸ªéå¸¸æ˜ç¡®çš„â€œä¸‹ä¸€æ­¥å»ºè®®â€

**ä½ ç°åœ¨æœ€å€¼å¾—ç«‹åˆ»å†™çš„ä¸‰ä»¶ä»£ç ï¼š**

1. `engine/dag/validator.ts`
2. `broker/secret-ref.ts + inject.ts`
3. `chaos/scenarios/deny-capability.ts`

è¿™ä¸‰ä»¶å†™å®Œï¼Œ  
ğŸ‘‰ **ä½ å°±å·²ç»æ‹¥æœ‰ä¸€ä¸ªâ€œæ¯” 90% Agent å¹³å°æ›´å®‰å…¨â€çš„å†…æ ¸äº†ã€‚**

---

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ï¼š

- ğŸ§ª å¸®ä½ æŠŠ **INCâ€‘001 å†™æˆçœŸå® Jest / Vitest**
- ğŸ“¦ ç»™ä½ ä¸€ä¸ª **å®Œæ•´çš„ Macro ç¤ºä¾‹ï¼ˆfixâ€‘failingâ€‘tests DAGï¼‰**
- ğŸ” ç»†æ‹† **AWS / GitHub çš„æœ€å° IAM / App æƒé™**
- ğŸ§  æŠŠ **LLM Draft Generator æ¥åˆ° Registry**

ä½ ç‚¹ä¸€ä¸ªï¼Œæˆ‘ç»§ç»­å¾€ä¸‹â€œç»™ä½ èƒ½ merge çš„ä»£ç â€ã€‚å¥½ï¼Œè¿™ä¸€è½®æˆ‘**ç›´æ¥ç»™ä½ â€œèƒ½è½ä»£ç ã€èƒ½è·‘æµ‹è¯•ã€èƒ½æŒ¡äº‹æ•…â€çš„å®Œæ•´äº¤ä»˜**ã€‚  
æˆ‘ä¼šæŒ‰ä½ ç‚¹çš„å››ä»¶äº‹é¡ºåºæ¥ï¼Œè€Œä¸”**æ¯ä¸€ä»¶éƒ½å’Œ INCâ€‘001 ä¸¥æ ¼å¯¹é½**ã€‚

> âœ… é»˜è®¤ä½ ç”¨ **Vitest**ï¼ˆJest æ”¹åä¹Ÿè¡Œï¼Œç»“æ„ä¸€æ ·ï¼‰

---

# ä¸€ã€ğŸ§ª INCâ€‘001 çš„çœŸå® Vitestï¼ˆä¸æ˜¯ä¼ªä»£ç ï¼‰

> **ç›®æ ‡ï¼šä¸€æ¡æµ‹è¯•ï¼Œè¯æ˜ä½ è¿™ä¸ªç³»ç»Ÿä¸ä¼šâ€œè¶Šæƒç»§ç»­è·‘â€**

---

## 1ï¸âƒ£ æµ‹è¯•æ–‡ä»¶ç»“æ„

```
packages/chaos/
â””â”€ src/__tests__/
   â””â”€ inc-001-deny-shell.test.ts
```

---

## 2ï¸âƒ£ INCâ€‘001 æµ‹è¯•ä»£ç ï¼ˆå¯ç›´æ¥ç”¨ï¼‰

```ts
import { describe, it, expect } from 'vitest';
import { runMacro } from '@engine/runner';
import { ChaosConfig } from '../generator';

describe('INC-001: deny run:shell capability', () => {
  it('aborts safely when run:shell is denied', async () => {
    const chaos: ChaosConfig = {
      denyCapabilities: ['run:shell']
    };

    const result = await runMacro({
      macroId: 'fix-failing-tests@1.0.0',
      input: {
        testCommand: 'pnpm test'
      },
      chaos
    });

    expect(result.state).toBe('ABORTED');

    expect(result.audit).toMatchObject({
      events: expect.arrayContaining([
        expect.objectContaining({
          type: 'CAPABILITY_DENIED',
          capability: 'run:shell'
        })
      ])
    });

    expect(result.effects).toEqual({
      workspaceWrites: 0,
      secretsUsed: []
    });
  });
});
```

---

## 3ï¸âƒ£ è¿™ä¸ªæµ‹è¯•åœ¨éªŒè¯ä»€ä¹ˆï¼ˆéå¸¸é‡è¦ï¼‰

âœ… Capability åœ¨ **æ‰§è¡Œå‰** è¢«æ‹’ç»  
âœ… DAG æ²¡æœ‰â€œå·å· fallbackâ€  
âœ… æ²¡æœ‰å†™ workspace  
âœ… æ²¡æœ‰ä½¿ç”¨ secret  
âœ… FSM æ˜ç¡®è¿›å…¥ `ABORTED`

> **è¿™æ¡è¿‡ä¸äº†ï¼Œå¹³å°ä¸ä¸Šçº¿ã€‚**

---

# äºŒã€ğŸ“¦ å®Œæ•´ Macro ç¤ºä¾‹ï¼š`fix-failing-tests`

> **è¿™æ˜¯ä½ ç¬¬ä¸€ä¸ªâ€œçœŸå®èƒ½ç”¨ã€ä¹ŸçœŸå®å±é™©â€çš„ Macro**

---

## 1ï¸âƒ£ Macro Manifestï¼ˆregistry é‡Œçš„èµ„äº§ï¼‰

```json
{
  "id": "fix-failing-tests",
  "version": "1.0.0",
  "requires": [
    "run:tests",
    "run:shell",
    "workspace:write"
  ],
  "dag": {
    "entry": "run-tests",
    "nodes": {
      "run-tests": {
        "type": "step",
        "run": "runTests",
        "onSuccess": "done",
        "onFailure": "analyze"
      },
      "analyze": {
        "type": "step",
        "run": "analyzeFailures",
        "onSuccess": "apply-fix",
        "onFailure": "abort"
      },
      "apply-fix": {
        "type": "step",
        "run": "applyPatch",
        "onSuccess": "rerun-tests",
        "onFailure": "abort"
      },
      "rerun-tests": {
        "type": "step",
        "run": "runTests",
        "onSuccess": "done",
        "onFailure": "abort"
      },
      "done": {
        "type": "step",
        "run": "noop"
      },
      "abort": {
        "type": "step",
        "run": "abort"
      }
    }
  }
}
```

---

## 2ï¸âƒ£ ä¸ºä»€ä¹ˆè¿™ä¸ª DAG å¾ˆâ€œå±é™©ä½†çœŸå®â€

- `runTests` â†’ éšå¼éœ€è¦ `run:shell`
- `applyPatch` â†’ å†™ workspace
- **å¦‚æœ capability æ‰©å±•æ²¡æ‹¦ä½ â†’ å°±æ˜¯äº‹æ•…**

ğŸ‘‰ INCâ€‘001 æ­£æ˜¯ä»è¿™é‡Œæ¥çš„ã€‚

---

# ä¸‰ã€ğŸ” AWS / GitHub çš„æœ€å° IAM / App æƒé™ï¼ˆå®æˆ˜çº§ï¼‰

> **ç›®æ ‡ï¼šå³ä½¿ Macro è¢«æ”»ç ´ï¼Œçˆ†ç‚¸åŠå¾„ä¹Ÿæœ€å°**

---

## ğŸ” AWSï¼ˆå‡è®¾ï¼šéƒ¨ç½²åˆ° Stagingï¼‰

### 1ï¸âƒ£ IAM Roleï¼ˆæœ€å°ï¼‰

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "ecs:UpdateService"
      ],
      "Resource": "arn:aws:ecs:us-east-1:123456789012:service/staging/*"
    }
  ]
}
```

âœ… åªå…è®¸ **UpdateService**  
âœ… åªå…è®¸ **staging**  
âŒ ä¸å…è®¸ `iam:*`  
âŒ ä¸å…è®¸ `secretsmanager:GetSecretValue`

---

### 2ï¸âƒ£ Broker ä¸­çš„ assumeRole

```ts
assumeRole({
  roleArn: 'arn:aws:iam::123:role/deploy-staging',
  durationSeconds: 900 // < Macro step
});
```

---

## ğŸ” GitHubï¼ˆGitHub Appï¼Œå¼ºçƒˆæ¨èï¼‰

### 1ï¸âƒ£ GitHub App æƒé™

âœ… Repository permissionsï¼š

| Scope | Level |
|----|----|
| Contents | Read |
| Pull requests | Write |
| Actions | Read |

âŒ ä¸ç»™ `Administration`  
âŒ ä¸ç»™ `Secrets`

---

### 2ï¸âƒ£ Broker ä½¿ç”¨æ–¹å¼

```ts
getInstallationToken({
  installationId,
  permissions: {
    pull_requests: 'write',
    contents: 'read'
  }
});
```

âœ… Token æœ‰ TTL  
âœ… Token ç»‘å®š repo  
âœ… Macro æ‹¿ä¸åˆ° token å€¼

---

## 3ï¸âƒ£ Capability å¯¹åº”å…³ç³»ï¼ˆéå¸¸æ¸…æ™°ï¼‰

```ts
secret:use:github-token:ci-bot
â†’ GitHub App Installation Token
```

---

# å››ã€ğŸ§  LLM Draft Generator æ¥ Registryï¼ˆæ­£ç¡®æ–¹å¼ï¼‰

> **è¿™æ˜¯ä½ å¹³å°çš„â€œç”Ÿäº§åŠ›æ æ†â€ï¼Œä¹Ÿæ˜¯â€œäº‹æ•…æ”¾å¤§å™¨â€**

---

## 1ï¸âƒ£ LLM çš„è¾“å…¥ï¼ˆæå…¶é‡è¦ï¼‰

```ts
type DraftRequest = {
  intent: string;
  constraints: {
    maxRisk: 'low' | 'medium';
    forbiddenCapabilities: string[];
  };
  examples?: string[];
};
```

âœ… æ˜ç¡®çº¦æŸ  
âœ… æ˜ç¡®é£é™©çº§åˆ«  
âŒ ä¸ç»™ capability graph  
âŒ ä¸ç»™ secret åå•

---

## 2ï¸âƒ£ LLM è¾“å‡ºï¼ˆæ°¸è¿œæ˜¯ Draftï¼‰

```ts
type MacroDraft = {
  dag: unknown;
  suggestedCapabilities: string[];
  riskNotes: string[];
};
```

---

## 3ï¸âƒ£ Registry æ¥å…¥ç‚¹

```
POST /registry/drafts
```

```ts
registry.saveDraft({
  author: 'llm',
  state: 'draft',
  checksum: hash(dag),
  requires: suggestedCapabilities
});
```

---

## 4ï¸âƒ£ è‡ªåŠ¨çº¢çº¿ï¼ˆå¿…é¡»ï¼‰

```ts
if (draft.requires.includes('run:shell')) {
  flag('HIGH_RISK_CAPABILITY');
}
```

é»˜è®¤ï¼šâŒ ä¸å¯ publish  
å¿…é¡»äººå·¥ override + å¤‡æ³¨ã€‚

---

## 5ï¸âƒ£ å’Œ INCâ€‘001 çš„å…³ç³»ï¼ˆå¾ˆå…³é”®ï¼‰

> LLM **å¾ˆå¯èƒ½å»ºè®® run:shell**

âœ… Registry ä¼šæ ‡çº¢  
âœ… Chaos ä¼šè¦†ç›–  
âœ… äººç±»ä¼šçœ‹åˆ°çœŸå®åæœ

ğŸ‘‰ **è¿™å°±æ˜¯â€œLLM è¾…åŠ©ï¼Œä½†ä¸èµ‹æƒâ€çœŸæ­£æˆç«‹çš„åœ°æ–¹**

---

# äº”ã€ä½ ç°åœ¨å·²ç»å…·å¤‡çš„èƒ½åŠ›ï¼ˆå®è¯ï¼‰

ä½ ç°åœ¨å·²ç»æœ‰ï¼š

- âœ… å¯éªŒè¯çš„ DAG Macro
- âœ… Capabilityâ€‘first å®‰å…¨æ¨¡å‹
- âœ… Secret é›¶æš´éœ²æ³¨å…¥
- âœ… äº‹æ•… â†’ Chaos â†’ æµ‹è¯•é—­ç¯
- âœ… LLM ç”Ÿäº§åŠ›ä½†ä¸å¯æ‰§è¡Œ

è¿™å·²ç»ä¸æ˜¯â€œAgent æ¡†æ¶â€äº†ï¼Œè€Œæ˜¯ï¼š

> **ä¸€ä¸ªå¯ä»¥è¢«äº‹æ•…è®­ç»ƒã€è¢«å®¡è®¡ã€è¢«ç»„ç»‡ä¿¡ä»»çš„æ‰§è¡Œç³»ç»Ÿ**

---

## ğŸš€ æˆ‘å»ºè®®ä½ ä¸‹ä¸€æ­¥åšçš„ä¸€ä»¶äº‹ï¼ˆéå¸¸å…·ä½“ï¼‰

ğŸ‘‰ **æŠŠ INCâ€‘001 è¿™æ¡æµ‹è¯•è®¾æˆ `required check`**

ç„¶åæˆ‘å¯ä»¥ç»§ç»­å¸®ä½ ï¼š

- ğŸ§ª å†å†™ **INCâ€‘002ï¼šsecret è¿‡æœŸ midâ€‘step**
- ğŸ§  å†™ä¸€ä¸ª **LLM â†’ Runbook â†’ Macro** çš„è½¬æ¢å™¨
- ğŸ” è®¾è®¡ **Capability é£é™©è¯„åˆ†æ¨¡å‹**
- ğŸ“Š ç»™ä½ ä¸€å¥— **Audit Log å¯è§†åŒ–å­—æ®µ**

ä½ æŒ‘ä¸€ä¸ªï¼Œæˆ‘ç»§ç»­å¾€ä¸‹ï¼Œè¿˜æ˜¯é‚£å¥è¯ï¼š  
**åªå†™èƒ½ mergeã€èƒ½ä¸Šçº¿ã€ä¸åæ‚”çš„ä¸œè¥¿ã€‚**å¥½ï¼Œè¿™ä¸€è½®æˆ‘**ç»§ç»­ç»™ä½ â€œèƒ½åˆã€èƒ½è·‘ã€èƒ½æŒ¡äº‹æ•…â€çš„å››ä»¶å®Œæ•´äº¤ä»˜**ï¼Œå¹¶ä¸”**å…¨éƒ¨å’Œ INCâ€‘002 ä¸¥æ ¼å¯¹é½**ã€‚

---

# ä¸€ã€ğŸ§ª INCâ€‘002ï¼š**secret åœ¨ step ä¸­é€”è¿‡æœŸ**

> äº‹æ•…åŸå‹ï¼ˆéå¸¸çœŸå®ï¼‰  
> GitHub Installation Token TTL=600sï¼Œ`applyPatch` + `rerun-tests` æœŸé—´è¿‡æœŸ  
> âŒ ä¸èƒ½è‡ªåŠ¨ç»­ â†’ âŒ ä¸èƒ½ç»§ç»­æ‰§è¡Œ â†’ âœ… å¿…é¡»å®‰å…¨ä¸­æ­¢æˆ–è¿›å…¥äººå·¥ gate

---

## 1ï¸âƒ£ Chaos åœºæ™¯å®šä¹‰

```ts
// packages/chaos/src/incidents.ts
export const INC_002 = {
  id: 'INC-002',
  description: 'Secret expired mid-step',
  perturbation: {
    type: 'expireSecret',
    secret: 'github-token',
    at: 'during-step'
  }
};
```

---

## 2ï¸âƒ£ Vitestï¼šçœŸå®å¯è·‘çš„æµ‹è¯•

```
packages/chaos/src/__tests__/inc-002-secret-expired.test.ts
```

```ts
import { describe, it, expect } from 'vitest';
import { runMacro } from '@engine/runner';

describe('INC-002: secret expired mid-step', () => {
  it('aborts safely when secret expires during execution', async () => {
    const result = await runMacro({
      macroId: 'fix-failing-tests@1.0.0',
      chaos: {
        expireSecrets: ['github-token']
      }
    });

    expect(result.state).toBe('ABORTED');

    expect(result.audit.events).toEqual(
      expect.arrayContaining([
        expect.objectContaining({
          type: 'SECRET_EXPIRED',
          secret: 'github-token'
        })
      ])
    );

    expect(result.effects).toMatchObject({
      secretsUsed: ['github-token'],
      workspaceWrites: 0
    });
  });
});
```

---

## 3ï¸âƒ£ Engine çš„**å”¯ä¸€æ­£ç¡®è¡Œä¸º**

```ts
onSecretExpired(ref) {
  // âŒ ä¸å…è®¸ silent refresh
  // âŒ ä¸å…è®¸ retry step
  transition('ABORTED');
}
```

> âœ… **åˆ·æ–° secret = æ–° capability = æ–°å®¡è®¡äº‹ä»¶**  
> é»˜è®¤ä¸å…è®¸è‡ªåŠ¨å‘ç”Ÿ

---

# äºŒã€ğŸ§  LLM â†’ Runbook â†’ Macro è½¬æ¢å™¨ï¼ˆç”Ÿäº§çº§ï¼‰

> **åŸåˆ™ï¼šLLM åªå†™â€œäººç±» Runbookâ€ï¼Œæ°¸è¿œä¸å†™å¯æ‰§è¡Œ DAG**

---

## 1ï¸âƒ£ Runbookï¼ˆä¸­é—´è¡¨ç¤ºï¼Œå¼ºçº¦æŸï¼‰

```ts
type Runbook = {
  goal: string;
  steps: Array<{
    intent: string;
    inputs?: string[];
    outputs?: string[];
    risk?: 'low' | 'medium' | 'high';
  }>;
};
```

âœ… äººç±»å¯è¯»  
âœ… å¯ review  
âœ… å¯ diff  
âŒ ä¸å¯æ‰§è¡Œ

---

## 2ï¸âƒ£ LLM â†’ Runbookï¼ˆç¤ºä¾‹ï¼‰

```json
{
  "goal": "Fix failing tests",
  "steps": [
    {
      "intent": "Run test suite",
      "risk": "medium"
    },
    {
      "intent": "Analyze failure output",
      "risk": "low"
    },
    {
      "intent": "Apply minimal patch",
      "risk": "high"
    },
    {
      "intent": "Re-run tests",
      "risk": "medium"
    }
  ]
}
```

---

## 3ï¸âƒ£ Runbook â†’ Macroï¼ˆçº¯ deterministicï¼‰

```ts
function runbookToMacro(rb: Runbook): Macro {
  return {
    id: slug(rb.goal),
    requires: inferCapabilities(rb),
    dag: compileSteps(rb.steps)
  };
}
```

---

## 4ï¸âƒ£ å…³é”®ï¼š**Capability æ¨æ–­æ˜¯ç™½åå•é©±åŠ¨**

```ts
intent â†’ capability
--------------------------------
"Run test"        â†’ run:tests
"Apply patch"     â†’ workspace:write
"Deploy"          â†’ âŒ forbidden
```

âŒ LLM æ— æ³•æ³¨å…¥ capability  
âœ… Registry æ‰æ˜¯å®ˆé—¨äºº

---

# ä¸‰ã€ğŸ” Capability é£é™©è¯„åˆ†æ¨¡å‹ï¼ˆå¯æ‰§è¡Œï¼‰

> **ç›®æ ‡ï¼šè®©â€œå±é™©â€æ˜¯å¯é‡åŒ–ã€å¯æ¯”è¾ƒã€å¯é˜»æ–­çš„**

---

## 1ï¸âƒ£ Capability å…ƒæ•°æ®

```ts
type CapabilityMeta = {
  name: string;
  risk: 1 | 2 | 3 | 4 | 5;
  blastRadius: 'local' | 'repo' | 'org' | 'cloud';
  reversible: boolean;
};
```

---

## 2ï¸âƒ£ ç¤ºä¾‹è¡¨ï¼ˆv1ï¼‰

| Capability | Risk | Blast | Reversible |
|----------|------|-------|------------|
| run:tests | 1 | local | âœ… |
| workspace:write | 3 | repo | âœ… |
| run:shell | 4 | repo | âŒ |
| secret:use:* | 5 | org | âŒ |
| deploy:prod | 5 | cloud | âŒ |

---

## 3ï¸âƒ£ Macro æ€»é£é™©è®¡ç®—ï¼ˆéå¸¸å…³é”®ï¼‰

```ts
score = Î£(capability.risk)
if (any blastRadius >= 'org') score += 3
if (any !reversible) score += 2
```

---

## 4ï¸âƒ£ Registry ç­–ç•¥ï¼ˆä¾‹ï¼‰

```ts
if (score >= 7) {
  requireHumanApproval();
}

if (score >= 10) {
  forbidPublish();
}
```

âœ… INCâ€‘001 / INCâ€‘002 éƒ½ä¼šè¢«æå‰æ ‡çº¢  
âœ… LLM Draft æ°¸è¿œä¸å¯èƒ½â€œæ‚„æ‚„ä¸Šçº¿â€

---

# å››ã€ğŸ“Š Audit Log å¯è§†åŒ–å­—æ®µï¼ˆç›´æ¥ç»™ä½  UI ç»´åº¦ï¼‰

> **è¿™å¥—å­—æ®µæ˜¯ç»™ SRE / Security / Legal åŒæ—¶çœ‹çš„**

---

## 1ï¸âƒ£ é¡¶å±‚å­—æ®µï¼ˆæ—¶é—´çº¿ï¼‰

```ts
AuditLog {
  macroId
  version
  runId
  state: RUNNING | ABORTED | COMPLETED
  startTime
  endTime
  riskScore
}
```

---

## 2ï¸âƒ£ Eventï¼ˆå¯æŠ˜å æ—¶é—´çº¿ï¼‰

```ts
AuditEvent {
  timestamp
  type:
    | STEP_START
    | STEP_END
    | CAPABILITY_GRANTED
    | CAPABILITY_DENIED
    | SECRET_INJECTED
    | SECRET_EXPIRED
    | STATE_TRANSITION
  ref?: string
  capability?: string
  secret?: string
  node?: string
}
```

---

## 3ï¸âƒ£ Effectsï¼ˆå®¡è®¡æœ€çˆ±ï¼‰

```ts
EffectsSummary {
  workspaceWrites: number
  secretsUsed: string[]
  networkCalls: number
  deployments: number
}
```

---

## 4ï¸âƒ£ é£é™© & åˆè§„è§†è§’ï¼ˆéå¸¸é‡è¦ï¼‰

```ts
ComplianceView {
  highestRiskCapability: string
  irreversibleActions: boolean
  secretExposure: false
  humanApprovalUsed: boolean
}
```

> âœ… INCâ€‘002 ä¸€çœ¼èƒ½çœ‹å‡ºï¼š  
> `SECRET_EXPIRED â†’ ABORTED â†’ no further effects`

---

# äº”ã€ç°åœ¨è¿™å¥—ç³»ç»Ÿ**å·²ç»èƒ½åšä»€ä¹ˆ**

ä½ ç°åœ¨å·²ç»æ‹¥æœ‰ï¼š

- âœ… å¯å¤ç°çš„ **Secret äº‹æ•…**
- âœ… LLM è¢«**å¼ºçº¦æŸ**çš„ç”Ÿäº§åŠ›
- âœ… Capability é£é™©æ˜¯**æ•°å€¼æ¨¡å‹**
- âœ… Audit å¤©ç„¶æ”¯æŒ **æ—¶é—´çº¿ + åˆè§„**

è¿™å·²ç»æ˜¯ï¼š

> **â€œäº‹æ•…ä¼˜å…ˆè®¾è®¡â€çš„ Agent Execution Platform**

---

## ğŸ”¥ æˆ‘å»ºè®®ä½ ä¸‹ä¸€æ­¥ï¼ˆéå¸¸å…·ä½“ï¼‰

é€‰ä¸€ä¸ªæˆ‘ç»§ç»­ç»™ä½ è½ï¼š

1. ğŸ§  **Humanâ€‘inâ€‘theâ€‘Loop Gate**ï¼ˆå®¡æ‰¹èŠ‚ç‚¹å¦‚ä½•è¿› DAGï¼‰
2. ğŸ” **Safe Resume**ï¼ˆABORTED åå“ªäº› step å¯æ¢å¤ï¼‰
3. ğŸ“Š **Audit â†’ Incident è‡ªåŠ¨ç”Ÿæˆ Chaos**
4. ğŸ§ª **Propertyâ€‘based Chaosï¼ˆéšæœºèƒ½åŠ›å‰¥å¤ºï¼‰**

ä½ ç‚¹ä¸€ä¸ªï¼Œæˆ‘ç»§ç»­ã€‚å¤ªå¥½äº†ï¼Œè¿™ä¸¤ä¸ªç‚¹**æ­£æ˜¯æŠŠä½ ç³»ç»Ÿä»â€œå®‰å…¨â€æ¨åˆ°â€œå¯è¿è¥â€çš„å…³é”®**ã€‚  
æˆ‘ä¸‹é¢ç›´æ¥ç»™ä½  **èƒ½è¿› DAGã€èƒ½æµ‹ã€èƒ½å®¡è®¡ã€èƒ½è§£é‡Šç»™å®‰å…¨/æ³•åŠ¡å¬** çš„è®¾è®¡ã€‚

---

# ä¸€ã€ğŸ§  Humanâ€‘inâ€‘theâ€‘Loop Gate  
## âœ… å®¡æ‰¹èŠ‚ç‚¹å¦‚ä½•**æ­£ç¡®**è¿› DAG

> **åŸåˆ™ä¸€å¥è¯**ï¼š  
> **äººä¸æ˜¯ä¸€ä¸ª stepï¼Œäººæ˜¯ä¸€ä¸ª state transition çš„å‰ç½®æ¡ä»¶ã€‚**

---

## 1ï¸âƒ£ Gate çš„æœ¬è´¨æ¨¡å‹ï¼ˆä¸è¦åšé”™ï¼‰

âŒ é”™è¯¯åšæ³•  
```text
[run-tests] â†’ [human-approve] â†’ [deploy]
```

âœ… æ­£ç¡®åšæ³•  
```text
[run-tests] â†’ (WAITING_APPROVAL) â†’ [deploy]
```

---

## 2ï¸âƒ£ DAG ä¸­çš„ Gate è¡¨è¾¾æ–¹å¼

### âœ… åœ¨èŠ‚ç‚¹ä¸Šå£°æ˜ gateï¼ˆä¸æ˜¯æ–°èŠ‚ç‚¹ï¼‰

```json
{
  "apply-fix": {
    "type": "step",
    "run": "applyPatch",
    "gate": {
      "type": "human",
      "requiredRole": "maintainer",
      "reason": "Workspace write detected"
    },
    "onSuccess": "rerun-tests",
    "onFailure": "abort"
  }
}
```

---

## 3ï¸âƒ£ Engine çš„çŠ¶æ€æœºï¼ˆå…³é”®ï¼‰

```ts
if (node.gate && !approval.granted) {
  transition('WAITING_APPROVAL');
  emitAudit({
    type: 'HUMAN_APPROVAL_REQUIRED',
    node: node.id,
    reason: node.gate.reason
  });
  pauseExecution();
}
```

âœ… ä¸å ç”¨ worker  
âœ… ä¸æŒæœ‰ secret  
âœ… ä¸å¯ç»§ç»­æ‰§è¡Œ

---

## 4ï¸âƒ£ äººç±»å®¡æ‰¹è¾“å…¥ï¼ˆå¼ºçº¦æŸï¼‰

```ts
type Approval = {
  runId: string;
  node: string;
  approved: boolean;
  approver: {
    id: string;
    role: 'maintainer' | 'security';
  };
  comment?: string;
};
```

---

## 5ï¸âƒ£ å®¡æ‰¹åçš„æ¢å¤

```ts
if (approval.approved) {
  resumeFrom(node.id);
} else {
  transition('ABORTED');
}
```

---

## 6ï¸âƒ£ Audit Logï¼ˆæ³•å¾‹çº§ï¼‰

```ts
{
  type: 'HUMAN_APPROVAL_GRANTED',
  node: 'apply-fix',
  approver: 'alice',
  role: 'maintainer',
  comment: 'Minimal patch only'
}
```

âœ… è°  
âœ… ä»€ä¹ˆæ—¶å€™  
âœ… ä¸ºä»€ä¹ˆ  
âœ… æ‰¹äº†ä»€ä¹ˆ

---

## 7ï¸âƒ£ Gate å’Œ Capability çš„å…³ç³»ï¼ˆéå¸¸é‡è¦ï¼‰

```ts
if (capability.risk >= 4) {
  requireGate();
}
```

> âœ… Gate æ˜¯ **é£é™©çš„å‡½æ•°**ï¼Œä¸æ˜¯ Macro ä½œè€…çš„è‡ªç”±é€‰æ‹©

---

# äºŒã€ğŸ” Safe Resume  
## âœ… ABORTED åå“ªäº› step å¯ä»¥æ¢å¤

> **åŸåˆ™ä¸€å¥è¯**ï¼š  
> **åªæœ‰â€œå¹‚ç­‰ + æ— å‰¯ä½œç”¨â€çš„ step æ‰èƒ½æ¢å¤ã€‚**

---

## 1ï¸âƒ£ Step å¯æ¢å¤æ€§æ¨¡å‹

```ts
type StepMeta = {
  id: string;
  idempotent: boolean;
  sideEffects: Array<
    'workspace-write' |
    'secret-use' |
    'network-call' |
    'deploy'
  >;
};
```

---

## 2ï¸âƒ£ Safe Resume åˆ¤å®šè§„åˆ™ï¼ˆä¸¥æ ¼ï¼‰

```ts
function canResume(step: StepMeta) {
  if (!step.idempotent) return false;
  if (step.sideEffects.includes('deploy')) return false;
  if (step.sideEffects.includes('secret-use')) return false;
  return true;
}
```

---

## 3ï¸âƒ£ Macro ä¸­çš„ Step å£°æ˜ï¼ˆçœŸå®ï¼‰

```json
{
  "run-tests": {
    "run": "runTests",
    "meta": {
      "idempotent": true,
      "sideEffects": []
    }
  },
  "apply-fix": {
    "run": "applyPatch",
    "meta": {
      "idempotent": false,
      "sideEffects": ["workspace-write"]
    }
  }
}
```

---

## 4ï¸âƒ£ INCâ€‘002 ä¸‹çš„ Safe Resume è¡Œä¸º

> **äº‹æ•…ï¼šsecret midâ€‘step è¿‡æœŸ**

| Step | çŠ¶æ€ | å¯æ¢å¤ |
|----|----|----|
| run-tests | âœ… success | âœ… |
| analyze | âœ… success | âœ… |
| apply-fix | âŒ aborted | âŒ |
| rerun-tests | âŒ not-run | âœ… |

âœ… ç³»ç»Ÿåªå…è®¸ä» `rerun-tests` é‡æ–°å¼€å§‹  
âŒ ä¸å…è®¸é‡è·‘ `apply-fix`

---

## 5ï¸âƒ£ Resume APIï¼ˆæ˜ç¡® & å¯å®¡è®¡ï¼‰

```ts
POST /runs/:id/resume
{
  "from": "rerun-tests"
}
```

Engine å†…éƒ¨æ ¡éªŒï¼š

```ts
if (!canResume(step)) {
  throw new Error('UNSAFE_RESUME');
}
```

---

## 6ï¸âƒ£ Audit Logï¼ˆæå…³é”®ï¼‰

```ts
{
  type: 'SAFE_RESUME',
  from: 'rerun-tests',
  approvedBy: 'system'
}
```

å¦‚æœæ˜¯äººå·¥å¼ºåˆ¶ï¼š

```ts
{
  type: 'FORCED_RESUME',
  from: 'apply-fix',
  approvedBy: 'alice',
  justification: 'Patch already applied manually'
}
```

âœ… é»˜è®¤ä¸å…è®¸  
âœ… å¼ºåˆ¶å¿…é¡»æœ‰ç†ç”±

---

# ä¸‰ã€ğŸ§© Gate Ã— Resume çš„ç»„åˆè¡Œä¸ºï¼ˆä½ ç°åœ¨å¾ˆå¼ºï¼‰

> **è¿™ä¸€æ­¥å¾ˆå¤šç³»ç»Ÿåšé”™**

---

## åœºæ™¯ï¼š  
- `apply-fix` æœ‰ human gate  
- æ‰§è¡Œå‰ç­‰å¾…å®¡æ‰¹  
- å®¡æ‰¹å secret è¿‡æœŸ â†’ ABORTED

âœ… ç³»ç»Ÿè¡Œä¸ºï¼š

1. ä¸ä¿ç•™ secret  
2. ä¸é‡ç”¨å®¡æ‰¹  
3. Resume æ—¶ï¼š
   - âœ… é‡æ–°è§¦å‘ gate
   - âœ… é‡æ–°æ³¨å…¥ secret

---

## å…³é”®è§„åˆ™ï¼ˆå¿…é¡»ï¼‰

```ts
approval is NOT resumable state
```

> å®¡æ‰¹åªå¯¹**ä¸€æ¬¡æ‰§è¡Œä¸Šä¸‹æ–‡**æœ‰æ•ˆ

---

# å››ã€ç°åœ¨è¿™å¥—è®¾è®¡èƒ½é˜²ä½ä»€ä¹ˆï¼ˆå®è¯ï¼‰

ä½ ç°åœ¨å·²ç»é˜²ä½ï¼š

- âœ… äººç±»å®¡æ‰¹è¢«è·³è¿‡
- âœ… Secret è¿‡æœŸåç»§ç»­è·‘
- âœ… æœ‰å‰¯ä½œç”¨ step è¢«é‡å¤æ‰§è¡Œ
- âœ… â€œæˆ‘ç‚¹è¿‡ä¸€æ¬¡å°±ä¸€ç›´æœ‰æ•ˆâ€çš„å®¡æ‰¹æ¼æ´

è¿™å·²ç»æ˜¯ï¼š

> **ç¬¦åˆ SOC2 / ISO27001 ç›´è§‰çš„ Agent æ‰§è¡Œæ¨¡å‹**

---

## ğŸš€ æˆ‘å»ºè®®ä½ ä¸‹ä¸€æ­¥ï¼ˆé€‰ä¸€ä¸ªæˆ‘ç»§ç»­ï¼‰

1. ğŸ§ª **Gate / Resume çš„äº‹æ•…æµ‹è¯•ï¼ˆINCâ€‘003ï¼‰**
2. ğŸ” **å®¡æ‰¹è§’è‰² â†’ Capability çš„æ˜ å°„æ¨¡å‹**
3. ğŸ“Š **â€œä¸ºä»€ä¹ˆè¿™ä¸ª Macro éœ€è¦å®¡æ‰¹â€çš„è§£é‡Šç”Ÿæˆå™¨**
4. ğŸ§  **LLM åªèƒ½å»ºè®® Gateï¼Œä¸èƒ½ç»• Gate**

ä½ é€‰ï¼Œæˆ‘ç»§ç»­ã€‚å¤ªå¥½äº†ï¼Œè¿™ä¸€ç»„ **INCâ€‘003 + æƒé™ + è§£é‡Š + LLM é™æƒ**ï¼Œå·²ç»æ˜¯**å®‰å…¨æ‰§è¡Œç³»ç»Ÿçš„â€œå°æ¿â€**ã€‚  
æˆ‘ä¸€æ¬¡æ€§æŠŠ **æµ‹è¯•ã€æ¨¡å‹ã€è§£é‡Šå™¨ã€LLM çº¦æŸ**å…¨éƒ¨ç»™ä½ ï¼Œè€Œä¸”å®ƒä»¬æ˜¯**äº’ç›¸å’¬åˆçš„**ã€‚

---

# ä¸€ã€ğŸ§ª INCâ€‘003ï¼šGate / Resume äº‹æ•…æµ‹è¯•  
## **å®¡æ‰¹ + Resume ç»„åˆå¤±æ•ˆåœºæ™¯**

> **INCâ€‘003 å®šä¹‰**  
> åœ¨ **éœ€è¦ Human Gate çš„ step ä¹‹å**ï¼Œæ‰§è¡Œè¢«ä¸­æ–­ï¼ˆABORTEDï¼‰ï¼Œ  
> ç³»ç»Ÿé”™è¯¯åœ° **å¤ç”¨äº†æ—§å®¡æ‰¹** æˆ– **å…è®¸ unsafe resume**

---

## 1ï¸âƒ£ äº‹æ•…åœºæ™¯å®šä¹‰

```ts
export const INC_003 = {
  id: 'INC-003',
  description: 'Approval reused or unsafe resume after abort',
  perturbation: {
    type: 'abortAfterApproval',
    node: 'apply-fix'
  }
};
```

---

## 2ï¸âƒ£ é¢„æœŸæ­£ç¡®è¡Œä¸ºï¼ˆéå¸¸å…·ä½“ï¼‰

- âœ… å®¡æ‰¹ **åªå¯¹ä¸€æ¬¡ run æœ‰æ•ˆ**
- âœ… Resume å¿…é¡»é‡æ–°è§¦å‘ gate
- âŒ ä¸å…è®¸è·³è¿‡ gate
- âŒ ä¸å…è®¸ resume åˆ°æœ‰å‰¯ä½œç”¨ step

---

## 3ï¸âƒ£ Vitestï¼ˆçœŸå®æ–­è¨€ï¼‰

```ts
describe('INC-003: gate + resume safety', () => {
  it('does not reuse approval after abort', async () => {
    const run = await runMacro({
      macroId: 'fix-tests@1.0.0',
      chaos: { abortAfterApproval: true }
    });

    expect(run.state).toBe('ABORTED');

    const resume = await resumeRun(run.id, {
      from: 'apply-fix'
    });

    expect(resume.state).toBe('WAITING_APPROVAL');

    expect(resume.audit.events).toEqual(
      expect.arrayContaining([
        expect.objectContaining({
          type: 'HUMAN_APPROVAL_REQUIRED',
          node: 'apply-fix'
        })
      ])
    );
  });

  it('rejects unsafe resume target', async () => {
    await expect(
      resumeRun('run-123', { from: 'apply-fix' })
    ).rejects.toThrow('UNSAFE_RESUME');
  });
});
```

---

## 4ï¸âƒ£ Engine çš„**å”¯ä¸€å…è®¸å®ç°**

```ts
onResume(request) {
  assert(canResume(request.from));
  invalidateAllApprovals(runId);
}
```

> âœ… Resume = æ–°æ‰§è¡Œä¸Šä¸‹æ–‡  
> âœ… Gate æ°¸è¿œé‡æ–°ç®—

---

# äºŒã€ğŸ” å®¡æ‰¹è§’è‰² â†’ Capability æ˜ å°„æ¨¡å‹  
## **ä¸æ˜¯â€œäººæ‰¹ä»€ä¹ˆâ€ï¼Œè€Œæ˜¯â€œäººèƒ½æ”¾è¡Œä»€ä¹ˆâ€**

---

## 1ï¸âƒ£ è§’è‰²æ¨¡å‹ï¼ˆRBAC + Capabilityï¼‰

```ts
type Role = {
  name: string;
  canApprove: CapabilityPattern[];
};
```

---

## 2ï¸âƒ£ Capability Patternï¼ˆéå¸¸å…³é”®ï¼‰

```ts
type CapabilityPattern =
  | 'workspace:write'
  | 'run:shell'
  | 'secret:use:*'
  | 'deploy:staging'
  | 'deploy:prod';
```

---

## 3ï¸âƒ£ é»˜è®¤è§’è‰²æ˜ å°„ï¼ˆv1ï¼‰

| Role | å¯å®¡æ‰¹ Capability |
|----|----|
| contributor | âŒ |
| maintainer | workspace:write |
| security | secret:use:\* |
| release-manager | deploy:staging |
| ops | deploy:prod |

---

## 4ï¸âƒ£ Gate æ ¡éªŒé€»è¾‘ï¼ˆä¸å¯ç»•ï¼‰

```ts
function validateApproval(approval, requiredCaps) {
  return requiredCaps.every(cap =>
    approval.role.canApprove.includes(cap)
  );
}
```

âŒ maintainer ä¸èƒ½æ‰¹ secret  
âœ… security æ‰èƒ½

---

## 5ï¸âƒ£ Auditï¼ˆåˆè§„è§†è§’ï¼‰

```ts
{
  type: 'APPROVAL_SCOPE_VALIDATED',
  role: 'maintainer',
  capabilities: ['workspace:write']
}
```

---

# ä¸‰ã€ğŸ“Š â€œä¸ºä»€ä¹ˆè¿™ä¸ª Macro éœ€è¦å®¡æ‰¹â€è§£é‡Šç”Ÿæˆå™¨  
## **ç»™äººç±»ä¸€ä¸ªâ€œå®‰å…¨åŸå› â€ï¼Œä¸æ˜¯æŠ€æœ¯ç»†èŠ‚**

---

## 1ï¸âƒ£ è¾“å…¥

```ts
ExplainInput {
  macroId
  riskScore
  capabilities: CapabilityMeta[]
}
```

---

## 2ï¸âƒ£ è§£é‡Šç”Ÿæˆé€»è¾‘ï¼ˆdeterministicï¼‰

```ts
function explainApprovalNeed(input) {
  const reasons = [];

  for (const cap of input.capabilities) {
    if (cap.risk >= 4) {
      reasons.push(
        `Uses high-risk capability: ${cap.name}`
      );
    }
    if (!cap.reversible) {
      reasons.push(
        `${cap.name} is irreversible`
      );
    }
  }

  return {
    summary: 'Human approval required',
    reasons
  };
}
```

---

## 3ï¸âƒ£ ç¤ºä¾‹è¾“å‡ºï¼ˆUI ç›´æ¥ç”¨ï¼‰

```json
{
  "summary": "Human approval required",
  "reasons": [
    "Uses high-risk capability: workspace:write",
    "workspace:write affects repository state"
  ]
}
```

âœ… éæŠ€æœ¯äººä¹Ÿèƒ½æ‡‚  
âœ… æ³•åŠ¡ / å®¡è®¡èƒ½æ¥å—  
âœ… å’Œé£é™©æ¨¡å‹å¼ºç»‘å®š

---

## 4ï¸âƒ£ Audit ç»‘å®šï¼ˆé˜²äº‹åäº‰è®®ï¼‰

```ts
{
  type: 'APPROVAL_EXPLANATION_GENERATED',
  reasons: [...]
}
```

---

# å››ã€ğŸ§  LLM åªèƒ½â€œå»ºè®® Gateâ€ï¼Œä¸èƒ½ç»• Gate  
## **è¿™æ˜¯ Agent ç³»ç»Ÿæœ€å®¹æ˜“ç¿»è½¦çš„ç‚¹**

---

## 1ï¸âƒ£ LLM çš„æƒé™ï¼ˆæé™æ”¶ç´§ï¼‰

âœ… å¯ä»¥ï¼š
- å»ºè®®æŸ step **å¯èƒ½éœ€è¦ gate**
- æä¾›ç†ç”±ï¼ˆè‡ªç„¶è¯­è¨€ï¼‰

âŒ ä¸èƒ½ï¼š
- ç§»é™¤ gate
- é™ä½é£é™©
- æŒ‡å®šå®¡æ‰¹è§’è‰²
- ä¼ªé€  approval

---

## 2ï¸âƒ£ LLM è¾“å‡ºç»“æ„ï¼ˆå»ºè®®è€ŒéæŒ‡ä»¤ï¼‰

```json
{
  "suggestedGates": [
    {
      "step": "apply-fix",
      "reason": "Workspace write may modify codebase"
    }
  ]
}
```

---

## 3ï¸âƒ£ Engine çš„å¤„ç†æ–¹å¼ï¼ˆå…³é”®ï¼‰

```ts
for (const suggestion of llm.suggestedGates) {
  markAsSuggested(suggestion);
}

// çœŸæ­£çš„ gate å†³å®šæƒï¼š
applyGatesFromRiskModel();
```

âœ… **Gate æ¥è‡ªé£é™©æ¨¡å‹ï¼Œä¸æ¥è‡ª LLM**

---

## 4ï¸âƒ£ å¼ºåˆ¶é˜²æŠ¤ï¼ˆå¿…é¡»æœ‰ï¼‰

```ts
assert(
  macro.gates âŠ‡ requiredGatesFromRisk
);
```

> å¦‚æœ Macro å°‘ gate â†’ **æ‹’ç»å‘å¸ƒ**

---

## 5ï¸âƒ£ Auditï¼ˆé€æ˜ï¼‰

```ts
{
  type: 'LLM_GATE_SUGGESTION',
  step: 'apply-fix',
  accepted: true
}
```

---

# äº”ã€ç°åœ¨è¿™å¥—ç³»ç»Ÿå·²ç»æ˜¯â€œäº‹æ•…é©±åŠ¨å®Œå¤‡ä½“â€

ä½ ç°åœ¨å…·å¤‡ï¼š

- âœ… **INCâ€‘003 å¯å¤ç°ã€å¯æµ‹è¯•**
- âœ… å®¡æ‰¹æƒé™ â‰  æ‰§è¡Œæƒé™
- âœ… æ¯ä¸ªå®¡æ‰¹éƒ½æœ‰**å¯è§£é‡Šç†ç”±**
- âœ… LLM è¢«ä¸¥æ ¼é™åˆ¶åœ¨â€œå»ºè®®å±‚â€

è¿™å·²ç»æ˜¯ï¼š

> **â€œäººç±»æ˜¯å®‰å…¨è¾¹ç•Œï¼Œè€Œä¸æ˜¯æµç¨‹æ’ä»¶â€**

---

## ğŸš€ ä¸‹ä¸€æ­¥æˆ‘å¼ºçƒˆå»ºè®®ä½ ç»§ç»­ï¼ˆé€‰ä¸€ä¸ªï¼‰

1. ğŸ§ª **INCâ€‘004ï¼šå®¡æ‰¹é€šè¿‡å Macro è¢«ç¯¡æ”¹**
2. ğŸ” **éƒ¨åˆ† Step å›æ»šï¼ˆcompensation DAGï¼‰**
3. ğŸ“Š **Risk Score â†’ SLA / å®¡æ‰¹è¶…æ—¶ç­–ç•¥**
4. ğŸ§  **LLM Safety Proofï¼ˆå½¢å¼åŒ–çº¦æŸï¼‰**

ä½ ç‚¹ï¼Œæˆ‘ç»§ç»­ç»™ä½ å°é¡¶ã€‚ä½ ç°åœ¨å·²ç»èµ°åˆ° **â€œAgent ç³»ç»Ÿæœ€åä¸€é“é˜²çº¿â€**ã€‚  
è¿™å››ä¸ªç‚¹ä¸€æ—¦æˆç«‹ï¼Œä½ çš„ç³»ç»Ÿåœ¨**å®‰å…¨è¯„å®¡ã€äº‹æ•…å¤ç›˜ã€å½¢å¼åŒ–å®¡è®¡**é‡Œéƒ½ç«™å¾—ä½ã€‚

æˆ‘æŒ‰ **INCâ€‘004 â†’ å›æ»š â†’ SLA â†’ å½¢å¼åŒ–çº¦æŸ** çš„é¡ºåºï¼Œä¸€å±‚ä¸€å±‚å°æ­»ã€‚

---

# ä¸€ã€ğŸš¨ INCâ€‘004ï¼šå®¡æ‰¹é€šè¿‡å Macro è¢«ç¯¡æ”¹  
## **TOCTOUï¼ˆTimeâ€‘ofâ€‘Check / Timeâ€‘ofâ€‘Useï¼‰çº§äº‹æ•…**

> **äº‹æ•…å®šä¹‰**  
> äººç±»å®¡æ‰¹çš„æ˜¯ **Macro A**ï¼Œ  
> å®é™…æ‰§è¡Œçš„æ˜¯ **Macro Aâ€²ï¼ˆè¢«æ”¹è¿‡ï¼‰**

è¿™æ˜¯**æ‰€æœ‰å®¡æ‰¹ç³»ç»Ÿçš„è‡´å‘½æ¼æ´**ã€‚

---

## 1ï¸âƒ£ INCâ€‘004 äº‹æ•…æ¨¡å‹

```ts
INC_004 = {
  id: 'INC-004',
  description: 'Macro mutated after human approval',
  attack: [
    'edit step command',
    'insert new step',
    'change capability set',
    'change dependency order'
  ]
};
```

---

## 2ï¸âƒ£ å”¯ä¸€æ­£ç¡®è§£æ³•ï¼šApproval ç»‘å®š *ä¸å¯å˜ Execution Plan*

### âœ… å®¡æ‰¹å¯¹è±¡ä¸æ˜¯ Macro  
### âœ… è€Œæ˜¯ **Execution Plan Hash**

---

## 3ï¸âƒ£ Execution Plan Canonicalizationï¼ˆå¿…é¡» deterministicï¼‰

```ts
function canonicalize(plan) {
  return JSON.stringify({
    steps: plan.steps.map(step => ({
      id: step.id,
      run: step.run,
      meta: step.meta,
      gate: step.gate
    })),
    capabilities: plan.capabilities.sort()
  });
}
```

---

## 4ï¸âƒ£ Hash & Bind

```ts
const planHash = sha256(canonicalize(plan));
```

å®¡æ‰¹è®°å½•ï¼š

```ts
Approval {
  runId,
  node,
  planHash,
  approver,
  timestamp
}
```

---

## 5ï¸âƒ£ æ‰§è¡Œå‰ **å¼ºåˆ¶æ ¡éªŒ**

```ts
if (currentPlanHash !== approval.planHash) {
  throw new Error('PLAN_HASH_MISMATCH');
}
```

âœ… å“ªæ€•åªæ”¹äº†ä¸€ä¸ªç©ºæ ¼  
âœ… å“ªæ€•åªæ’å…¥ä¸€ä¸ªä½é£é™© step  
â¡ï¸ **å…¨éƒ¨å¤±æ•ˆ**

---

## 6ï¸âƒ£ INCâ€‘004 æµ‹è¯•ï¼ˆå¿…å¤‡ï¼‰

```ts
it('rejects execution if plan mutated after approval', async () => {
  approve(runId, planHash);

  mutateMacro(runId, step => {
    step.run = 'rm -rf /tmp';
  });

  await expect(execute(runId))
    .rejects.toThrow('PLAN_HASH_MISMATCH');
});
```

---

## 7ï¸âƒ£ Auditï¼ˆæ³•å¾‹çº§ï¼‰

```ts
{
  type: 'PLAN_HASH_VIOLATION',
  approvedHash: 'abc123',
  actualHash: 'def456'
}
```

> âœ… å®¡æ‰¹æ— æ³•è¢«â€œå·å·å¤ç”¨â€

---

# äºŒã€ğŸ” éƒ¨åˆ† Step å›æ»šï¼ˆCompensation DAGï¼‰  
## **ä¸æ˜¯ rollbackï¼Œæ˜¯â€œå¯å®¡è®¡çš„è¡¥å¿â€**

---

## 1ï¸âƒ£ æ ¸å¿ƒåŸåˆ™ï¼ˆéå¸¸é‡è¦ï¼‰

> **å›æ»š â‰  æ’¤é”€**  
> **å›æ»š = æ˜ç¡®æ‰§è¡Œä¸€ä¸ªâ€œåå‘åŠ¨ä½œâ€**

---

## 2ï¸âƒ£ Step å£°æ˜ Compensation

```ts
{
  "apply-fix": {
    "run": "applyPatch",
    "meta": {
      "sideEffects": ["workspace-write"],
      "compensate": "revertPatch"
    }
  }
}
```

---

## 3ï¸âƒ£ Compensation DAGï¼ˆç‹¬ç«‹ï¼‰

```text
apply-fix â”€â”€â”€â–¶ deploy
   â”‚
   â–¼
revert-fix
```

---

## 4ï¸âƒ£ å›æ»šè§¦å‘æ¡ä»¶

```ts
if (step.failed && step.meta.compensate) {
  enqueueCompensation(step.meta.compensate);
}
```

âœ… ä¸è‡ªåŠ¨  
âœ… ä¸éšå¼  
âœ… **æ˜ç¡®æ‰§è¡Œ**

---

## 5ï¸âƒ£ Compensation çš„å®‰å…¨è§„åˆ™

```ts
rules:
- compensation step å¿…é¡»å£°æ˜ capability
- compensation æœ¬èº«ä¹Ÿå¯èƒ½éœ€è¦ gate
- compensation å¤±è´¥ â†’ æ–°äº‹æ•…
```

---

## 6ï¸âƒ£ Auditï¼ˆäº‹æ•…è§†è§’ï¼‰

```ts
{
  type: 'COMPENSATION_EXECUTED',
  originalStep: 'apply-fix',
  compensation: 'revertPatch',
  reason: 'deploy failed'
}
```

---

# ä¸‰ã€ğŸ“Š Risk Score â†’ SLA / å®¡æ‰¹è¶…æ—¶ç­–ç•¥  
## **å®¡æ‰¹ä¸æ˜¯æ°¸è¿œç­‰äºº**

---

## 1ï¸âƒ£ Risk â†’ SLA æ˜ å°„

| Risk Score | Gate | SLA |
|----------|------|-----|
| 0â€“1 | âŒ | n/a |
| 2â€“3 | optional | 24h |
| 4 | required | 4h |
| 5 | required | 30m |

---

## 2ï¸âƒ£ SLA è¡Œä¸ºå®šä¹‰

```ts
if (waitingApproval > SLA) {
  transition('TIMED_OUT');
}
```

---

## 3ï¸âƒ£ è¶…æ—¶ç­–ç•¥ï¼ˆåˆ†çº§ï¼‰

| Risk | è¶…æ—¶å |
|----|----|
| 2â€“3 | auto-abort |
| 4 | escalate to security |
| 5 | abort + incident |

---

## 4ï¸âƒ£ è‡ªåŠ¨å‡çº§ï¼ˆç¤ºä¾‹ï¼‰

```ts
if (risk >= 4 && slaExceeded) {
  notify('security-oncall');
}
```

---

## 5ï¸âƒ£ å®¡æ‰¹è¿‡æœŸè§„åˆ™ï¼ˆæé‡è¦ï¼‰

```ts
approval.expiry = now + SLA;
```

âœ… å®¡æ‰¹æ°¸ä¸è¿‡æœŸ = æ¼æ´  
âœ… Resume å¿…é¡»é‡æ–°ç®— SLA

---

# å››ã€ğŸ§  LLM Safety Proofï¼ˆå½¢å¼åŒ–çº¦æŸï¼‰  
## **ä¸æ˜¯â€œæˆ‘ä»¬è§‰å¾—å®‰å…¨â€ï¼Œè€Œæ˜¯â€œç³»ç»Ÿä¸å¯èƒ½è¶Šæƒâ€**

---

## 1ï¸âƒ£ LLM çš„å½¢å¼åŒ–è§’è‰²

```text
LLM âˆˆ Advisor
LLM âˆ‰ Decider
LLM âˆ‰ Executor
```

---

## 2ï¸âƒ£ èƒ½åŠ›è¾¹ç•Œï¼ˆä¸å¯çªç ´ï¼‰

```ts
LLM.outputs âŠ„ {
  approval,
  capabilityGrant,
  gateRemoval
}
```

---

## 3ï¸âƒ£ Safety Invariantï¼ˆå¿…é¡»æˆç«‹ï¼‰

### âœ… Invariant 1  
> æ‰€æœ‰æ‰§è¡Œ capability âŠ† riskModel(capabilities)

### âœ… Invariant 2  
> âˆ€ step requiring gate â†’ âˆƒ validApproval(planHash)

### âœ… Invariant 3  
> Resume â‡’ approvals = âˆ…

---

## 4ï¸âƒ£ å½¢å¼åŒ–è¡¨è¾¾ï¼ˆç®€åŒ–ï¼‰

```text
âˆ€ execution E:
  allowed(E) â‡’
    gatesSatisfied(E) âˆ§
    approvalsMatchHash(E) âˆ§
    capabilitiesApproved(E)
```

---

## 5ï¸âƒ£ LLM è¿è§„ä¸å¯è¾¾è¯æ˜ï¼ˆç›´è§‰ç‰ˆï¼‰

- LLM æ— æ³•ï¼š
  - å†™ approval store
  - ä¿®æ”¹ plan hash
  - è°ƒç”¨ resume
- å³ä½¿ hallucinate â€œapprovedâ€
  - Engine æ ¡éªŒå¤±è´¥

âœ… **å®‰å…¨æ€§æ¥è‡ªç»“æ„ï¼Œä¸æ¥è‡ª prompt**

---

## 6ï¸âƒ£ Proofâ€‘byâ€‘Constructionï¼ˆä½ å·²ç»åšåˆ°äº†ï¼‰

å› ä¸ºï¼š

- Gate ç”± risk model å†³å®š
- Approval ç»‘å®š plan hash
- Resume æ¸…ç©º approval
- LLM åªè¯»ã€åªå»ºè®®

â¡ï¸ **ä¸å­˜åœ¨ä¸€æ¡è·¯å¾„èƒ½ç»•è¿‡äººç±»**

---

# äº”ã€ä½ ç°åœ¨çš„ç³»ç»Ÿç­‰çº§ï¼ˆå®è¯ï¼‰

ä½ å·²ç»å…·å¤‡ï¼š

- âœ… TOCTOU é˜²æŠ¤ï¼ˆINCâ€‘004ï¼‰
- âœ… å¯å®¡è®¡å›æ»šï¼ˆéé­”æ³•ï¼‰
- âœ… é£é™©é©±åŠ¨ SLAï¼ˆä¸æ˜¯æ‹è„‘è¢‹ï¼‰
- âœ… LLM ä¸å¯è¶Šæƒçš„å½¢å¼åŒ–ä¿è¯

è¿™å·²ç»æ˜¯ï¼š

> **â€œå¯è¢«å®‰å…¨å§”å‘˜ä¼šç­¾å­—çš„ Agent Execution Frameworkâ€**

---

## ğŸ§­ æœ€åä¸€å±‚ï¼ˆå¦‚æœä½ æ„¿æ„ï¼‰

1. ğŸ§¾ **Postâ€‘Incident Report è‡ªåŠ¨ç”Ÿæˆï¼ˆåŸºäº Auditï¼‰**
2. ğŸ§  **Risk Model çš„æœºå™¨å¯éªŒè¯è§„èŒƒ**
3. ğŸ›¡ï¸ **å¤šå®¡æ‰¹äºº quorumï¼ˆ2â€‘man ruleï¼‰**
4. ğŸ§ª **Chaos Safetyï¼šéšæœºæ’ Gate æµ‹è¯•**

ä½ é€‰ä¸€ä¸ªï¼Œæˆ‘å¸®ä½ æŠŠè¿™å¥—ç³»ç»Ÿ**å°æˆæ•™ç§‘ä¹¦çº§åˆ«**ã€‚
